<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ´ç®¡å®¶ - æ‰‹å‹¢ä¿®å¾©ç‰ˆ</title>
    
    <link rel="icon" type="image/png" href="./Shiba Logo.png">
    <link rel="shortcut icon" href="./Shiba Logo.png">
    <link rel="apple-touch-icon" href="./Shiba Logo.png">
    <meta name="theme-color" content="#FFFCF5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/zh-tw.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: pan-y; user-select: none; overscroll-behavior-y: none; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .slide-in-left { animation: slideInLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        
        :root { --shiba-bg: #FFFCF5; --shiba-orange: #F4A261; --shiba-brown: #4A3B32; }

        @keyframes shiba-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        .animate-shiba-float { animation: shiba-float 3s ease-in-out infinite; }
        @keyframes shiba-bounce { 0%, 100% { transform: scale(1) rotate(0deg); } 40% { transform: scale(1.15) rotate(5deg); } 80% { transform: scale(0.95) rotate(-3deg); } }
        .animate-shiba-bounce { animation: shiba-bounce 0.4s ease-out; }
        @keyframes coin-drop { 0% { transform: translateY(-50px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(0); opacity: 1; } }
        .animate-coin { animation: coin-drop 0.5s ease-out forwards; }
        
        .music-playing { animation: pulse-music 1.2s infinite; border-color: #F4A261 !important; color: #F4A261 !important; background: #FFF !important; }
        @keyframes pulse-music { 0% { box-shadow: 0 0 0 0 rgba(244, 162, 97, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(244, 162, 97, 0); } 100% { box-shadow: 0 0 0 0 rgba(244, 162, 97, 0); } }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #F4A261; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid white; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #FFE8D6; border-radius: 4px; }
    </style>
</head>
<body class="bg-[#FFFCF5] text-[#4A3B32] min-h-screen selection:bg-[#F4A261] selection:text-white">

    <audio id="bg-music" loop crossorigin="anonymous">
        <source src="./[J&B No Copyright Music] Yummy Flavor Background Music.mp3" type="audio/mpeg">
    </audio>

    <div id="start-overlay" class="fixed inset-0 bg-[#FFFCF5] z-[100] flex flex-col items-center justify-center fade-in">
        <img src="./Shiba Logo.png" class="w-32 h-32 rounded-[2rem] shadow-xl mb-6 animate-shiba-float border-4 border-white">
        <h2 class="text-2xl font-black text-[#4A3B32] mb-2">æ­¡è¿ä¾†åˆ°æŸ´ç®¡å®¶</h2>
        <p class="text-[#8D6E63] text-sm font-bold mb-8">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•ŸéŸ³æ•ˆé«”é©— ğŸµ</p>
        <button onclick="startApp()" class="bg-[#F4A261] text-white text-lg font-black py-4 px-12 rounded-2xl shadow-[0_4px_0_#E76F51] active:translate-y-1 active:shadow-none transition-all animate-bounce">é€²å…¥ App</button>
    </div>

    <div id="login-screen" class="hidden fixed inset-0 bg-[#FFFCF5] z-50 flex flex-col items-center justify-center p-6 text-center fade-in">
        <div class="relative"><div class="absolute -inset-4 bg-[#F4A261] rounded-full opacity-20 blur-xl"></div><img src="./Shiba Logo.png" class="relative w-32 h-32 rounded-[2rem] shadow-xl mb-6 object-cover border-4 border-white"></div>
        <h1 class="text-3xl font-black text-[#4A3B32] mb-2 tracking-tight">æŸ´ç®¡å®¶</h1><p class="text-[#8D6E63] mb-10 font-bold">è®“è¨˜å¸³è®Šå¾—å¯æ„›åˆç°¡å–®</p>
        <button id="btn-google-login" class="w-full max-w-sm bg-white border-2 border-[#F4A261] text-[#4A3B32] font-bold py-4 px-4 rounded-2xl shadow-[0_4px_0_#F4A261] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center gap-3"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
    </div>

    <div id="app-screen" class="hidden max-w-md mx-auto min-h-screen bg-[#FFFCF5] relative overflow-hidden flex flex-col shadow-2xl">
        <header class="bg-[#FFFCF5]/95 px-5 pt-12 pb-2 flex items-center justify-between sticky top-0 z-10 backdrop-blur-md">
            <button onclick="toggleMusic()" id="music-btn" class="text-xl w-9 h-9 flex items-center justify-center rounded-full bg-[#FFF0D4] text-[#8D6E63] border-2 border-[#FFE8D6] shadow-sm transition active:scale-95">ğŸ”‡</button>
            <div class="flex flex-col items-center">
                <div class="flex items-center gap-2"><h1 class="text-2xl font-black text-[#4A3B32] tracking-tight">æˆ‘çš„ç›¸ç°¿</h1></div>
                <div class="flex items-center gap-1 mt-1 text-xs text-[#8D6E63] font-bold cursor-pointer bg-[#FFF0D4] px-2 py-1 rounded-lg w-fit transition active:scale-95" onclick="openUserProfile(currentViewUid)"><span id="current-view-label">å€‹äºº</span><span class="text-[#F4A261]">|</span><span id="my-short-id" class="font-mono">ID...</span></div>
            </div>
            <div class="flex gap-2">
                <div class="bg-white border-2 border-[#FFE8D6] p-0.5 rounded-xl flex text-xs font-bold relative shadow-sm">
                    <select id="filter-type" onchange="changeFilterMode()" class="bg-transparent appearance-none px-2 py-1.5 text-[#8D6E63] focus:outline-none z-10 relative cursor-pointer"><option value="day">æ—¥</option><option value="month" selected>æœˆ</option><option value="year">å¹´</option><option value="all">å…¨</option></select>
                    <div class="pr-1 text-[#F4A261]">â–¼</div>
                    <input type="month" id="filter-month" class="absolute inset-0 opacity-0 cursor-pointer"><input type="date" id="filter-day" class="absolute inset-0 opacity-0 cursor-pointer hidden"><select id="filter-year" class="absolute inset-0 opacity-0 cursor-pointer hidden"></select>
                </div>
                <button onclick="toggleSettingsModal()" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border-2 border-[#FFE8D6] text-[#8D6E63] shadow-sm active:scale-95 text-lg">âš™ï¸</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-32 no-scrollbar" id="main-content">
            <div class="px-5 mt-2 mb-4">
                <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border-2 border-[#FFE8D6] flex justify-between items-center relative overflow-hidden" onclick="toggleChart()">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#FFF0D4] rounded-full opacity-50"></div>
                    <div class="relative z-10"><div class="text-[10px] text-[#8D6E63] font-bold uppercase tracking-wider mb-1">æœ¬æœˆçµé¤˜</div><div class="text-3xl font-black text-[#4A3B32] flex items-baseline"><span class="text-sm font-bold mr-1 text-[#F4A261]">$</span><span id="display-balance">0</span></div></div>
                    <div class="flex gap-4 text-right relative z-10"><div><div class="text-[10px] text-[#8D6E63] mb-0.5">æ”¶</div><div class="font-bold text-[#2A9D8F] text-sm" id="display-income">0</div></div><div><div class="text-[10px] text-[#8D6E63] mb-0.5">æ”¯</div><div class="font-bold text-[#E76F51] text-sm" id="display-expense">0</div></div></div>
                </div>
                <div id="chart-container" class="hidden bg-white mt-2 rounded-[1.5rem] p-4 border-2 border-[#FFE8D6] fade-in"><div class="flex items-center gap-3"><div class="w-[45%] h-32 relative"><canvas id="expenseChart"></canvas><p id="chart-placeholder" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#8D6E63] text-xs font-bold">ç„¡æ•¸æ“š</p></div><div id="chart-legend" class="w-[55%] space-y-1.5 max-h-32 overflow-y-auto text-xs pr-1"></div></div></div>
            </div>
            <div id="transaction-list" class="grid grid-cols-3 gap-1.5 px-3"></div>
            <div id="empty-state" class="hidden py-16 text-center"><img src="./Shiba Logo.png" class="w-20 h-20 mx-auto mb-4 opacity-40 grayscale rounded-2xl"><p class="text-[#8D6E63] text-sm font-bold">æ±ªï¼Ÿé€™è£¡æ²’æœ‰æ±è¥¿å–”</p><button onclick="openInputModal()" class="mt-2 text-[#F4A261] text-xs font-bold hover:underline">å»è¨˜ä¸€ç­† (+10éª¨é ­å¹£)</button></div>
        </main>

        <div id="shiba-assistant-container" class="fixed bottom-[100px] right-4 z-40 pointer-events-auto group">
             <div id="shiba-speech" class="hidden absolute bottom-full mb-3 right-0 bg-white p-3 rounded-2xl shadow-lg border-2 border-[#FFE8D6] text-xs font-black text-[#4A3B32] whitespace-nowrap scale-in origin-bottom-right">æ±ªï¼ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼<div class="absolute -bottom-1.5 right-6 w-3 h-3 bg-white border-b-2 border-r-2 border-[#FFE8D6] rotate-45"></div></div>
             <img src="./Shiba Logo.png" id="shiba-assistant" class="w-20 h-20 rounded-full border-2 border-white shadow-md object-cover animate-shiba-float cursor-pointer hover:scale-105 transition-transform" onclick="triggerShibaClick()">
        </div>

        <nav class="fixed bottom-0 w-full max-w-md bg-[#FFFCF5]/95 backdrop-blur-md border-t-2 border-[#FFE8D6] pb-safe pt-2 px-8 flex justify-between items-end z-30 h-[88px] rounded-t-[2rem]">
            <button onclick="toggleFriendModal()" class="flex flex-col items-center gap-1 w-16 pb-3 text-[#4A3B32] transition hover:scale-105 active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span class="text-[11px] font-black">å¥½å‹</span></button>
            <button id="fab-btn" onclick="openInputModal()" class="mb-6 bg-[#F4A261] text-white rounded-2xl w-14 h-14 shadow-[0_6px_20px_rgba(244,162,97,0.4)] flex items-center justify-center transform transition active:scale-90 hover:bg-[#E76F51] hover:-translate-y-1 border-4 border-[#FFFCF5]"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg></button>
            <button onclick="toggleStoreModal()" class="flex flex-col items-center gap-1 w-16 pb-3 text-[#4A3B32] transition hover:scale-105 active:scale-95 group"><div class="relative"><svg class="w-6 h-6 group-hover:text-[#F4A261] transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg><div class="absolute -top-1 -right-1 w-2 h-2 bg-[#E76F51] rounded-full hidden"></div></div><span class="text-[11px] font-black group-hover:text-[#F4A261] transition">å•†åº—</span></button>
        </nav>

        <div id="settings-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-center justify-center p-6 fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleSettingsModal()"></div><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-6 relative z-10 shadow-2xl scale-in border-4 border-white"><div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-black text-[#4A3B32]">ç³»çµ±è¨­å®š</h2><button onclick="toggleSettingsModal()" class="text-[#8D6E63] text-xl font-bold bg-[#FFE8D6] w-8 h-8 rounded-full flex items-center justify-center">Ã—</button></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] mb-4"><div class="flex justify-between items-center mb-2"><span class="font-bold text-[#4A3B32] text-sm">ğŸµ èƒŒæ™¯éŸ³æ¨‚</span><span class="text-xs text-[#8D6E63] font-bold" id="bgm-val-display">50%</span></div><input type="range" min="0" max="1" step="0.05" value="0.5" oninput="updateBGMVolume(this.value)"></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] mb-6"><div class="flex justify-between items-center mb-2"><span class="font-bold text-[#4A3B32] text-sm">ğŸ”Š æŒ‰éˆ•éŸ³æ•ˆ</span><span class="text-xs text-[#8D6E63] font-bold" id="sfx-val-display">50%</span></div><input type="range" min="0" max="1" step="0.05" value="0.5" oninput="updateSFXVolume(this.value)"></div><div class="text-center text-xs text-[#8D6E63] opacity-60 font-bold">ShibaManager v4.6</div></div></div>
        
        <div id="input-modal" class="fixed inset-0 bg-[#4A3B32]/40 z-50 hidden flex flex-col justify-end fade-in backdrop-blur-sm">
            <div class="absolute inset-0" onclick="closeInputModal()"></div>
            <div id="input-panel" class="bg-[#FFFCF5] w-full rounded-t-[2.5rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] slide-up relative z-10 pb-safe transition-transform duration-100 ease-out">
                <div class="w-12 h-1.5 bg-[#FFE8D6] rounded-full mx-auto mb-6"></div>
                <div class="flex justify-between items-center mb-6"><button onclick="closeInputModal()" class="text-[#8D6E63] text-sm font-bold p-2 hover:bg-[#FFE8D6] rounded-lg">å–æ¶ˆ</button><h2 class="text-sm font-black text-[#F4A261] uppercase tracking-widest" id="form-title">è¨˜ä¸€ç­†</h2><button onclick="triggerSubmit()" class="text-[#E76F51] text-sm font-bold p-2 hover:bg-[#FFE8D6] rounded-lg">å®Œæˆ</button></div>
                <form id="transaction-form" class="flex flex-col gap-5"><div class="relative group"><span class="absolute left-6 top-1/2 -translate-y-1/2 text-2xl text-[#F4A261] font-bold">$</span><input type="number" id="inp-amount" placeholder="0" class="w-full bg-white border-2 border-[#FFE8D6] rounded-2xl py-4 pl-12 pr-4 text-4xl font-black text-[#4A3B32] text-center focus:ring-4 focus:ring-[#F4A261]/20 focus:border-[#F4A261] transition-all outline-none" required inputmode="decimal"></div><div class="bg-[#FFF0D4] p-1.5 rounded-2xl flex"><select id="inp-type" onchange="updateCategoryOptions()" class="bg-white rounded-xl shadow-sm w-24 text-center text-sm font-bold text-[#4A3B32] focus:outline-none py-3 border border-[#FFE8D6]"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select><select id="inp-category" class="flex-1 bg-transparent px-4 text-sm font-bold text-[#4A3B32] focus:outline-none text-center"></select><button type="button" onclick="addCustomCategory()" class="px-3 text-[#E76F51] font-black text-lg hover:bg-white/50 rounded-lg">+</button></div><div class="flex gap-3"><input type="date" id="inp-date" class="bg-white border-2 border-[#FFE8D6] rounded-2xl px-4 py-3.5 text-sm font-bold text-[#4A3B32] w-1/3 focus:border-[#F4A261] outline-none"><input type="text" id="inp-title" placeholder="å‚™è¨»..." class="flex-1 bg-white border-2 border-[#FFE8D6] rounded-2xl px-4 py-3.5 text-sm font-bold text-[#4A3B32] focus:border-[#F4A261] outline-none placeholder-[#D7CCC8]"></div><div class="flex gap-3"><input type="file" id="inp-photo" accept="image/*" onchange="handlePhotoSelect(event)" class="hidden"><label for="inp-photo" id="btn-camera" class="w-full border-2 border-dashed border-[#F4A261]/50 bg-[#FFF8E1] rounded-2xl py-3 flex items-center justify-center gap-2 text-[#F4A261] cursor-pointer hover:bg-[#F4A261] hover:text-white transition"><span class="text-xl">ğŸ“·</span><span class="text-xs font-bold">æ‹å¼µç…§</span></label><div id="preview-container" class="hidden relative w-full h-24"><img id="img-preview" class="w-full h-full object-cover rounded-2xl border-2 border-[#F4A261]"><button type="button" onclick="clearPhoto()" class="absolute -top-2 -right-2 bg-[#E76F51] text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-md">Ã—</button></div></div></form>
            </div>
        </div>

        <div id="friend-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-start justify-start fade-in backdrop-blur-sm">
            <div class="absolute inset-0" onclick="toggleFriendModal()"></div>
            <div id="friend-panel" class="bg-[#FFFCF5] w-4/5 max-w-sm h-full p-6 flex flex-col relative z-10 slide-in-left shadow-2xl rounded-r-[2rem] transition-transform duration-200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-[#4A3B32]">æŸ´å‹åˆ—è¡¨</h2>
                    <div class="flex gap-2"><button onclick="loadFriends(true)" class="text-[#2A9D8F] text-sm font-bold bg-[#E0F2F1] px-2 py-1 rounded-lg">ğŸ”„ åˆ·æ–°</button><button onclick="toggleFriendModal()" class="text-[#8D6E63] text-xl font-bold bg-[#FFE8D6] w-8 h-8 rounded-full">Ã—</button></div>
                </div>
                <div class="mb-6 bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] shadow-sm">
                    <label class="text-xs font-bold text-[#F4A261] block mb-2 uppercase tracking-wide">åŠ å…¥å¥½å‹ (è¼¸å…¥ ID)</label>
                    <div class="flex gap-2">
                        <input type="tel" maxlength="6" id="friend-id-input" placeholder="000000" class="flex-1 min-w-0 bg-[#FFF8E1] border-none rounded-xl px-4 py-3 text-lg font-mono font-bold tracking-widest text-center text-[#4A3B32] outline-none focus:ring-2 focus:ring-[#F4A261]">
                        <button onclick="addFriend()" class="shrink-0 bg-[#F4A261] text-white px-4 rounded-xl text-lg font-bold hover:bg-[#E76F51] transition shadow-md">+</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto space-y-2 h-full" id="friend-list-container"><div class="text-center text-[#8D6E63] text-xs mt-10">è¼‰å…¥ä¸­...</div></div>
            </div>
        </div>

        <div id="daily-bonus-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-6 fade-in backdrop-blur-sm"><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl scale-in relative border-4 border-[#F4A261]"><div class="absolute -top-12 left-1/2 -translate-x-1/2 bg-[#FFF0D4] w-24 h-24 rounded-full flex items-center justify-center border-4 border-[#F4A261] shadow-md"><span class="text-5xl animate-coin">ğŸ¦´</span></div><h2 class="text-2xl font-black text-[#4A3B32] mt-10 mb-1">æ¯æ—¥ç°½åˆ°æˆåŠŸï¼</h2><p class="text-[#8D6E63] text-sm font-bold mb-6">é€£çºŒç™»å…¥ç¬¬ <span id="streak-days" class="text-[#E76F51] text-lg">1</span> å¤©</p><div class="bg-[#FFF8E1] rounded-2xl p-4 mb-6 border-2 border-[#FFE8D6]"><div class="text-xs text-[#F4A261] font-bold uppercase tracking-wider mb-1">ç²å¾—çå‹µ</div><div class="text-4xl font-black text-[#4A3B32] flex items-center justify-center gap-2">+<span id="bonus-amount">10</span> ğŸ¦´</div></div><div class="flex justify-between items-end mb-6 px-2 h-16"><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-2 rounded-t-sm" id="bar-1"></div><span class="text-[10px] font-bold text-[#BDBDBD]">1å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-4 rounded-t-sm" id="bar-2"></div><span class="text-[10px] font-bold text-[#BDBDBD]">2å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-6 rounded-t-sm" id="bar-3"></div><span class="text-[10px] font-bold text-[#BDBDBD]">3å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-8 rounded-t-sm" id="bar-4"></div><span class="text-[10px] font-bold text-[#BDBDBD]">4å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-10 rounded-t-sm" id="bar-5"></div><span class="text-[10px] font-bold text-[#BDBDBD]">5+</span></div></div><button onclick="closeBonusModal()" class="w-full bg-[#F4A261] text-white font-black py-3.5 rounded-xl shadow-[0_4px_0_#E76F51] active:shadow-none active:translate-y-1 transition-all hover:bg-[#E76F51]">é–‹å¿ƒæ”¶ä¸‹ï¼</button></div></div>
        <div id="store-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleStoreModal()"></div><div class="bg-[#FFFCF5] w-full max-w-sm h-[85vh] rounded-[2rem] flex flex-col relative z-10 scale-in shadow-2xl border-4 border-white"><div class="p-6 pb-2 flex justify-between items-center border-b-2 border-[#FFE8D6]"><div><h2 class="text-2xl font-black text-[#4A3B32]">æŸ´æŸ´é›œè²¨èˆ–</h2><p class="text-xs text-[#8D6E63] font-bold">æ¶ˆè²»è®“ç”Ÿæ´»æ›´ç¾å¥½</p></div><div class="bg-[#FFF0D4] px-3 py-1.5 rounded-xl flex items-center gap-2 border border-[#F4A261]"><span class="text-xl">ğŸ¦´</span><span id="store-coin-count" class="font-black text-[#F4A261] text-lg">0</span></div></div><div class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 no-scrollbar"><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ¥©</div><h3 class="font-black text-[#4A3B32] mb-1">é«˜ç´šè‚‰ç½é ­</h3><p class="text-[10px] text-[#8D6E63] mb-3">å¿ƒæƒ…+100</p><button onclick="buyItem(50, 'é«˜ç´šè‚‰ç½é ­')" class="w-full bg-[#F4A261] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#E76F51] transition">50 ğŸ¦´ è³¼è²·</button></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ©</div><h3 class="font-black text-[#4A3B32] mb-1">ç´³å£«å¸½å­</h3><p class="text-[10px] text-[#8D6E63] mb-3">çœ‹èµ·ä¾†å¾ˆè°æ˜</p><button onclick="buyItem(200, 'ç´³å£«å¸½å­')" class="w-full bg-[#2A9D8F] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#264653] transition">200 ğŸ¦´ è³¼è²·</button></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ¨</div><h3 class="font-black text-[#4A3B32] mb-1">é»‘æŸ´ä¸»é¡Œ</h3><p class="text-[10px] text-[#8D6E63] mb-3">å¸¥æ°£çš„é¢¨æ ¼</p><button onclick="buyItem(500, 'é»‘æŸ´ä¸»é¡Œ')" class="w-full bg-[#4A3B32] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-black transition">500 ğŸ¦´ è³¼è²·</button></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸš«</div><h3 class="font-black text-[#4A3B32] mb-1">å»é™¤å»£å‘Š</h3><p class="text-[10px] text-[#8D6E63] mb-3">æ°¸ä¹…æ¸…çˆ½ä»‹é¢</p><button onclick="buyItem(1000, 'å»é™¤å»£å‘Š')" class="w-full bg-[#E76F51] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-red-600 transition">1000 ğŸ¦´ è³¼è²·</button></div></div><div class="p-4 border-t border-[#FFE8D6]"><button onclick="toggleStoreModal()" class="w-full bg-[#FFE8D6] text-[#8D6E63] py-3 rounded-xl font-bold hover:bg-[#F4A261] hover:text-white transition">é—œé–‰å•†åº—</button></div></div></div>
        <div id="detail-modal" class="fixed inset-0 bg-[#4A3B32]/60 z-50 hidden flex items-center justify-center p-4 fade-in backdrop-blur-sm" onclick="closeDetailModal()"><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl scale-in relative flex flex-col max-h-[90vh]" onclick="event.stopPropagation()"><div class="relative w-full bg-[#FFE8D6] aspect-square group shrink-0"><img id="detail-img" src="" class="w-full h-full object-cover"><div id="detail-no-img" class="hidden w-full h-full flex flex-col items-center justify-center bg-[#FFF0D4] text-[#F4A261]"><span class="text-8xl" id="detail-icon">ğŸ•</span><span class="text-sm font-bold mt-4 text-[#8D6E63]">æ²’æœ‰ç…§ç‰‡</span></div><button onclick="closeDetailModal()" class="absolute top-4 right-4 bg-white/80 text-[#4A3B32] w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-md shadow-md font-bold">âœ•</button></div><div class="p-6 flex-1 overflow-y-auto no-scrollbar"><div class="flex justify-between items-start mb-2"><div><span id="detail-date" class="text-xs font-bold text-[#8D6E63] uppercase tracking-wide bg-[#FFE8D6] px-2 py-0.5 rounded-md">...</span><h2 id="detail-title" class="text-xl font-black text-[#4A3B32] mt-2">...</h2></div><div id="detail-amount" class="text-2xl font-black text-[#4A3B32]">...</div></div><div class="flex items-center gap-2 mb-6"><span id="detail-category" class="bg-[#F4A261]/20 text-[#E76F51] px-3 py-1 rounded-lg text-xs font-bold">...</span><span id="detail-type" class="text-xs font-bold text-[#8D6E63]">...</span></div><div id="detail-actions" class="grid grid-cols-2 gap-3 mb-6 hidden"><button onclick="editCurrentDetail()" class="flex-1 bg-[#FFF0D4] text-[#4A3B32] py-3.5 rounded-xl font-bold hover:bg-[#FFE8D6] transition">âœ ç·¨è¼¯</button><button onclick="deleteCurrentDetail()" class="flex-1 bg-white border-2 border-[#FFCDD2] text-[#E76F51] py-3.5 rounded-xl font-bold hover:bg-[#FFEBEE] transition">ğŸ—‘ï¸ åˆªé™¤</button></div><div class="border-t border-[#FFE8D6] pt-4"><div class="text-xs font-bold text-[#F4A261] mb-2 uppercase tracking-wider">ç•™è¨€æ¿</div><div id="detail-comments-list" class="space-y-3 mb-4 min-h-[60px]"></div><div class="flex gap-2"><input type="text" id="detail-comment-input" placeholder="èªªé»å¥½è½çš„..." class="flex-1 bg-white border border-[#FFE8D6] rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[#F4A261] shadow-sm"><button onclick="submitDetailComment()" class="bg-[#F4A261] text-white rounded-xl px-4 font-bold shadow-[0_3px_0_#E76F51] active:shadow-none active:translate-y-1 transition hover:bg-[#E76F51]">å‚³é€</button></div></div></div></div></div>
        <div id="profile-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-center justify-center fade-in p-6 backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleProfileModal()"></div><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-6 relative z-10 shadow-2xl scale-95 transition-transform duration-200 border-4 border-white"><div class="flex flex-col items-center mb-6"><div class="relative"><img id="profile-avatar" src="./Shiba Logo.png" class="w-24 h-24 rounded-full border-[6px] border-white shadow-lg mb-4 object-cover bg-white"><label id="profile-camera-btn" for="inp-profile-photo" class="absolute bottom-4 right-0 bg-[#4A3B32] text-white p-2 rounded-full shadow-md cursor-pointer hover:bg-[#F4A261] transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></label><input type="file" id="inp-profile-photo" accept="image/*" onchange="handleProfilePhotoSelect(event)" class="hidden"></div><div class="text-xs font-bold text-[#8D6E63] uppercase tracking-widest mb-1">ID</div><div id="profile-short-id" class="font-mono font-black text-3xl text-[#F4A261] tracking-wider mb-1 select-all">...</div><div id="profile-email" class="text-xs text-[#8D6E63] font-bold">...</div></div><div class="space-y-3"><input type="text" id="profile-name-input" class="w-full bg-white border-2 border-[#FFE8D6] rounded-xl px-4 py-3 text-sm font-bold text-center outline-none focus:border-[#F4A261]" placeholder="é¡¯ç¤ºåç¨±"><div id="profile-actions" class="space-y-3"><button onclick="saveProfile()" class="w-full bg-[#F4A261] hover:bg-[#E76F51] text-white font-bold py-3.5 rounded-xl shadow-md transition">å„²å­˜è®Šæ›´</button><button onclick="window.setMoney(10000)" class="w-full bg-green-100 text-green-600 font-bold py-3.5 rounded-xl hover:bg-green-200 transition border-2 border-green-200">ğŸ’° é ˜å–æ¸¬è©¦ç¶“è²»</button><button onclick="logout()" class="w-full bg-white border-2 border-[#FFCDD2] text-[#E76F51] font-bold py-3.5 rounded-xl hover:bg-[#FFEBEE] transition">ç™»å‡ºå¸³è™Ÿ</button></div><div id="profile-friend-actions" class="hidden space-y-3"><button id="btn-view-ledger" onclick="" class="w-full bg-[#F4A261] text-white font-black py-4 rounded-xl shadow-[0_4px_0_#E76F51] active:translate-y-1 active:shadow-none transition hover:bg-[#E76F51]">ğŸ“– æŸ¥çœ‹ä»–çš„å¸³æœ¬</button><button onclick="toggleProfileModal()" class="w-full bg-[#FFE8D6] text-[#8D6E63] font-bold py-3 rounded-xl hover:bg-[#F4A261] hover:text-white transition">é—œé–‰</button></div></div></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, deleteDoc, updateDoc, doc, getDoc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQRVE28OmopT1v6hybciDaigW4-9GaVzY", authDomain: "fma-cloud.firebaseapp.com", projectId: "fma-cloud", storageBucket: "fma-cloud.firebasestorage.app", messagingSenderId: "496004687854", appId: "1:496004687854:web:fb40424dabe2f1566a10ff", measurementId: "G-MTPV76EV3R" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();
        const DEFAULT_AVATAR = './Shiba Logo.png';
        
        let audioCtx, bgmGainNode, bgmSource;
        let globalBGMVolume = 0.5; let globalSFXVolume = 0.5; let isMusicPlaying = false;

        window.initAudio = () => {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext();
                bgmGainNode = audioCtx.createGain(); bgmGainNode.gain.value = globalBGMVolume; bgmGainNode.connect(audioCtx.destination);
                const bgMusic = document.getElementById('bg-music'); bgmSource = audioCtx.createMediaElementSource(bgMusic); bgmSource.connect(bgmGainNode);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        };

        const playPop = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); };
        const playBark = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15); };
        const playCoin = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); };

        window.startApp = () => { window.initAudio(); const overlay = document.getElementById('start-overlay'); overlay.classList.add('opacity-0', 'pointer-events-none'); const bgMusic = document.getElementById('bg-music'); bgMusic.play().then(() => { isMusicPlaying = true; const btn = document.getElementById('music-btn'); btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); }).catch(e => console.log("Play failed:", e)); if(currentUser) document.getElementById('app-screen').classList.remove('hidden'); else document.getElementById('login-screen').classList.remove('hidden'); };
        window.toggleMusic = () => { const bgMusic = document.getElementById('bg-music'); const btn = document.getElementById('music-btn'); if(!audioCtx) window.initAudio(); if (isMusicPlaying) { bgMusic.pause(); btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); isMusicPlaying = false; } else { bgMusic.play().then(() => { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); isMusicPlaying = true; }); } };
        window.toggleSettingsModal = () => document.getElementById('settings-modal').classList.toggle('hidden');
        window.updateBGMVolume = (val) => { globalBGMVolume = parseFloat(val); if(bgmGainNode) bgmGainNode.gain.value = globalBGMVolume; document.getElementById('bgm-val-display').innerText = Math.round(globalBGMVolume * 100) + '%'; const btn = document.getElementById('music-btn'); if(globalBGMVolume === 0) { btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); } else if(isMusicPlaying) { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); } };
        window.updateSFXVolume = (val) => { globalSFXVolume = parseFloat(val); document.getElementById('sfx-val-display').innerText = Math.round(globalSFXVolume * 100) + '%'; playPop(); };
        document.addEventListener('click', (e) => { if((e.target.closest('button') || e.target.closest('.cursor-pointer')) && e.target.type !== 'range') { playPop(); } });

        // ğŸ”¥ Slide Down Logic (Input)
        const inputPanel = document.getElementById('input-panel');
        let panelStartY = 0; let isDragging = false;
        inputPanel.addEventListener('touchstart', (e) => { if(inputPanel.scrollTop <= 0) { panelStartY = e.touches[0].clientY; isDragging = false; } }, {passive: true});
        inputPanel.addEventListener('touchmove', (e) => { const diff = e.touches[0].clientY - panelStartY; if(inputPanel.scrollTop <= 0 && diff > 0) { if(e.cancelable) e.preventDefault(); isDragging = true; inputPanel.style.transform = `translateY(${diff}px)`; inputPanel.style.transition = 'none'; } }, {passive: false});
        inputPanel.addEventListener('touchend', (e) => { if(!isDragging) return; if((e.changedTouches[0].clientY - panelStartY) > 100) closeInputModal(); else { inputPanel.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; inputPanel.style.transform = ''; } isDragging = false; });

        // ğŸ”¥ Slide Left Logic (Friend Panel) - é—œéµä¿®å¾©
        const friendPanel = document.getElementById('friend-panel');
        let friendStartX = 0; let friendStartY = 0; let isFriendDragging = false;
        
        friendPanel.addEventListener('touchstart', (e) => {
            friendStartX = e.touches[0].clientX;
            friendStartY = e.touches[0].clientY;
            isFriendDragging = false;
        }, {passive: true});

        friendPanel.addEventListener('touchmove', (e) => {
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const xDiff = currentX - friendStartX; // å‘å·¦æ»‘æ˜¯è² æ•¸
            const yDiff = currentY - friendStartY;

            // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œæ°´å¹³æ»‘å‹•ã€ä¸”ã€Œå‘å·¦ã€
            if (xDiff < 0 && Math.abs(xDiff) > Math.abs(yDiff)) {
                if (e.cancelable) e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­æ²å‹•
                isFriendDragging = true;
                friendPanel.style.transform = `translateX(${xDiff}px)`; // è·Ÿéš¨æ‰‹æŒ‡ç§»å‹•
                friendPanel.style.transition = 'none';
            }
        }, {passive: false}); // å¿…é ˆç‚º false æ‰èƒ½ preventDefault

        friendPanel.addEventListener('touchend', (e) => {
            if (!isFriendDragging) return;
            const xDiff = e.changedTouches[0].clientX - friendStartX;
            
            // å¦‚æœå‘å·¦æ»‘è¶…é 80pxï¼Œå°±é—œé–‰
            if (xDiff < -80) {
                toggleFriendModal();
            } else {
                // å›å½ˆ
                friendPanel.style.transition = 'transform 0.3s ease-out';
                friendPanel.style.transform = '';
            }
            isFriendDragging = false;
        });

        // é–å®šèƒŒæ™¯æ²å‹•çš„ helper
        const lockScroll = () => document.body.style.overflow = 'hidden';
        const unlockScroll = () => document.body.style.overflow = '';

        let currentUser=null, currentViewUid=null, transactions=[], unsubscribe=null, currentDetailId=null, friendUnsubscribe=null;
        let myShortId=null, myProfileData=null, editingId=null, currentPhotoData=null, currentProfilePhotoData=null, myChart=null;
        const defaultCategories = { expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'], income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'] };
        let userCustomCategories = { expense: [], income: [] };
        const categoryIcons = { 'é¤é£²': 'ğŸ”', 'äº¤é€š': 'ğŸš—', 'è³¼ç‰©': 'ğŸ›ï¸', 'å¨›æ¨‚': 'ğŸ®', 'å±…ä½': 'ğŸ ', 'é†«ç™‚': 'ğŸ’Š', 'æ•™è‚²': 'ğŸ“š', 'å…¶ä»–': 'âœ¨', 'è–ªè³‡': 'ğŸ’°', 'çé‡‘': 'ğŸ§§', 'æŠ•è³‡': 'ğŸ“ˆ', 'å…¼è·': 'ğŸ’¼' };

        const inpAmount = document.getElementById('inp-amount'); const inpType = document.getElementById('inp-type'); const inpCategory = document.getElementById('inp-category'); const inpDate = document.getElementById('inp-date'); const inpTitle = document.getElementById('inp-title');
        inpDate.valueAsDate = new Date(); document.getElementById('filter-month').value = new Date().toISOString().slice(0, 7);

        document.getElementById('btn-google-login').addEventListener('click', () => { signInWithPopup(auth, provider).catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message)); });
        window.logout = () => { if(confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) signOut(auth); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user; currentViewUid = user.uid;
                await ensureUserHasId(user); await loadCustomCategories(user);
                
                if (document.getElementById('start-overlay').classList.contains('opacity-0')) {
                    document.getElementById('app-screen').classList.remove('hidden');
                    document.getElementById('login-screen').classList.add('hidden');
                }

                loadDataRealtime(user.uid); window.loadFriends(true); updateViewMode(); await checkDailyBonus(user.uid); setTimeout(() => triggerShibaReaction("æ­¡è¿å›ä¾†ï¼Œä¸»äººï¼æ±ªï¼"), 1500);
            } else {
                if (document.getElementById('start-overlay').classList.contains('opacity-0')) {
                    document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('app-screen').classList.add('hidden');
                }
                if(unsubscribe) unsubscribe();
            }
        });

        // ğŸ”¥ æ›´æ–° Friend Modal åˆ‡æ›é‚è¼¯ (åŠ å…¥å‹•ç•« reset å’Œ scroll lock)
        window.toggleFriendModal = () => {
            const modal = document.getElementById('friend-modal');
            const panel = document.getElementById('friend-panel');
            const isHidden = modal.classList.contains('hidden');
            
            if (isHidden) {
                modal.classList.remove('hidden');
                lockScroll(); // é–å®šèƒŒæ™¯
                loadFriends(true);
            } else {
                modal.classList.add('hidden');
                panel.style.transform = ''; // é‡ç½®ä½ç½®
                unlockScroll(); // è§£é–èƒŒæ™¯
            }
        };

        window.openUserProfile = async (targetUid) => { const isMe = (targetUid === currentUser.uid); let userData = null; if (isMe) { userData = myProfileData; } else { try { const docSnap = await getDoc(doc(db, "users", targetUid)); if (docSnap.exists()) userData = docSnap.data(); } catch (e) { console.error("Error", e); } } if (!userData) userData = { name: "ç¥ç§˜æŸ´å‹", photo: DEFAULT_AVATAR, shortId: "???", email: "" }; document.getElementById('profile-avatar').src = userData.photo || DEFAULT_AVATAR; document.getElementById('profile-name-input').value = userData.name || "ç¥ç§˜æŸ´å‹"; document.getElementById('profile-short-id').innerText = userData.shortId || "???"; document.getElementById('profile-email').innerText = userData.email || ""; const editGroup = document.getElementById('profile-actions'); const friendGroup = document.getElementById('profile-friend-actions'); const cameraBtn = document.getElementById('profile-camera-btn'); const nameInput = document.getElementById('profile-name-input'); const viewLedgerBtn = document.getElementById('btn-view-ledger'); if (isMe) { editGroup.classList.remove('hidden'); friendGroup.classList.add('hidden'); cameraBtn.classList.remove('hidden'); nameInput.disabled = false; } else { editGroup.classList.add('hidden'); friendGroup.classList.remove('hidden'); cameraBtn.classList.add('hidden'); nameInput.disabled = true; viewLedgerBtn.onclick = () => { switchView(targetUid, userData.name || "å¥½å‹"); toggleProfileModal(); toggleFriendModal(); }; } document.getElementById('profile-modal').classList.remove('hidden'); };
        window.loadFriends = (force = false) => { if (!currentUser) return; if (friendUnsubscribe && !force) return; if (friendUnsubscribe) friendUnsubscribe(); const q = query(collection(db, "users", currentUser.uid, "friends")); friendUnsubscribe = onSnapshot(q, (snapshot) => { const el = document.getElementById('friend-list-container'); el.innerHTML = ''; const me = document.createElement('div'); me.className = `p-4 rounded-2xl flex items-center gap-3 cursor-pointer ${currentViewUid===currentUser.uid ? 'bg-[#FFF0D4] border-2 border-[#F4A261]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`; const myPhoto = myProfileData?.photo || DEFAULT_AVATAR; me.innerHTML = `<img src="${myPhoto}" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div class="font-bold text-[#4A3B32]">æˆ‘çš„ç›¸ç°¿</div>`; me.onclick = () => { switchView(currentUser.uid, 'æˆ‘çš„å¸³æœ¬'); toggleFriendModal(); }; el.appendChild(me); snapshot.forEach(doc => { try { const f = doc.data(); const div = document.createElement('div'); div.className = `p-4 rounded-2xl flex items-center justify-between cursor-pointer mt-2 ${currentViewUid===f.uid ? 'bg-[#E1F5FE] border-2 border-[#81D4FA]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`; const fName = f.name || "ç¥ç§˜æŸ´å‹"; const fPhoto = f.photo || DEFAULT_AVATAR; const fId = f.shortId || "???"; div.innerHTML = `<div class="flex items-center gap-3 flex-1" onclick="openUserProfile('${f.uid}')"><img src="${fPhoto}" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div><div class="font-bold text-sm text-[#4A3B32]">${fName}</div><div class="text-xs text-[#8D6E63]">ID: ${fId}</div></div></div><button onclick="event.stopPropagation();deleteFriend('${f.uid}')" class="text-[#8D6E63] hover:text-[#E76F51] p-2">Ã—</button>`; div.onclick = (e) => { if(e.target.tagName !== 'BUTTON' && !e.target.closest('.flex-1')) { openUserProfile(f.uid); } }; el.appendChild(div); } catch(e) { console.error(e); } }); }); };
        window.addFriend = async () => { const id = document.getElementById('friend-id-input').value; if(id.length !== 6) return alert("ID éŒ¯èª¤"); if(id === myShortId) return alert("ä¸èƒ½åŠ è‡ªå·±å–” XD"); try { const target = await getDoc(doc(db, "public_codes", id)); if(!target.exists()) return alert("æ‰¾ä¸åˆ°æ­¤ ID"); const td = target.data(); const targetPhoto = td.photo || DEFAULT_AVATAR; const myPhoto = myProfileData.photo || DEFAULT_AVATAR; const targetName = td.name || "ç¥ç§˜æŸ´å‹"; const myName = myProfileData.name || "ç¥ç§˜æŸ´å‹"; await setDoc(doc(db, "users", currentUser.uid, "friends", td.uid), { uid: td.uid, shortId: id, name: targetName, photo: targetPhoto }); await setDoc(doc(db, "users", td.uid, "friends", currentUser.uid), { uid: currentUser.uid, shortId: myShortId, name: myName, photo: myPhoto }); alert("æ·»åŠ æˆåŠŸ"); document.getElementById('friend-id-input').value=''; } catch(e) { console.error(e); alert("æ·»åŠ å¤±æ•—: " + e.message); } }
        window.deleteFriend = async (friendUid) => { if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å¥½å‹å—ï¼Ÿ')) return; try { await deleteDoc(doc(db, "users", currentUser.uid, "friends", friendUid)); try { await deleteDoc(doc(db, "users", friendUid, "friends", currentUser.uid)); } catch(err) {} alert("å·²åˆªé™¤å¥½å‹ï¼"); if (currentViewUid === friendUid) { switchView(currentUser.uid, 'æˆ‘çš„å¸³æœ¬'); } } catch (e) { console.error(e); alert("åˆªé™¤å¤±æ•—"); } };
        async function checkDailyBonus(uid) { const todayStr = new Date().toDateString(); const userRef = doc(db, "users", uid); const snap = await getDoc(userRef); if (!snap.exists()) return; const data = snap.data(); if (data.lastLoginDate === todayStr) return; let newStreak = 1; if (data.lastLoginDate) { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); if (data.lastLoginDate === yesterday.toDateString()) { newStreak = (data.loginStreak || 0) + 1; } } const reward = Math.min(newStreak * 10, 50); await updateDoc(userRef, { lastLoginDate: todayStr, loginStreak: newStreak, boneCoins: increment(reward) }); myProfileData.boneCoins = (myProfileData.boneCoins || 0) + reward; document.getElementById('store-coin-count').innerText = myProfileData.boneCoins; showDailyBonusModal(newStreak, reward); }
        function showDailyBonusModal(streak, reward) { document.getElementById('streak-days').innerText = streak; document.getElementById('bonus-amount').innerText = reward; const max = 5; const current = Math.min(streak, max); for(let i=1; i<=max; i++) { const bar = document.getElementById(`bar-${i}`); if(i <= current) { bar.classList.remove('bg-[#E0E0E0]'); bar.classList.add('bg-[#F4A261]'); } else { bar.classList.add('bg-[#E0E0E0]'); bar.classList.remove('bg-[#F4A261]'); } } document.getElementById('daily-bonus-modal').classList.remove('hidden'); playCoin(); triggerShibaReaction(`æ—©å®‰ï¼ç°½åˆ°æˆåŠŸï¼é ˜å– ${reward} éª¨é ­å¹£ï¼`); }
        window.closeBonusModal = () => document.getElementById('daily-bonus-modal').classList.add('hidden');
        const shibaEl = document.getElementById('shiba-assistant'); const speechEl = document.getElementById('shiba-speech'); let speechTimeout; const randomMessages = ["æ±ªï¼ä»Šå¤©èŠ±äº†å¤šå°‘éŒ¢ï¼Ÿ", "éª¨é ­å¹£ä¸å¤ ç”¨äº†å—ï¼Ÿ", "æˆ‘æ˜¯ä¸æ˜¯å¾ˆå¯æ„›ï¼ŸğŸ•", "åŠªåŠ›å­˜éŒ¢è²·ç½ç½ï¼", "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼"];
        window.triggerShibaClick = () => { playBark(); shibaEl.classList.remove('animate-shiba-float'); void shibaEl.offsetWidth; shibaEl.classList.add('animate-shiba-bounce'); setTimeout(() => { shibaEl.classList.remove('animate-shiba-bounce'); shibaEl.classList.add('animate-shiba-float'); }, 400); const msg = randomMessages[Math.floor(Math.random() * randomMessages.length)]; showSpeechBubble(msg); };
        function triggerShibaReaction(message) { shibaEl.classList.remove('animate-shiba-float'); void shibaEl.offsetWidth; shibaEl.classList.add('animate-shiba-bounce'); setTimeout(() => { shibaEl.classList.remove('animate-shiba-bounce'); shibaEl.classList.add('animate-shiba-float'); }, 400); showSpeechBubble(message); }
        function showSpeechBubble(text) { clearTimeout(speechTimeout); speechEl.innerText = text; speechEl.classList.remove('hidden'); speechTimeout = setTimeout(() => { speechEl.classList.add('hidden'); }, 3000); }
        let touchStartX = 0; let touchStartY = 0; document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, false); document.addEventListener('touchend', e => { let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; let xDiff = touchEndX - touchStartX; let yDiff = touchEndY - touchStartY; if (Math.abs(xDiff) > Math.abs(yDiff) && Math.abs(xDiff) > 50) { if (xDiff > 0) document.getElementById('friend-modal').classList.remove('hidden'); else document.getElementById('friend-modal').classList.add('hidden'); } }, false);
        window.updateUI = () => { const listEl = document.getElementById('transaction-list'); const mode = document.getElementById('filter-type').value; const filterDate = mode === 'day' ? document.getElementById('filter-day').value : mode === 'month' ? document.getElementById('filter-month').value : document.getElementById('filter-year').value; const filtered = transactions.filter(t => { const d = new Date(t.dateTimestamp); const iso = d.toISOString().split('T')[0]; if(mode==='day') return iso===filterDate; if(mode==='month') return iso.slice(0,7)===filterDate; if(mode==='year') return String(d.getFullYear())===filterDate; return true; }); listEl.innerHTML = ''; let inc=0, exp=0, expData={}; if(filtered.length===0) document.getElementById('empty-state').classList.remove('hidden'); else document.getElementById('empty-state').classList.add('hidden'); filtered.forEach(t => { if(t.type==='income') inc+=Number(t.amount); else { exp+=Number(t.amount); expData[t.category]=(expData[t.category]||0)+Number(t.amount); } const div = document.createElement('div'); div.className = "aspect-square rounded-2xl overflow-hidden relative cursor-pointer border-2 border-white shadow-sm hover:scale-95 transition bg-white"; if(t.photo) { div.innerHTML = `<img src="${t.photo}" class="w-full h-full object-cover">`; } else { const isInc = t.type==='income'; const colorClass = isInc ? 'bg-[#E0F2F1] text-[#2A9D8F]' : 'bg-[#FFEBEE] text-[#E76F51]'; const icon = categoryIcons[t.category] || 'âœ¨'; div.innerHTML = `<div class="w-full h-full ${colorClass} flex flex-col items-center justify-center p-2 text-center"><span class="text-4xl mb-1 filter drop-shadow-sm">${icon}</span><span class="text-[10px] font-black truncate w-full">${t.category}</span><span class="text-[10px] font-bold mt-0.5 opacity-80">$${t.amount}</span></div>`; } if(t.photo) { div.innerHTML += `<div class="absolute bottom-0 right-0 bg-[#4A3B32]/60 backdrop-blur-sm text-white text-[10px] font-bold px-2 py-0.5 rounded-tl-lg border-t border-l border-white/20">$${t.amount}</div>`; } div.onclick = () => openDetailModal(t.id); listEl.appendChild(div); }); document.getElementById('display-balance').innerText=(inc-exp).toLocaleString(); document.getElementById('display-income').innerText=inc.toLocaleString(); document.getElementById('display-expense').innerText=exp.toLocaleString(); renderChart(expData); };
        window.openDetailModal = (id) => { const t = transactions.find(x => x.id === id); if(!t) return; currentDetailId = id; document.getElementById('detail-title').innerText = t.title || t.category; document.getElementById('detail-amount').innerText = `$ ${Number(t.amount).toLocaleString()}`; document.getElementById('detail-amount').className = t.type==='income' ? 'text-2xl font-black text-[#2A9D8F]' : 'text-2xl font-black text-[#E76F51]'; document.getElementById('detail-date').innerText = t.date; document.getElementById('detail-category').innerText = t.category; document.getElementById('detail-type').innerText = t.type==='income'?'æ”¶å…¥':'æ”¯å‡º'; const imgEl = document.getElementById('detail-img'); const noImgEl = document.getElementById('detail-no-img'); const detailIconEl = document.getElementById('detail-icon'); if(t.photo) { imgEl.src = t.photo; imgEl.classList.remove('hidden'); noImgEl.classList.add('hidden'); } else { imgEl.classList.add('hidden'); noImgEl.classList.remove('hidden'); detailIconEl.innerText = categoryIcons[t.category] || 'ğŸ•'; } const actionsEl = document.getElementById('detail-actions'); if(currentViewUid === currentUser.uid) actionsEl.classList.remove('hidden'); else actionsEl.classList.add('hidden'); renderDetailComments(t); document.getElementById('detail-modal').classList.remove('hidden'); };
        window.closeDetailModal = () => document.getElementById('detail-modal').classList.add('hidden');
        window.editCurrentDetail = () => { window.closeDetailModal(); window.editTransaction(currentDetailId); };
        window.deleteCurrentDetail = () => { if(confirm('åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) { window.deleteTransactionCloud(currentDetailId); window.closeDetailModal(); }};
        function renderDetailComments(t) { const list = document.getElementById('detail-comments-list'); list.innerHTML = ''; const comms = (t.comments||[]).filter(c => Date.now()-c.timestamp < 86400000); if(comms.length===0) list.innerHTML = '<div class="text-xs text-[#8D6E63] text-center py-4 bg-[#FFF8E1] rounded-xl border border-[#FFE8D6]">âœ¨ é‚„æ²’æœ‰ç•™è¨€ï¼Œæ¶é ­é¦™ï¼</div>'; comms.forEach(c => { const d = document.createElement('div'); d.className="text-sm bg-white border border-[#FFE8D6] p-3 rounded-xl mb-1 shadow-sm"; d.innerHTML = `<span class="font-bold text-[#F4A261] mr-1">${c.authorName}:</span><span class="text-[#4A3B32]">${c.text}</span>`; list.appendChild(d); }); }
        window.submitDetailComment = async () => { const txt = document.getElementById('detail-comment-input').value.trim(); if(!txt) return; const ref = doc(db,"users",currentViewUid,"transactions",currentDetailId); const snap = await getDoc(ref); let arr = snap.data().comments || []; arr.push({text:txt, authorName:myProfileData.name, timestamp:Date.now()}); await updateDoc(ref, {comments:arr}); document.getElementById('detail-comment-input').value=''; renderDetailComments({...snap.data(), comments:arr}); };
        async function ensureUserHasId(user) { const ref = doc(db, "users", user.uid); const snap = await getDoc(ref); const userPhoto = user.photoURL || DEFAULT_AVATAR; if(snap.exists()) { const d = snap.data(); myShortId = d.shortId; myProfileData = {...d, photo: d.photo || userPhoto}; if (myProfileData.boneCoins === undefined) { await updateDoc(ref, { boneCoins: 100 }); myProfileData.boneCoins = 100; } } else { let id = Math.floor(100000 + Math.random()*900000).toString(); const newData = { shortId: id, name: user.displayName, email: user.email, photo: userPhoto, boneCoins: 100 }; await setDoc(doc(db, "public_codes", id), {uid: user.uid, email: user.email, photo: userPhoto}); await setDoc(ref, newData); myShortId = id; myProfileData = newData; } document.getElementById('my-short-id').innerText = `ID: ${myShortId}`; document.getElementById('profile-short-id').innerText = myShortId; document.getElementById('profile-email').innerText = user.email; document.getElementById('profile-name-input').value = myProfileData.name; document.getElementById('profile-avatar').src = myProfileData.photo; }
        function loadDataRealtime(targetUid) { if(unsubscribe) unsubscribe(); const q = query(collection(db, "users", targetUid, "transactions"), orderBy("dateTimestamp", "desc")); unsubscribe = onSnapshot(q, (snap) => { transactions = snap.docs.map(d => ({id: d.id, ...d.data()})); const years = new Set([new Date().getFullYear()]); transactions.forEach(t => years.add(new Date(t.dateTimestamp).getFullYear())); const ySelect = document.getElementById('filter-year'); const currY = ySelect.value; ySelect.innerHTML = Array.from(years).sort((a,b)=>b-a).map(y => `<option value="${y}">${y} å¹´</option>`).join(''); if(currY) ySelect.value = currY; updateUI(); }, (error) => { console.error("è®€å–å¤±æ•—:", error); alert("è®€å–æ¬Šé™ä¸è¶³ï¼Œè«‹ç¢ºèªå°æ–¹å·²åŠ ä½ ç‚ºå¥½å‹"); }); }
        
        // ğŸ”¥ é—œéµä¿®æ­£ï¼šModal é–‹å•Ÿæ™‚é–å®šèƒŒæ™¯æ²å‹•
        window.openInputModal = () => { if(!editingId) window.resetForm(); document.getElementById('input-modal').classList.remove('hidden'); lockScroll(); };
        window.closeInputModal = () => { 
            document.getElementById('input-modal').classList.add('hidden'); 
            document.getElementById('input-panel').style.transform = ''; // Reset drag
            unlockScroll();
            setTimeout(() => window.resetForm(), 300); 
        };
        window.triggerSubmit = () => { document.getElementById('transaction-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true})); };
        window.resetForm = () => { editingId = null; document.getElementById('form-title').innerText = "è¨˜ä¸€ç­†"; inpAmount.value = ''; inpTitle.value = ''; inpDate.valueAsDate = new Date(); window.clearPhoto(); };
        window.editTransaction = (id) => { const tx = transactions.find(t => t.id === id); if (!tx) return; editingId = id; inpTitle.value = tx.title; inpAmount.value = tx.amount; inpType.value = tx.type; updateCategoryOptions(); inpCategory.value = tx.category; inpDate.valueAsDate = new Date(tx.dateTimestamp); currentPhotoData = tx.photo || null; if (currentPhotoData) { document.getElementById('img-preview').src = currentPhotoData; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); } else window.clearPhoto(); document.getElementById('form-title').innerText = "ç·¨è¼¯"; window.openInputModal(); };
        document.getElementById('transaction-form').addEventListener('submit', async (e) => { e.preventDefault(); if(currentViewUid !== currentUser.uid) return alert("åªèƒ½ç·¨è¼¯è‡ªå·±çš„å¸³æœ¬å–”"); const amount = Number(inpAmount.value); if(amount <= 0) return alert("é‡‘é¡éŒ¯èª¤"); const data = { amount, type: inpType.value, category: inpCategory.value, title: inpTitle.value.trim() || inpCategory.value, dateTimestamp: inpDate.valueAsDate.getTime(), date: inpDate.valueAsDate.toLocaleDateString(), photo: currentPhotoData }; try { if(editingId) { await updateDoc(doc(db, "users", currentUser.uid, "transactions", editingId), data); } else { await addDoc(collection(db, "users", currentUser.uid, "transactions"), data); await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: increment(10) }); myProfileData.boneCoins += 10; triggerShibaReaction("è¨˜å¸³æˆåŠŸï¼éª¨é ­å¹£ +10ï¼(é–‹å¿ƒ)"); playCoin(); } window.closeInputModal(); } catch(e) { alert("éŒ¯èª¤: " + e.message); } });
        window.deleteTransactionCloud = async (id) => { await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id)); };
        
        window.changeFilterMode = () => { const mode = document.getElementById('filter-type').value; document.getElementById('filter-day').classList.add('hidden'); document.getElementById('filter-month').classList.add('hidden'); document.getElementById('filter-year').classList.add('hidden'); if(mode === 'day') document.getElementById('filter-day').classList.remove('hidden'); if(mode === 'month') document.getElementById('filter-month').classList.remove('hidden'); if(mode === 'year') document.getElementById('filter-year').classList.remove('hidden'); updateUI(); }
        async function loadCustomCategories(user) { const s = await getDoc(doc(db, "users", user.uid)); if(s.exists() && s.data().customCategories) userCustomCategories = s.data().customCategories; updateCategoryOptions(); }
        window.updateCategoryOptions = () => { const type = inpType.value; const cats = [...defaultCategories[type], ...(userCustomCategories[type]||[])]; inpCategory.innerHTML = cats.map(c => { const icon = categoryIcons[c] || 'âœ¨'; return `<option value="${c}">${icon} ${c}</option>`; }).join(''); }
        window.addCustomCategory = async () => { const n = prompt("æ–°åˆ†é¡åç¨±:"); if(n) { const t = inpType.value; if(!userCustomCategories[t]) userCustomCategories[t] = []; userCustomCategories[t].push(n); await setDoc(doc(db, "users", currentUser.uid), {customCategories: userCustomCategories}, {merge:true}); updateCategoryOptions(); inpCategory.value = n; } }
        document.getElementById('filter-day').addEventListener('input', updateUI); document.getElementById('filter-month').addEventListener('input', updateUI); document.getElementById('filter-year').addEventListener('change', updateUI);
        
        Chart.register(ChartDataLabels);
        function renderChart(data) { const ctx = document.getElementById('expenseChart').getContext('2d'); const legendContainer = document.getElementById('chart-legend'); const lbs = Object.keys(data); const vals = Object.values(data); if(myChart) myChart.destroy(); if(lbs.length === 0) { document.getElementById('chart-placeholder').classList.remove('hidden'); legendContainer.innerHTML = ''; return; } document.getElementById('chart-placeholder').classList.add('hidden'); const colors = ['#F4A261','#E76F51','#E9C46A','#2A9D8F','#264653','#8D6E63','#F4D35E','#DA627D']; myChart = new Chart(ctx, { type: 'doughnut', data: { labels: lbs, datasets: [{ data: vals, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } } } }); const total = vals.reduce((a, b) => a + b, 0); legendContainer.innerHTML = lbs.map((label, i) => { const val = vals[i]; const percent = Math.round((val / total) * 100); const color = colors[i % colors.length]; const icon = categoryIcons[label] || 'âœ¨'; return `<div class="flex items-center justify-between"><div class="flex items-center gap-1.5 min-w-0"><div class="w-2.5 h-2.5 rounded-full shrink-0" style="background-color: ${color}"></div><span class="truncate font-bold text-[#4A3B32]">${icon} ${label}</span></div><div class="text-[#8D6E63] font-mono shrink-0">${percent}%</div></div>`; }).join(''); }

        window.toggleChart = () => { document.getElementById('chart-container').classList.toggle('hidden'); }
        window.toggleFriendModal = () => document.getElementById('friend-modal').classList.toggle('hidden');
        window.toggleProfileModal = () => document.getElementById('profile-modal').classList.toggle('hidden');
        window.handlePhotoSelect = (e) => processImage(e.target.files[0], (data) => { currentPhotoData = data; document.getElementById('img-preview').src = data; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); });
        window.handleProfilePhotoSelect = (e) => processImage(e.target.files[0], (data) => { currentProfilePhotoData = data; document.getElementById('profile-avatar').src = data; });
        function processImage(file, cb) { if(!file) return; const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); const scale = 600/i.width; c.width = 600; c.height = i.height*scale; c.getContext('2d').drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/jpeg', 0.6)); }; i.src = e.target.result; }; r.readAsDataURL(file); }
        window.clearPhoto = () => { document.getElementById('inp-photo').value=''; currentPhotoData=null; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('btn-camera').classList.remove('hidden'); };
        window.saveProfile = async () => { await updateDoc(doc(db,"users",currentUser.uid), {name:document.getElementById('profile-name-input').value, photo:currentProfilePhotoData}); alert('å·²å„²å­˜'); window.toggleProfileModal(); };
        window.toggleStoreModal = async () => { const modal = document.getElementById('store-modal'); const isHidden = modal.classList.contains('hidden'); if (isHidden) { const userRef = doc(db, "users", currentUser.uid); const snap = await getDoc(userRef); if (snap.exists()) { myProfileData.boneCoins = snap.data().boneCoins || 0; document.getElementById('store-coin-count').innerText = myProfileData.boneCoins; } modal.classList.remove('hidden'); } else { modal.classList.add('hidden'); } };
        window.buyItem = async (price, itemName) => { if (myProfileData.boneCoins >= price) { if(confirm(`ç¢ºå®šèŠ±è²» ${price} éª¨é ­å¹£è³¼è²· ${itemName} å—ï¼Ÿ`)) { await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: increment(-price) }); myProfileData.boneCoins -= price; document.getElementById('store-coin-count').innerText = myProfileData.boneCoins; triggerShibaReaction(`è¬è¬æƒ é¡§ï¼ä½ è²·äº† ${itemName} (æ±ª!)`); playCoin(); } } else { triggerShibaReaction("éª¨é ­å¹£ä¸å¤ å•¦ï¼å¿«å»è¨˜å¸³ï¼(æ°£)"); } };
        window.setMoney = async (amount) => { if (!currentUser) return alert("è«‹å…ˆç™»å…¥"); try { await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: Number(amount) }); if(myProfileData) myProfileData.boneCoins = Number(amount); const storeCountEl = document.getElementById('store-coin-count'); if(storeCountEl) storeCountEl.innerText = amount; alert(`ğŸ¶ æ¸¬è©¦æ¨¡å¼ï¼šéª¨é ­å¹£å·²ä¿®æ”¹ç‚º ${amount}`); } catch (e) { console.error(e); alert("ä¿®æ”¹å¤±æ•—"); } };
        window.switchView = (uid, name) => { currentViewUid = uid; document.getElementById('current-view-label').innerText = uid===currentUser.uid ? 'å€‹äºº' : name; updateViewMode(); loadDataRealtime(uid); document.getElementById('friend-modal').classList.add('hidden'); }
        function updateViewMode() { const isMe = currentViewUid === currentUser.uid; document.getElementById('fab-btn').classList.toggle('hidden', !isMe); }
    </script>
</body>
</html>

