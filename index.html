<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMA - æ¥µç°¡è¨˜å¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <div class="max-w-md mx-auto min-h-screen bg-white shadow-2xl overflow-hidden relative">
        
        <header class="bg-white px-6 py-4 flex items-center justify-between sticky top-0 z-20 border-b border-gray-100">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold mr-2 shadow-blue-200 shadow-lg">F</div>
                <h1 class="text-xl font-extrabold tracking-tight text-gray-900">FMA</h1>
            </div>
            <button onclick="toggleChart()" class="text-sm text-blue-600 font-semibold bg-blue-50 px-3 py-1 rounded-full">
                ğŸ“Š åˆ‡æ›åœ–è¡¨
            </button>
        </header>

        <main class="p-6 pb-24 space-y-6">
            
            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-2xl p-6 shadow-xl shadow-blue-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                <div class="relative z-10">
                    <div class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">æœ¬æœˆçµé¤˜</div>
                    <div class="text-4xl font-bold mb-6 tracking-tight" id="display-balance">$ 0</div>
                    <div class="flex gap-4">
                        <div class="flex-1 bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                            <span class="text-xs text-blue-100 block mb-1">ç¸½æ”¶å…¥</span>
                            <div class="font-semibold text-lg" id="display-income">0</div>
                        </div>
                        <div class="flex-1 bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                            <span class="text-xs text-blue-100 block mb-1">ç¸½æ”¯å‡º</span>
                            <div class="font-semibold text-lg" id="display-expense">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chart-container" class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
                <h2 class="text-xs font-bold text-gray-400 uppercase mb-3">æ”¯å‡ºåˆ†æ</h2>
                <div class="relative h-48 w-full flex justify-center">
                    <canvas id="expenseChart"></canvas>
                </div>
                <p id="chart-placeholder" class="text-center text-xs text-gray-400 mt-2 hidden">é‚„æ²’æœ‰æ”¯å‡ºç´€éŒ„ï¼Œç„¡æ³•é¡¯ç¤ºåœ–è¡¨</p>
            </div>

            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
                <h2 class="text-xs font-bold text-gray-400 uppercase mb-3">å¿«é€Ÿè¨˜å¸³</h2>
                <form id="transaction-form" class="flex flex-col gap-3">
                    <div class="flex gap-2">
                        <select id="inp-type" onchange="updateCategoryOptions()" class="w-1/3 bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-2 py-2.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="expense">æ”¯å‡º</option>
                            <option value="income">æ”¶å…¥</option>
                        </select>
                        <select id="inp-category" class="w-2/3 bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="text" id="inp-title" placeholder="å‚™è¨» (å¦‚: åˆé¤)" class="w-2/3 bg-gray-50 border border-gray-200 text-gray-900 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="number" id="inp-amount" placeholder="$" class="w-1/3 bg-gray-50 border border-gray-200 text-gray-900 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium text-sm shadow-md shadow-blue-200 transition-colors flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        æ–°å¢ç´€éŒ„
                    </button>
                </form>
            </div>

            <div>
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-gray-800">æœ€è¿‘äº¤æ˜“</h2>
                    <button onclick="clearAll()" class="text-xs text-red-400 hover:text-red-600">é‡ç½®</button>
                </div>
                <div id="transaction-list" class="space-y-3 pb-10"></div>
                <div id="empty-state" class="hidden py-10 text-center">
                    <p class="text-gray-400 text-sm">æš«ç„¡ç´€éŒ„</p>
                </div>
            </div>

        </main>
    </div>

    <script>
        // === è³‡æ–™è¨­å®š ===
        let transactions = JSON.parse(localStorage.getItem('fma_data_v2')) || [];
        let myChart = null; // å­˜æ”¾åœ–è¡¨å¯¦ä¾‹

        // å®šç¾©é¡åˆ¥é¸å–®
        const categories = {
            expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'å…¶ä»–'],
            income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–']
        };

        // DOM å…ƒç´ 
        const form = document.getElementById('transaction-form');
        const listEl = document.getElementById('transaction-list');
        const balanceEl = document.getElementById('display-balance');
        const incomeEl = document.getElementById('display-income');
        const expenseEl = document.getElementById('display-expense');
        const typeSelect = document.getElementById('inp-type');
        const categorySelect = document.getElementById('inp-category');

        // === æ ¸å¿ƒåŠŸèƒ½ ===

        // 1. æ›´æ–°é¡åˆ¥ä¸‹æ‹‰é¸å–®
        function updateCategoryOptions() {
            const type = typeSelect.value; // expense or income
            const options = categories[type];
            categorySelect.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        // 2. æ¸²æŸ“ä¸»ç•«é¢
        function updateUI() {
            listEl.innerHTML = '';
            let totalIncome = 0;
            let totalExpense = 0;
            
            // ç”¨ä¾†çµ±è¨ˆåœ–è¡¨è³‡æ–™
            let expenseData = {}; 

            if (transactions.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            // æ’åºä¸¦æ¸²æŸ“åˆ—è¡¨
            transactions.sort((a, b) => b.id - a.id).forEach(t => {
                // è¨ˆç®—ç¸½é¡
                if (t.type === 'income') {
                    totalIncome += Number(t.amount);
                } else {
                    totalExpense += Number(t.amount);
                    // çµ±è¨ˆæ”¯å‡ºé¡åˆ¥ (å¦‚æœæ²’æœ‰é€™å€‹é¡åˆ¥å°±åˆå§‹åŒ–ç‚º0ï¼Œæœ‰å°±ç´¯åŠ )
                    let cat = t.category || 'å…¶ä»–';
                    expenseData[cat] = (expenseData[cat] || 0) + Number(t.amount);
                }

                // ç”¢ç”Ÿ HTML
                const isIncome = t.type === 'income';
                const sign = isIncome ? '+' : '-';
                const colorClass = isIncome ? 'text-green-600' : 'text-gray-800';
                // ç‚ºäº†å…¼å®¹èˆŠè³‡æ–™ï¼Œå¦‚æœæ²’æœ‰ category å°±é¡¯ç¤º title
                const displayTitle = t.category ? `${t.category} - ${t.title}` : t.title;

                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${isIncome ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'} flex items-center justify-center shrink-0 font-bold">
                            ${isIncome ? 'å…¥' : 'å‡º'}
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${displayTitle}</p>
                            <p class="text-xs text-gray-400">${t.date}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold ${colorClass}">
                            ${sign} ${Number(t.amount).toLocaleString()}
                        </span>
                        <button onclick="deleteTransaction(${t.id})" class="text-gray-300 hover:text-red-500">
                            Ã—
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
            });

            // æ›´æ–°å„€è¡¨æ¿æ•¸å­—
            const balance = totalIncome - totalExpense;
            balanceEl.innerText = `$ ${balance.toLocaleString()}`;
            incomeEl.innerText = `+ ${totalIncome.toLocaleString()}`;
            expenseEl.innerText = `- ${totalExpense.toLocaleString()}`;

            // æ›´æ–°åœ–è¡¨
            renderChart(expenseData);

            // å„²å­˜è³‡æ–™
            localStorage.setItem('fma_data_v2', JSON.stringify(transactions));
        }

        // 3. ç¹ªè£½åœ–è¡¨ (ä½¿ç”¨ Chart.js)
        function renderChart(dataObj) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const labels = Object.keys(dataObj);
            const dataValues = Object.values(dataObj);

            // å¦‚æœæ²’æœ‰æ”¯å‡ºè³‡æ–™ï¼Œéš±è— Canvas é¡¯ç¤ºæç¤º
            if (labels.length === 0) {
                document.getElementById('expenseChart').style.display = 'none';
                document.getElementById('chart-placeholder').classList.remove('hidden');
                return;
            } else {
                document.getElementById('expenseChart').style.display = 'block';
                document.getElementById('chart-placeholder').classList.add('hidden');
            }

            // éŠ·æ¯€èˆŠåœ–è¡¨ (é¿å…é–ƒçˆ)
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'doughnut', // ç”œç”œåœˆåœ–
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: [
                            '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#6366F1'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right', // åœ–ä¾‹åœ¨å³é‚Š
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // 4. æ–°å¢äº¤æ˜“
        function addTransaction(e) {
            e.preventDefault();
            const title = document.getElementById('inp-title').value;
            const amount = document.getElementById('inp-amount').value;
            const type = document.getElementById('inp-type').value;
            const category = document.getElementById('inp-category').value;

            if (!title || !amount) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');

            const newTx = {
                id: Date.now(),
                title: title,
                amount: Number(amount),
                type: type,
                category: category, // æ–°å¢åˆ†é¡æ¬„ä½
                date: new Date().toLocaleDateString()
            };

            transactions.push(newTx);
            updateUI();

            // é‡ç½®è¡¨å–®
            document.getElementById('inp-title').value = '';
            document.getElementById('inp-amount').value = '';
            document.getElementById('inp-title').focus();
        }

        // 5. åˆªé™¤èˆ‡æ¸…é™¤
        function deleteTransaction(id) {
            if(confirm('åˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
                transactions = transactions.filter(t => t.id !== id);
                updateUI();
            }
        }

        function clearAll() {
            if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) {
                transactions = [];
                updateUI();
            }
        }

        function toggleChart() {
            const chartDiv = document.getElementById('chart-container');
            chartDiv.classList.toggle('hidden');
        }

        // åˆå§‹åŒ–
        updateCategoryOptions(); // å…ˆç”¢ç”Ÿä¸‹æ‹‰é¸å–®
        form.addEventListener('submit', addTransaction);
        updateUI();

    </script>
</body>
</html>

