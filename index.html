<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMA - æ¥µç°¡è¨˜å¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <div class="max-w-md mx-auto min-h-screen bg-white shadow-2xl overflow-hidden relative">
        
        <header class="bg-white px-6 py-4 flex items-center justify-between sticky top-0 z-20 border-b border-gray-100">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold mr-2 shadow-blue-200 shadow-lg">F</div>
                <h1 class="text-xl font-extrabold tracking-tight text-gray-900">FMA</h1>
            </div>
            <button onclick="toggleChart()" class="text-sm text-blue-600 font-semibold bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition">
                ğŸ“Š åˆ‡æ›é¡¯ç¤º
            </button>
        </header>

        <main class="p-6 pb-24 space-y-6">
            
            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-2xl p-6 shadow-xl shadow-blue-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                <div class="relative z-10">
                    <div class="text-blue-100 text-xs font-medium uppercase tracking-wider mb-1">æœ¬æœˆçµé¤˜</div>
                    <div class="text-4xl font-bold mb-6 tracking-tight" id="display-balance">$ 0</div>
                    <div class="flex gap-4">
                        <div class="flex-1 bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                            <span class="text-xs text-blue-100 block mb-1">ç¸½æ”¶å…¥</span>
                            <div class="font-semibold text-lg" id="display-income">0</div>
                        </div>
                        <div class="flex-1 bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                            <span class="text-xs text-blue-100 block mb-1">ç¸½æ”¯å‡º</span>
                            <div class="font-semibold text-lg" id="display-expense">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chart-container" class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
                <h2 class="text-xs font-bold text-gray-400 uppercase mb-3 flex justify-between">
                    <span>æ”¯å‡ºä½”æ¯”åˆ†æ</span>
                    <span class="text-blue-600 font-normal" id="total-expense-label"></span>
                </h2>
                <div class="relative h-56 w-full flex justify-center">
                    <canvas id="expenseChart"></canvas>
                </div>
                <p id="chart-placeholder" class="text-center text-xs text-gray-400 mt-10 hidden">æ–°å¢æ”¯å‡ºå¾Œå³å¯æŸ¥çœ‹åˆ†æåœ–è¡¨</p>
            </div>

            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
                <h2 class="text-xs font-bold text-gray-400 uppercase mb-3">å¿«é€Ÿè¨˜å¸³</h2>
                <form id="transaction-form" class="flex flex-col gap-3">
                    <div class="flex gap-2">
                        <select id="inp-type" onchange="updateCategoryOptions()" class="w-1/3 bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-2 py-2.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="expense">æ”¯å‡º</option>
                            <option value="income">æ”¶å…¥</option>
                        </select>
                        <select id="inp-category" class="w-2/3 bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="text" id="inp-title" placeholder="å‚™è¨» (å¦‚: åˆé¤)" class="w-2/3 bg-gray-50 border border-gray-200 text-gray-900 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="number" id="inp-amount" placeholder="$" min="1" step="1" class="w-1/3 bg-gray-50 border border-gray-200 text-gray-900 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium text-sm shadow-md shadow-blue-200 transition-colors flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        æ–°å¢ç´€éŒ„
                    </button>
                </form>
            </div>

            <div>
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-gray-800">æœ€è¿‘äº¤æ˜“</h2>
                    <button onclick="clearAll()" class="text-xs text-red-400 hover:text-red-600">é‡ç½®</button>
                </div>
                <div id="transaction-list" class="space-y-3 pb-10"></div>
                <div id="empty-state" class="hidden py-10 text-center">
                    <p class="text-gray-400 text-sm">æš«ç„¡ç´€éŒ„</p>
                </div>
            </div>

        </main>
    </div>

    <script>
        // === åˆå§‹åŒ–è¨­å®š ===
        Chart.register(ChartDataLabels);

        let transactions = JSON.parse(localStorage.getItem('fma_data_v2')) || [];
        let myChart = null;

        const categories = {
            expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'],
            income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–']
        };

        const form = document.getElementById('transaction-form');
        const listEl = document.getElementById('transaction-list');
        const balanceEl = document.getElementById('display-balance');
        const incomeEl = document.getElementById('display-income');
        const expenseEl = document.getElementById('display-expense');
        const typeSelect = document.getElementById('inp-type');
        const categorySelect = document.getElementById('inp-category');

        function updateCategoryOptions() {
            const type = typeSelect.value;
            const options = categories[type];
            categorySelect.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        function updateUI() {
            listEl.innerHTML = '';
            let totalIncome = 0;
            let totalExpense = 0;
            let expenseData = {}; 

            if (transactions.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            transactions.sort((a, b) => b.id - a.id).forEach(t => {
                if (t.type === 'income') {
                    totalIncome += Number(t.amount);
                } else {
                    totalExpense += Number(t.amount);
                    let cat = t.category || 'å…¶ä»–';
                    expenseData[cat] = (expenseData[cat] || 0) + Number(t.amount);
                }

                const isIncome = t.type === 'income';
                const sign = isIncome ? '+' : '-';
                const colorClass = isIncome ? 'text-green-600' : 'text-gray-800';
                const displayTitle = t.category ? `${t.category} - ${t.title}` : t.title;

                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${isIncome ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'} flex items-center justify-center shrink-0 font-bold">
                            ${isIncome ? 'å…¥' : 'å‡º'}
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${displayTitle}</p>
                            <p class="text-xs text-gray-400">${t.date}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold ${colorClass}">
                            ${sign} ${Number(t.amount).toLocaleString()}
                        </span>
                        <button onclick="deleteTransaction(${t.id})" class="text-gray-300 hover:text-red-500">Ã—</button>
                    </div>
                `;
                listEl.appendChild(item);
            });

            balanceEl.innerText = `$ ${balance.toLocaleString()}`;
            incomeEl.innerText = `+ ${totalIncome.toLocaleString()}`;
            expenseEl.innerText = `- ${totalExpense.toLocaleString()}`;

            renderChart(expenseData, totalExpense);

            localStorage.setItem('fma_data_v2', JSON.stringify(transactions));
        }

        function renderChart(dataObj, totalExp) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const labels = Object.keys(dataObj);
            const dataValues = Object.values(dataObj);

            if (labels.length === 0) {
                document.getElementById('expenseChart').style.display = 'none';
                document.getElementById('chart-placeholder').classList.remove('hidden');
                document.getElementById('total-expense-label').innerText = '';
                return;
            } else {
                document.getElementById('expenseChart').style.display = 'block';
                document.getElementById('chart-placeholder').classList.add('hidden');
                document.getElementById('total-expense-label').innerText = `ç¸½æ”¯å‡º: $${totalExp.toLocaleString()}`;
            }

            if (myChart) myChart.destroy();

            const colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#6366F1', '#14B8A6'];

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 10 },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, usePointStyle: true, font: { size: 11 } }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value, ctx) => {
                                let sum = 0;
                                ctx.chart.data.datasets[0].data.map(data => { sum += data; });
                                let percentage = (value * 100 / sum);
                                if (percentage < 5) return null;
                                return percentage.toFixed(1) + "%";
                            },
                            anchor: 'end',
                            align: 'start',
                            offset: -8,
                        }
                    }
                }
            });
        }

        function addTransaction(e) {
            e.preventDefault();
            const title = document.getElementById('inp-title').value;
            const amountInput = document.getElementById('inp-amount').value; // å–å¾—å­—ä¸²
            const type = document.getElementById('inp-type').value;
            const category = document.getElementById('inp-category').value;
            
            // è½‰æ›ç‚ºæ•¸å­—
            const amount = Number(amountInput);

            // 1. æª¢æŸ¥æ˜¯å¦ç©ºç™½
            if (!title || amountInput === '') {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„é …ç›®èˆ‡é‡‘é¡ï¼');
                return;
            }

            // 2. æª¢æŸ¥é‡‘é¡æ˜¯å¦ <= 0 (é‡é»ä¿®æ­£)
            if (amount <= 0) {
                alert('é‡‘é¡å¿…é ˆå¤§æ–¼ 0ï¼');
                return;
            }

            const newTx = {
                id: Date.now(),
                title: title,
                // å–çµ•å°å€¼ï¼Œç¢ºä¿ä¸€å®šæ˜¯æ­£æ•¸ (é›™é‡ä¿éšª)
                amount: Math.abs(amount),
                type: type,
                category: category,
                date: new Date().toLocaleDateString()
            };

            transactions.push(newTx);
            updateUI();

            document.getElementById('inp-title').value = '';
            document.getElementById('inp-amount').value = '';
            document.getElementById('inp-title').focus();
        }

        function deleteTransaction(id) {
            if(confirm('åˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
                transactions = transactions.filter(t => t.id !== id);
                updateUI();
            }
        }

        function clearAll() {
            if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) {
                transactions = [];
                updateUI();
            }
        }

        function toggleChart() {
            const chartDiv = document.getElementById('chart-container');
            chartDiv.classList.toggle('hidden');
        }

        updateCategoryOptions();
        form.addEventListener('submit', addTransaction);
        updateUI();

    </script>
</body>
</html>
