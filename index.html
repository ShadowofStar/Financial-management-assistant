<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ´ç®¡å®¶ - å…¨è‡ªå‹•åŒæ­¥ç‰ˆ</title>
    
    <link rel="icon" type="image/png" href="./Shiba Logo.png">
    <link rel="shortcut icon" href="./Shiba Logo.png">
    <link rel="apple-touch-icon" href="./Shiba Logo.png">
    <meta name="theme-color" content="#FFFCF5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/zh-tw.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: pan-y; user-select: none; overscroll-behavior-y: none; overflow-x: hidden; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        /* ç©©å®šçš„æ»‘å…¥å‹•ç•« */
        .slide-up-anim { animation: slideUpKey 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes slideUpKey { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        :root { --shiba-bg: #FFFCF5; --shiba-orange: #F4A261; --shiba-brown: #4A3B32; }

        @keyframes shiba-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        .animate-shiba-float { animation: shiba-float 3s ease-in-out infinite; }
        @keyframes shiba-bounce { 0%, 100% { transform: scale(1) rotate(0deg); } 40% { transform: scale(1.15) rotate(5deg); } 80% { transform: scale(0.95) rotate(-3deg); } }
        .animate-shiba-bounce { animation: shiba-bounce 0.4s ease-out; }
        @keyframes coin-drop { 0% { transform: translateY(-50px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(0); opacity: 1; } }
        .animate-coin { animation: coin-drop 0.5s ease-out forwards; }
        @keyframes heart-float { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-40px) scale(1.5); opacity: 0; } }
        .animate-heart { position: absolute; animation: heart-float 0.8s ease-out forwards; pointer-events: none; font-size: 24px; z-index: 50; }

        .music-playing { animation: pulse-music 1.2s infinite; border-color: #F4A261 !important; color: #F4A261 !important; background: #FFF !important; }
        @keyframes pulse-music { 0% { box-shadow: 0 0 0 0 rgba(244, 162, 97, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(244, 162, 97, 0); } 100% { box-shadow: 0 0 0 0 rgba(244, 162, 97, 0); } }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #F4A261; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid white; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #FFE8D6; border-radius: 4px; }
        
        .black-shiba-filter { filter: grayscale(100%) brightness(0.6) contrast(1.2); }
        .sold-out { opacity: 0.6 !important; pointer-events: none !important; background-color: #BDBDBD !important; color: #FFFFFF !important; box-shadow: none !important; border: none !important; cursor: not-allowed !important; }
    </style>
</head>
<body class="bg-[#FFFCF5] text-[#4A3B32] min-h-screen selection:bg-[#F4A261] selection:text-white">

    <audio id="bg-music" loop crossorigin="anonymous">
        <source src="./[J&B No Copyright Music] Yummy Flavor Background Music.mp3" type="audio/mpeg">
    </audio>

    <div id="start-overlay" class="fixed inset-0 bg-[#FFFCF5] z-[100] flex flex-col items-center justify-center fade-in">
        <img src="./Shiba Logo.png" class="w-32 h-32 rounded-[2rem] shadow-xl mb-6 animate-shiba-float border-4 border-white">
        <h2 class="text-2xl font-black text-[#4A3B32] mb-2">æ­¡è¿ä¾†åˆ°æŸ´ç®¡å®¶</h2>
        <p class="text-[#8D6E63] text-sm font-bold mb-8">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•ŸéŸ³æ•ˆé«”é©— ğŸµ</p>
        <button onclick="startApp()" class="bg-[#F4A261] text-white text-lg font-black py-4 px-12 rounded-2xl shadow-[0_4px_0_#E76F51] active:translate-y-1 active:shadow-none transition-all animate-bounce">é€²å…¥ App</button>
    </div>

    <div id="login-screen" class="hidden fixed inset-0 bg-[#FFFCF5] z-50 flex flex-col items-center justify-center p-6 text-center fade-in">
        <div class="relative"><div class="absolute -inset-4 bg-[#F4A261] rounded-full opacity-20 blur-xl"></div><img src="./Shiba Logo.png" class="relative w-32 h-32 rounded-[2rem] shadow-xl mb-6 object-cover border-4 border-white"></div>
        <h1 class="text-3xl font-black text-[#4A3B32] mb-2 tracking-tight">æŸ´ç®¡å®¶</h1><p class="text-[#8D6E63] mb-10 font-bold">è®“è¨˜å¸³è®Šå¾—å¯æ„›åˆç°¡å–®</p>
        <button id="btn-google-login" class="w-full max-w-sm bg-white border-2 border-[#F4A261] text-[#4A3B32] font-bold py-4 px-4 rounded-2xl shadow-[0_4px_0_#F4A261] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center gap-3"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
    </div>

    <div id="app-screen" class="hidden max-w-md mx-auto min-h-screen bg-[#FFFCF5] relative overflow-hidden flex flex-col shadow-2xl">
        <header class="bg-[#FFFCF5]/95 px-5 pt-12 pb-2 flex items-center justify-between sticky top-0 z-10 backdrop-blur-md transition-colors duration-300">
            <button onclick="toggleMusic()" id="music-btn" class="text-xl w-9 h-9 flex items-center justify-center rounded-full bg-[#FFF0D4] text-[#8D6E63] border-2 border-[#FFE8D6] shadow-sm transition active:scale-95">ğŸ”‡</button>
            <div class="flex flex-col items-center">
                <div class="flex items-center gap-2"><h1 id="header-title" class="text-2xl font-black text-[#4A3B32] tracking-tight">æˆ‘çš„ç›¸ç°¿</h1></div>
                <div class="flex items-center gap-1 mt-1 text-xs text-[#8D6E63] font-bold cursor-pointer bg-[#FFF0D4] px-2 py-1 rounded-lg w-fit transition active:scale-95" onclick="openUserProfile(currentViewUid)"><span id="current-view-label">å€‹äºº</span><span class="text-[#F4A261]">|</span><span id="my-short-id" class="font-mono">ID...</span></div>
            </div>
            <div class="flex gap-2">
                <div class="bg-white border-2 border-[#FFE8D6] p-0.5 rounded-xl flex text-xs font-bold relative shadow-sm">
                    <select id="filter-type" onchange="changeFilterMode()" class="bg-transparent appearance-none px-2 py-1.5 text-[#8D6E63] focus:outline-none z-10 relative cursor-pointer"><option value="day">æ—¥</option><option value="month" selected>æœˆ</option><option value="year">å¹´</option><option value="all">å…¨</option></select>
                    <div class="pr-1 text-[#F4A261]">â–¼</div>
                    <input type="month" id="filter-month" class="absolute inset-0 opacity-0 cursor-pointer"><input type="date" id="filter-day" class="absolute inset-0 opacity-0 cursor-pointer hidden"><select id="filter-year" class="absolute inset-0 opacity-0 cursor-pointer hidden"></select>
                </div>
                <button onclick="toggleSettingsModal()" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border-2 border-[#FFE8D6] text-[#8D6E63] shadow-sm active:scale-95 text-lg">âš™ï¸</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-32 no-scrollbar" id="main-content">
            <div class="px-5 mt-2 mb-4">
                <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border-2 border-[#FFE8D6] flex justify-between items-center relative overflow-hidden" onclick="toggleChart()">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#FFF0D4] rounded-full opacity-50"></div>
                    <div class="relative z-10"><div class="text-[10px] text-[#8D6E63] font-bold uppercase tracking-wider mb-1">æœ¬æœˆçµé¤˜</div><div class="text-3xl font-black text-[#4A3B32] flex items-baseline"><span class="text-sm font-bold mr-1 text-[#F4A261]">$</span><span id="display-balance">0</span></div></div>
                    <div class="flex gap-4 text-right relative z-10"><div><div class="text-[10px] text-[#8D6E63] mb-0.5">æ”¶</div><div class="font-bold text-[#2A9D8F] text-sm" id="display-income">0</div></div><div><div class="text-[10px] text-[#8D6E63] mb-0.5">æ”¯</div><div class="font-bold text-[#E76F51] text-sm" id="display-expense">0</div></div></div>
                </div>
                <div id="chart-container" class="hidden bg-white mt-2 rounded-[1.5rem] p-4 border-2 border-[#FFE8D6] fade-in"><div class="flex items-center gap-3"><div class="w-[45%] h-32 relative"><canvas id="expenseChart"></canvas><p id="chart-placeholder" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#8D6E63] text-xs font-bold">ç„¡æ•¸æ“š</p></div><div id="chart-legend" class="w-[55%] space-y-1.5 max-h-32 overflow-y-auto text-xs pr-1"></div></div></div>
            </div>
            <div id="transaction-list" class="grid grid-cols-3 gap-1.5 px-3"></div>
            <div id="empty-state" class="hidden py-16 text-center"><img src="./Shiba Logo.png" class="w-20 h-20 mx-auto mb-4 opacity-40 grayscale rounded-2xl"><p class="text-[#8D6E63] text-sm font-bold">æ±ªï¼Ÿé€™è£¡æ²’æœ‰æ±è¥¿å–”</p><button onclick="openInputModal()" class="mt-2 text-[#F4A261] text-xs font-bold hover:underline">å»è¨˜ä¸€ç­† (+10éª¨é ­å¹£)</button></div>
        </main>

        <div id="shiba-assistant-container" class="fixed bottom-[100px] right-4 z-40 pointer-events-auto group flex flex-col items-center">
             <div id="shiba-speech" class="hidden absolute bottom-full mb-3 right-0 bg-white p-3 rounded-2xl shadow-lg border-2 border-[#FFE8D6] text-xs font-black text-[#4A3B32] whitespace-nowrap scale-in origin-bottom-right">æ±ªï¼ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼<div class="absolute -bottom-1.5 right-6 w-3 h-3 bg-white border-b-2 border-r-2 border-[#FFE8D6] rotate-45"></div></div>
             <div class="relative" onclick="triggerShibaClick()">
                 <div id="shiba-hat" class="hidden absolute -top-8 left-1/2 -translate-x-1/2 text-5xl z-50 pointer-events-none drop-shadow-xl" style="transform: rotate(-10deg);">ğŸ©</div>
                 <img src="./Shiba Logo.png" id="shiba-assistant" class="w-20 h-20 rounded-full border-2 border-white shadow-md object-cover animate-shiba-float cursor-pointer hover:scale-105 transition-transform z-10">
                 <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-white px-2 py-0.5 rounded-full border border-[#FFE8D6] shadow-sm flex items-center gap-1 z-30">
                     <span id="mood-icon" class="text-[10px]">â¤ï¸</span>
                     <div class="w-10 h-1.5 bg-[#E0E0E0] rounded-full overflow-hidden">
                         <div id="mood-bar" class="h-full bg-[#FF7096] w-full transition-all duration-500"></div>
                     </div>
                 </div>
             </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-md bg-[#FFFCF5]/95 backdrop-blur-md border-t-2 border-[#FFE8D6] pb-safe pt-2 px-8 flex justify-between items-end z-30 h-[88px] rounded-t-[2rem]">
            <button onclick="toggleFriendModal()" class="flex flex-col items-center gap-1 w-16 pb-3 text-[#4A3B32] transition hover:scale-105 active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span class="text-[11px] font-black">å¥½å‹</span></button>
            <button id="fab-btn" onclick="openInputModal()" class="mb-6 bg-[#F4A261] text-white rounded-2xl w-14 h-14 shadow-[0_6px_20px_rgba(244,162,97,0.4)] flex items-center justify-center transform transition active:scale-90 hover:bg-[#E76F51] hover:-translate-y-1 border-4 border-[#FFFCF5]"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg></button>
            <button onclick="toggleStoreModal()" class="flex flex-col items-center gap-1 w-16 pb-3 text-[#4A3B32] transition hover:scale-105 active:scale-95 group"><div class="relative"><svg class="w-6 h-6 group-hover:text-[#F4A261] transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg><div class="absolute -top-1 -right-1 w-2 h-2 bg-[#E76F51] rounded-full hidden"></div></div><span class="text-[11px] font-black group-hover:text-[#F4A261] transition">å•†åº—</span></button>
        </nav>

        <div id="settings-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-center justify-center p-6 fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleSettingsModal()"></div><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-6 relative z-10 shadow-2xl scale-in border-4 border-white"><div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-black text-[#4A3B32]">ç³»çµ±è¨­å®š</h2><button onclick="toggleSettingsModal()" class="text-[#8D6E63] text-xl font-bold bg-[#FFE8D6] w-8 h-8 rounded-full flex items-center justify-center">Ã—</button></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] mb-4"><div class="flex justify-between items-center mb-2"><span class="font-bold text-[#4A3B32] text-sm">ğŸµ èƒŒæ™¯éŸ³æ¨‚</span><span class="text-xs text-[#8D6E63] font-bold" id="bgm-val-display">50%</span></div><input type="range" min="0" max="1" step="0.05" value="0.5" oninput="updateBGMVolume(this.value)"></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] mb-6"><div class="flex justify-between items-center mb-2"><span class="font-bold text-[#4A3B32] text-sm">ğŸ”Š æŒ‰éˆ•éŸ³æ•ˆ</span><span class="text-xs text-[#8D6E63] font-bold" id="sfx-val-display">50%</span></div><input type="range" min="0" max="1" step="0.05" value="0.5" oninput="updateSFXVolume(this.value)"></div><div class="text-center text-xs text-[#8D6E63] opacity-60 font-bold">ShibaManager v7.0 (Realtime)</div></div></div>
        
        <div id="store-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-center justify-end fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleStoreModal()"></div>
            <div id="store-panel" class="bg-[#FFFCF5] w-4/5 max-w-sm h-full flex flex-col relative z-10 slide-in-right shadow-2xl rounded-l-[2rem]" style="touch-action: pan-y;">
                <div class="p-6 pb-2 flex justify-between items-center border-b-2 border-[#FFE8D6]"><div><h2 class="text-2xl font-black text-[#4A3B32]">æŸ´æŸ´é›œè²¨èˆ–</h2><p class="text-xs text-[#8D6E63] font-bold">æ¶ˆè²»è®“ç”Ÿæ´»æ›´ç¾å¥½</p></div><div class="bg-[#FFF0D4] px-3 py-1.5 rounded-xl flex items-center gap-2 border border-[#F4A261]"><span class="text-xl">ğŸ¦´</span><span id="store-coin-count" class="font-black text-[#F4A261] text-lg">0</span></div></div>
                <div class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 no-scrollbar">
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ¥©</div><h3 class="font-black text-[#4A3B32] mb-1">é«˜ç´šè‚‰ç½é ­</h3><p class="text-[10px] text-[#8D6E63] mb-3">å¿ƒæƒ…å…¨æ»¿ (é™1æ¬¡/æ—¥)</p><button id="btn-buy-meat" onclick="buyItem(50, 'meat')" class="w-full bg-[#F4A261] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#E76F51] transition">50 ğŸ¦´ è³¼è²·</button></div>
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ©</div><h3 class="font-black text-[#4A3B32] mb-1">ç´³å£«å¸½å­</h3><p class="text-[10px] text-[#8D6E63] mb-3">æ°¸ä¹…è£é£¾ (é™1æ¬¡)</p><button id="btn-buy-hat" onclick="buyItem(200, 'hat')" class="w-full bg-[#2A9D8F] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#264653] transition">200 ğŸ¦´ è³¼è²·</button></div>
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ•â€ğŸ¦º</div><h3 class="font-black text-[#4A3B32] mb-1">é»‘æŸ´ä¸»é¡Œ</h3><p class="text-[10px] text-[#8D6E63] mb-3">å¸¥æ°£é¢¨æ ¼ (é™1æ¬¡)</p><button id="btn-buy-black" onclick="buyItem(500, 'black')" class="w-full bg-[#4A3B32] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-black transition">500 ğŸ¦´ è³¼è²·</button></div>
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸš«</div><h3 class="font-black text-[#4A3B32] mb-1">å»é™¤å»£å‘Š</h3><p class="text-[10px] text-[#8D6E63] mb-3">æ°¸ä¹…æ¸…çˆ½ (é™1æ¬¡)</p><button id="btn-buy-noads" onclick="buyItem(1000, 'noads')" class="w-full bg-[#E76F51] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-red-600 transition">1000 ğŸ¦´ è³¼è²·</button></div>
                </div>
                <div class="p-4 border-t border-[#FFE8D6]"><button onclick="toggleStoreModal()" class="w-full bg-[#FFE8D6] text-[#8D6E63] py-3 rounded-xl font-bold hover:bg-[#F4A261] hover:text-white transition">é—œé–‰å•†åº—</button></div>
            </div>
        </div>

        <div id="input-modal" class="fixed inset-0 bg-[#4A3B32]/40 z-50 hidden flex flex-col justify-end backdrop-blur-sm fade-in">
            <div class="absolute inset-0" onclick="closeInputModal()"></div>
            <div id="input-panel" class="bg-[#FFFCF5] w-full rounded-t-[2.5rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] relative z-10 pb-safe slide-up-anim max-h-[85vh] overflow-y-auto">
                <div class="w-12 h-1.5 bg-[#FFE8D6] rounded-full mx-auto mb-6"></div>
                
                <div class="flex justify-between items-center mb-6">
                    <button onclick="closeInputModal()" class="text-[#8D6E63] text-sm font-bold p-2 hover:bg-[#FFE8D6] rounded-lg">å–æ¶ˆ</button>
                    <h2 class="text-sm font-black text-[#F4A261] uppercase tracking-widest" id="form-title">è¨˜ä¸€ç­†</h2>
                    <button onclick="triggerSubmit()" class="text-[#E76F51] text-sm font-bold p-2 hover:bg-[#FFE8D6] rounded-lg">å®Œæˆ</button>
                </div>

                <form id="transaction-form" class="flex flex-col gap-5 pb-4">
                    <div class="relative group">
                        <span class="absolute left-6 top-1/2 -translate-y-1/2 text-2xl text-[#F4A261] font-bold">$</span>
                        <input type="number" id="inp-amount" placeholder="0" class="w-full bg-white border-2 border-[#FFE8D6] rounded-2xl py-4 pl-12 pr-4 text-4xl font-black text-[#4A3B32] text-center focus:ring-4 focus:ring-[#F4A261]/20 focus:border-[#F4A261] transition-all outline-none" required inputmode="decimal">
                    </div>
                    
                    <div class="bg-[#FFF0D4] p-1.5 rounded-2xl flex">
                        <select id="inp-type" onchange="updateCategoryOptions()" class="bg-white rounded-xl shadow-sm w-24 text-center text-sm font-bold text-[#4A3B32] focus:outline-none py-3 border border-[#FFE8D6]">
                            <option value="expense">æ”¯å‡º</option>
                            <option value="income">æ”¶å…¥</option>
                        </select>
                        <select id="inp-category" class="flex-1 bg-transparent px-4 text-sm font-bold text-[#4A3B32] focus:outline-none text-center"></select>
                        <button type="button" onclick="addCustomCategory()" class="px-3 text-[#E76F51] font-black text-lg hover:bg-white/50 rounded-lg">+</button>
                    </div>

                    <div class="flex gap-3">
                        <input type="date" id="inp-date" class="bg-white border-2 border-[#FFE8D6] rounded-2xl px-4 py-3.5 text-sm font-bold text-[#4A3B32] w-1/3 focus:border-[#F4A261] outline-none">
                        <input type="text" id="inp-title" placeholder="å‚™è¨»..." class="flex-1 bg-white border-2 border-[#FFE8D6] rounded-2xl px-4 py-3.5 text-sm font-bold text-[#4A3B32] focus:border-[#F4A261] outline-none placeholder-[#D7CCC8]">
                    </div>

                    <div class="flex gap-3">
                        <input type="file" id="inp-photo" accept="image/*" onchange="handlePhotoSelect(event)" class="hidden">
                        <label for="inp-photo" id="btn-camera" class="w-full border-2 border-dashed border-[#F4A261]/50 bg-[#FFF8E1] rounded-2xl py-3 flex items-center justify-center gap-2 text-[#F4A261] cursor-pointer hover:bg-[#F4A261] hover:text-white transition">
                            <span class="text-xl">ğŸ“·</span><span class="text-xs font-bold">æ‹å¼µç…§</span>
                        </label>
                        <div id="preview-container" class="hidden relative w-full h-24">
                            <img id="img-preview" class="w-full h-full object-cover rounded-2xl border-2 border-[#F4A261]">
                            <button type="button" onclick="clearPhoto()" class="absolute -top-2 -right-2 bg-[#E76F51] text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-md">Ã—</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="friend-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-start justify-start fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleFriendModal()"></div><div id="friend-panel" class="bg-[#FFFCF5] w-4/5 max-w-sm h-full p-6 flex flex-col relative z-10 slide-in-left shadow-2xl rounded-r-[2rem] transition-transform duration-200" style="touch-action: pan-y;"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-[#4A3B32]">æŸ´å‹åˆ—è¡¨</h2><div class="flex gap-2"><button onclick="loadFriends(true)" class="text-[#2A9D8F] text-sm font-bold bg-[#E0F2F1] px-2 py-1 rounded-lg">ğŸ”„ åˆ·æ–°</button><button onclick="toggleFriendModal()" class="text-[#8D6E63] text-xl font-bold bg-[#FFE8D6] w-8 h-8 rounded-full">Ã—</button></div></div><div class="mb-6 bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] shadow-sm"><label class="text-xs font-bold text-[#F4A261] block mb-2 uppercase tracking-wide">åŠ å…¥å¥½å‹ (è¼¸å…¥ ID)</label><div class="flex gap-2"><input type="tel" maxlength="6" id="friend-id-input" placeholder="000000" class="flex-1 min-w-0 bg-[#FFF8E1] border-none rounded-xl px-4 py-3 text-lg font-mono font-bold tracking-widest text-center text-[#4A3B32] outline-none focus:ring-2 focus:ring-[#F4A261]"><button onclick="addFriend()" class="shrink-0 bg-[#F4A261] text-white px-4 rounded-xl text-lg font-bold hover:bg-[#E76F51] transition shadow-md">+</button></div></div><div class="flex-1 overflow-y-auto space-y-2 h-full" id="friend-list-container"><div class="text-center text-[#8D6E63] text-xs mt-10">è¼‰å…¥ä¸­...</div></div></div></div>
        <div id="daily-bonus-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-6 fade-in backdrop-blur-sm"><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl scale-in relative border-4 border-[#F4A261]"><div class="absolute -top-12 left-1/2 -translate-x-1/2 bg-[#FFF0D4] w-24 h-24 rounded-full flex items-center justify-center border-4 border-[#F4A261] shadow-md"><span class="text-5xl animate-coin">ğŸ¦´</span></div><h2 class="text-2xl font-black text-[#4A3B32] mt-10 mb-1">æ¯æ—¥ç°½åˆ°æˆåŠŸï¼</h2><p class="text-[#8D6E63] text-sm font-bold mb-6">é€£çºŒç™»å…¥ç¬¬ <span id="streak-days" class="text-[#E76F51] text-lg">1</span> å¤©</p><div class="bg-[#FFF8E1] rounded-2xl p-4 mb-6 border-2 border-[#FFE8D6]"><div class="text-xs text-[#F4A261] font-bold uppercase tracking-wider mb-1">ç²å¾—çå‹µ</div><div class="text-4xl font-black text-[#4A3B32] flex items-center justify-center gap-2">+<span id="bonus-amount">10</span> ğŸ¦´</div></div><div class="flex justify-between items-end mb-6 px-2 h-16"><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-2 rounded-t-sm" id="bar-1"></div><span class="text-[10px] font-bold text-[#BDBDBD]">1å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-4 rounded-t-sm" id="bar-2"></div><span class="text-[10px] font-bold text-[#BDBDBD]">2å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-6 rounded-t-sm" id="bar-3"></div><span class="text-[10px] font-bold text-[#BDBDBD]">3å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-8 rounded-t-sm" id="bar-4"></div><span class="text-[10px] font-bold text-[#BDBDBD]">4å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-10 rounded-t-sm" id="bar-5"></div><span class="text-[10px] font-bold text-[#BDBDBD]">5+</span></div></div><button onclick="closeBonusModal()" class="w-full bg-[#F4A261] text-white font-black py-3.5 rounded-xl shadow-[0_4px_0_#E76F51] active:shadow-none active:translate-y-1 transition-all hover:bg-[#E76F51]">é–‹å¿ƒæ”¶ä¸‹ï¼</button></div></div>
        <div id="detail-modal" class="fixed inset-0 bg-[#4A3B32]/60 z-50 hidden flex items-center justify-center p-4 fade-in backdrop-blur-sm" onclick="closeDetailModal()"><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl scale-in relative flex flex-col max-h-[90vh]" onclick="event.stopPropagation()"><div class="relative w-full bg-[#FFE8D6] aspect-square group shrink-0"><img id="detail-img" src="" class="w-full h-full object-cover"><div id="detail-no-img" class="hidden w-full h-full flex flex-col items-center justify-center bg-[#FFF0D4] text-[#F4A261]"><span class="text-8xl" id="detail-icon">ğŸ•</span><span class="text-sm font-bold mt-4 text-[#8D6E63]">æ²’æœ‰ç…§ç‰‡</span></div><button onclick="closeDetailModal()" class="absolute top-4 right-4 bg-white/80 text-[#4A3B32] w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-md shadow-md font-bold">âœ•</button></div><div class="p-6 flex-1 overflow-y-auto no-scrollbar"><div class="flex justify-between items-start mb-2"><div><span id="detail-date" class="text-xs font-bold text-[#8D6E63] uppercase tracking-wide bg-[#FFE8D6] px-2 py-0.5 rounded-md">...</span><h2 id="detail-title" class="text-xl font-black text-[#4A3B32] mt-2">...</h2></div><div id="detail-amount" class="text-2xl font-black text-[#4A3B32]">...</div></div><div class="flex items-center gap-2 mb-6"><span id="detail-category" class="bg-[#F4A261]/20 text-[#E76F51] px-3 py-1 rounded-lg text-xs font-bold">...</span><span id="detail-type" class="text-xs font-bold text-[#8D6E63]">...</span></div><div id="detail-actions" class="grid grid-cols-2 gap-3 mb-6 hidden"><button onclick="editCurrentDetail()" class="flex-1 bg-[#FFF0D4] text-[#4A3B32] py-3.5 rounded-xl font-bold hover:bg-[#FFE8D6] transition">âœ ç·¨è¼¯</button><button onclick="deleteCurrentDetail()" class="flex-1 bg-white border-2 border-[#FFCDD2] text-[#E76F51] py-3.5 rounded-xl font-bold hover:bg-[#FFEBEE] transition">ğŸ—‘ï¸ åˆªé™¤</button></div><div class="border-t border-[#FFE8D6] pt-4"><div class="text-xs font-bold text-[#F4A261] mb-2 uppercase tracking-wider">ç•™è¨€æ¿</div><div id="detail-comments-list" class="space-y-3 mb-4 min-h-[60px]"></div><div class="flex gap-2"><input type="text" id="detail-comment-input" placeholder="èªªé»å¥½è½çš„..." class="flex-1 bg-white border border-[#FFE8D6] rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[#F4A261] shadow-sm"><button onclick="submitDetailComment()" class="bg-[#F4A261] text-white rounded-xl px-4 font-bold shadow-[0_3px_0_#E76F51] active:shadow-none active:translate-y-1 transition hover:bg-[#E76F51]">å‚³é€</button></div></div></div></div></div>
        
        <div id="profile-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-center justify-center fade-in p-6 backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleProfileModal()"></div><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-6 relative z-10 shadow-2xl scale-95 transition-transform duration-200 border-4 border-white"><div class="flex flex-col items-center mb-6"><div class="relative"><img id="profile-avatar" src="./Shiba Logo.png" class="w-24 h-24 rounded-full border-[6px] border-white shadow-lg mb-4 object-cover bg-white"><label id="profile-camera-btn" for="inp-profile-photo" class="absolute bottom-4 right-0 bg-[#4A3B32] text-white p-2 rounded-full shadow-md cursor-pointer hover:bg-[#F4A261] transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></label><input type="file" id="inp-profile-photo" accept="image/*" onchange="handleProfilePhotoSelect(event)" class="hidden"></div><div class="text-xs font-bold text-[#8D6E63] uppercase tracking-widest mb-1">ID</div><div id="profile-short-id" class="font-mono font-black text-3xl text-[#F4A261] tracking-wider mb-1 select-all">...</div><div id="profile-email" class="text-xs text-[#8D6E63] font-bold">...</div></div><div class="space-y-3"><input type="text" id="profile-name-input" class="w-full bg-white border-2 border-[#FFE8D6] rounded-xl px-4 py-3 text-sm font-bold text-center outline-none focus:border-[#F4A261]" placeholder="é¡¯ç¤ºåç¨±"><div id="profile-actions" class="space-y-3"><button onclick="saveProfile()" class="w-full bg-[#F4A261] hover:bg-[#E76F51] text-white font-bold py-3.5 rounded-xl shadow-md transition">å„²å­˜è®Šæ›´</button><button onclick="window.setMoney(10000)" class="w-full bg-green-100 text-green-600 font-bold py-3.5 rounded-xl hover:bg-green-200 transition border-2 border-green-200">ğŸ’° é ˜å–æ¸¬è©¦ç¶“è²»</button><button onclick="logout()" class="w-full bg-white border-2 border-[#FFCDD2] text-[#E76F51] font-bold py-3.5 rounded-xl hover:bg-[#FFEBEE] transition">ç™»å‡ºå¸³è™Ÿ</button></div><div id="profile-friend-actions" class="hidden space-y-3"><button id="btn-view-ledger" onclick="" class="w-full bg-[#F4A261] text-white font-black py-4 rounded-xl shadow-[0_4px_0_#E76F51] active:translate-y-1 active:shadow-none transition hover:bg-[#E76F51]">ğŸ“– æŸ¥çœ‹ä»–çš„å¸³æœ¬</button><button onclick="toggleProfileModal()" class="w-full bg-[#FFE8D6] text-[#8D6E63] font-bold py-3 rounded-xl hover:bg-[#F4A261] hover:text-white transition">é—œé–‰</button></div></div></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, deleteDoc, updateDoc, doc, getDoc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQRVE28OmopT1v6hybciDaigW4-9GaVzY", authDomain: "fma-cloud.firebaseapp.com", projectId: "fma-cloud", storageBucket: "fma-cloud.firebasestorage.app", messagingSenderId: "496004687854", appId: "1:496004687854:web:fb40424dabe2f1566a10ff", measurementId: "G-MTPV76EV3R" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();
        const DEFAULT_AVATAR = './Shiba Logo.png';
        
        let audioCtx, bgmGainNode, bgmSource;
        let globalBGMVolume = 0.5; let globalSFXVolume = 0.5; let isMusicPlaying = false;

        window.initAudio = () => { if (!audioCtx) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); bgmGainNode = audioCtx.createGain(); bgmGainNode.gain.value = globalBGMVolume; bgmGainNode.connect(audioCtx.destination); const bgMusic = document.getElementById('bg-music'); bgmSource = audioCtx.createMediaElementSource(bgMusic); bgmSource.connect(bgmGainNode); } if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playPop = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); };
        const playBark = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15); };
        const playCoin = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); };
        window.startApp = () => { window.initAudio(); const overlay = document.getElementById('start-overlay'); overlay.classList.add('opacity-0', 'pointer-events-none'); const bgMusic = document.getElementById('bg-music'); bgMusic.play().then(() => { isMusicPlaying = true; const btn = document.getElementById('music-btn'); btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); }).catch(e => console.log("Play failed:", e)); if(currentUser) document.getElementById('app-screen').classList.remove('hidden'); else document.getElementById('login-screen').classList.remove('hidden'); };
        window.toggleMusic = () => { const bgMusic = document.getElementById('bg-music'); const btn = document.getElementById('music-btn'); if(!audioCtx) window.initAudio(); if (isMusicPlaying) { bgMusic.pause(); btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); isMusicPlaying = false; } else { bgMusic.play().then(() => { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); isMusicPlaying = true; }); } };
        window.toggleSettingsModal = () => document.getElementById('settings-modal').classList.toggle('hidden');
        window.updateBGMVolume = (val) => { globalBGMVolume = parseFloat(val); if(bgmGainNode) bgmGainNode.gain.value = globalBGMVolume; document.getElementById('bgm-val-display').innerText = Math.round(globalBGMVolume * 100) + '%'; const btn = document.getElementById('music-btn'); if(globalBGMVolume === 0) { btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); } else if(isMusicPlaying) { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); } };
        window.updateSFXVolume = (val) => { globalSFXVolume = parseFloat(val); document.getElementById('sfx-val-display').innerText = Math.round(globalSFXVolume * 100) + '%'; playPop(); };
        document.addEventListener('click', (e) => { if((e.target.closest('button') || e.target.closest('.cursor-pointer')) && e.target.type !== 'range') { playPop(); } });
        
        const friendPanel = document.getElementById('friend-panel'); let friendStartX = 0; let friendStartY = 0; let isFriendClosing = false; let isScrollingList = false; 
        friendPanel.addEventListener('touchstart', (e) => { friendStartX = e.touches[0].clientX; friendStartY = e.touches[0].clientY; isFriendClosing = false; isScrollingList = false; friendPanel.style.transition = 'none'; }, {passive: true}); 
        friendPanel.addEventListener('touchmove', (e) => { if (isScrollingList) return; const currentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const xDiff = currentX - friendStartX; const yDiff = currentY - friendStartY; if (isFriendClosing || (xDiff < -10 && Math.abs(xDiff) > Math.abs(yDiff))) { if (e.cancelable) e.preventDefault(); isFriendClosing = true; friendPanel.style.transform = `translateX(${xDiff}px)`; } else if (Math.abs(yDiff) > Math.abs(xDiff)) { isScrollingList = true; } }, {passive: false}); 
        friendPanel.addEventListener('touchend', (e) => { if (isFriendClosing) { const xDiff = e.changedTouches[0].clientX - friendStartX; if (xDiff < -100) toggleFriendModal(); else { friendPanel.style.transition = 'transform 0.3s ease-out'; friendPanel.style.transform = ''; } } isFriendClosing = false; isScrollingList = false; });
        
        const storePanel = document.getElementById('store-panel'); let storeStartX = 0; let storeStartY = 0; let isStoreClosing = false; let isStoreScrolling = false; 
        storePanel.addEventListener('touchstart', (e) => { storeStartX = e.touches[0].clientX; storeStartY = e.touches[0].clientY; isStoreClosing = false; isStoreScrolling = false; storePanel.style.transition = 'none'; }, {passive: true}); 
        storePanel.addEventListener('touchmove', (e) => { if (isStoreScrolling) return; const currentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const xDiff = currentX - storeStartX; const yDiff = currentY - storeStartY; if (isStoreClosing || (xDiff > 10 && Math.abs(xDiff) > Math.abs(yDiff))) { if (e.cancelable) e.preventDefault(); isStoreClosing = true; storePanel.style.transform = `translateX(${xDiff}px)`; } else if (Math.abs(yDiff) > Math.abs(xDiff)) { isStoreScrolling = true; } }, {passive: false}); 
        storePanel.addEventListener('touchend', (e) => { if (isStoreClosing) { const xDiff = e.changedTouches[0].clientX - storeStartX; if (xDiff > 100) toggleStoreModal(); else { storePanel.style.transition = 'transform 0.3s ease-out'; storePanel.style.transform = ''; } } isStoreClosing = false; isStoreScrolling = false; });
        
        let globalStartX = 0; let globalStartY = 0; 
        document.addEventListener('touchstart', e => { globalStartX = e.changedTouches[0].screenX; globalStartY = e.changedTouches[0].screenY; }, false); 
        document.addEventListener('touchend', e => { 
            let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; let xDiff = touchEndX - globalStartX; let yDiff = touchEndY - globalStartY; 
            if (Math.abs(xDiff) > Math.abs(yDiff) && Math.abs(xDiff) > 50) { 
                if(document.getElementById('friend-modal').classList.contains('hidden') && document.getElementById('store-modal').classList.contains('hidden') && document.getElementById('input-modal').classList.contains('hidden')) { 
                    if (xDiff > 0) toggleFriendModal(); 
                } 
            } 
        }, false);

        const lockScroll = () => document.body.style.overflow = 'hidden'; const unlockScroll = () => document.body.style.overflow = '';
        let currentUser=null, currentViewUid=null, transactions=[], unsubscribe=null, currentDetailId=null, friendUnsubscribe=null;
        let myShortId=null, myProfileData=null, editingId=null, currentPhotoData=null, currentProfilePhotoData=null, myChart=null;
        let shibaMood = 100; let myInventory = {}; 
        let userUnsubscribe = null; // ğŸ”¥ ç”¨ä¾†å­˜å„²ä½¿ç”¨è€…ç›£è½å™¨

        const defaultCategories = { expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'], income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'] };
        let userCustomCategories = { expense: [], income: [] };
        const categoryIcons = { 'é¤é£²': 'ğŸ”', 'äº¤é€š': 'ğŸš—', 'è³¼ç‰©': 'ğŸ›ï¸', 'å¨›æ¨‚': 'ğŸ®', 'å±…ä½': 'ğŸ ', 'é†«ç™‚': 'ğŸ’Š', 'æ•™è‚²': 'ğŸ“š', 'å…¶ä»–': 'âœ¨', 'è–ªè³‡': 'ğŸ’°', 'çé‡‘': 'ğŸ§§', 'æŠ•è³‡': 'ğŸ“ˆ', 'å…¼è·': 'ğŸ’¼' };

        const inpAmount = document.getElementById('inp-amount'); const inpType = document.getElementById('inp-type'); const inpCategory = document.getElementById('inp-category'); const inpDate = document.getElementById('inp-date'); const inpTitle = document.getElementById('inp-title');
        inpDate.valueAsDate = new Date(); document.getElementById('filter-month').value = new Date().toISOString().slice(0, 7);

        document.getElementById('btn-google-login').addEventListener('click', () => { signInWithPopup(auth, provider).catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message)); });
        window.logout = () => { if(confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) signOut(auth); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user; currentViewUid = user.uid;
                await ensureUserHasId(user); await loadCustomCategories(user);
                
                // ğŸ”¥ å•Ÿå‹•å³æ™‚ç›£è½å™¨ï¼šåªè¦è³‡æ–™åº«æœ‰è®Šå‹•ï¼Œé¦¬ä¸Šæ›´æ–° UI
                startUserListener(user.uid);

                if (document.getElementById('start-overlay').classList.contains('opacity-0')) {
                    document.getElementById('app-screen').classList.remove('hidden');
                    document.getElementById('login-screen').classList.add('hidden');
                }
                loadDataRealtime(user.uid); window.loadFriends(true); updateViewMode(); await checkDailyBonus(user.uid); initMoodSystem(); 
                // applyInventoryEffects(); // é€™è£¡ä¸ç”¨å‘¼å«ï¼Œç›£è½å™¨æœƒè™•ç†
                setTimeout(() => triggerShibaReaction("æ­¡è¿å›ä¾†ï¼Œä¸»äººï¼æ±ªï¼"), 1500);
            } else {
                if (document.getElementById('start-overlay').classList.contains('opacity-0')) {
                    document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('app-screen').classList.add('hidden');
                }
                if(unsubscribe) unsubscribe();
                if(userUnsubscribe) userUnsubscribe(); // ç™»å‡ºæ™‚é—œé–‰ç›£è½
            }
        });

        // ğŸ”¥ å…¨æ–°ç›£è½å™¨å‡½å¼
        function startUserListener(uid) {
            if(userUnsubscribe) userUnsubscribe();
            userUnsubscribe = onSnapshot(doc(db, "users", uid), (docSnap) => {
                if (docSnap.exists()) {
                    myProfileData = docSnap.data();
                    
                    // 1. æ›´æ–°éª¨é ­å¹£é¡¯ç¤º
                    const coinEl = document.getElementById('store-coin-count');
                    if(coinEl) coinEl.innerText = myProfileData.boneCoins || 0;

                    // 2. æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹ (é€™å°±æ˜¯è§£æ±º BUG çš„é—œéµ)
                    if(!document.getElementById('store-modal').classList.contains('hidden')) {
                        updateStoreButtons();
                    }

                    // 3. æ›´æ–°èƒŒåŒ…ç‰¹æ•ˆ
                    applyInventoryEffects();

                    // 4. æ›´æ–°å¿ƒæƒ…
                    shibaMood = myProfileData.mood || 100;
                    updateMoodUI();
                }
            });
        }

        window.initMoodSystem = () => {
            const now = Date.now(); const lastUpdate = myProfileData.lastMoodUpdate || now; const hoursPassed = Math.floor((now - lastUpdate) / 3600000);
            if(hoursPassed > 0) { const deduct = hoursPassed * 5; shibaMood = Math.max(0, (myProfileData.mood || 100) - deduct); updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, lastMoodUpdate: now }); } else { shibaMood = myProfileData.mood || 100; }
            updateMoodUI();
            setInterval(() => { const currentNow = Date.now(); const last = myProfileData.lastMoodUpdate || currentNow; if (currentNow - last >= 3600000) { shibaMood = Math.max(0, shibaMood - 5); updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, lastMoodUpdate: currentNow }); updateMoodUI(); } }, 60000);
        };
        window.updateMoodUI = () => { const bar = document.getElementById('mood-bar'); bar.style.width = `${shibaMood}%`; if(shibaMood <= 20) bar.style.backgroundColor = '#9D4EDD'; else if(shibaMood <= 50) bar.style.backgroundColor = '#48CAE4'; else bar.style.backgroundColor = '#FF7096'; };
        
        window.applyInventoryEffects = () => { 
            myInventory = myProfileData.inventory || {}; 
            const hatEl = document.getElementById('shiba-hat');
            const shibaEl = document.getElementById('shiba-assistant');
            
            if(myInventory.hat) hatEl.classList.remove('hidden'); 
            else hatEl.classList.add('hidden'); 
            
            if(myInventory.black) shibaEl.classList.add('black-shiba-filter'); 
            else shibaEl.classList.remove('black-shiba-filter'); 
        };
        
        window.toggleStoreModal = async () => { 
            const modal = document.getElementById('store-modal'); const panel = document.getElementById('store-panel');
            const isHidden = modal.classList.contains('hidden'); 
            if (isHidden) { 
                // æ‰“é–‹æ™‚ï¼Œå…¶å¯¦ç›£è½å™¨å·²ç¶“æº–å‚™å¥½è³‡æ–™äº†ï¼Œç›´æ¥æ›´æ–°UIå³å¯
                if (myProfileData) {
                    document.getElementById('store-coin-count').innerText = myProfileData.boneCoins || 0; 
                    updateStoreButtons(); 
                }
                modal.classList.remove('hidden'); lockScroll();
            } else { modal.classList.add('hidden'); panel.style.transform = ''; unlockScroll(); } 
        };

        function updateStoreButtons() { 
            const inv = myProfileData.inventory || {}; const today = new Date().toDateString(); const lastMeat = myProfileData.lastMeatDate; 
            
            const meatBtn = document.getElementById('btn-buy-meat'); 
            if(lastMeat === today) { meatBtn.classList.add('sold-out'); meatBtn.innerText = "ä»Šæ—¥å·²é”ä¸Šé™"; meatBtn.disabled = true; } 
            else { meatBtn.classList.remove('sold-out'); meatBtn.innerText = "50 ğŸ¦´ è³¼è²·"; meatBtn.disabled = false; } 
            
            const hatBtn = document.getElementById('btn-buy-hat');
            if(inv.hat) { hatBtn.classList.add('sold-out'); hatBtn.innerText = "å·²æ“æœ‰"; hatBtn.disabled = true; }
            else { hatBtn.classList.remove('sold-out'); hatBtn.innerText = "200 ğŸ¦´ è³¼è²·"; hatBtn.disabled = false; }
            
            const blackBtn = document.getElementById('btn-buy-black');
            if(inv.black) { blackBtn.classList.add('sold-out'); blackBtn.innerText = "å·²æ“æœ‰"; blackBtn.disabled = true; }
            else { blackBtn.classList.remove('sold-out'); blackBtn.innerText = "500 ğŸ¦´ è³¼è²·"; blackBtn.disabled = false; }
            
            const noadsBtn = document.getElementById('btn-buy-noads');
            if(inv.noads) { noadsBtn.classList.add('sold-out'); noadsBtn.innerText = "å·²æ“æœ‰"; noadsBtn.disabled = true; }
            else { noadsBtn.classList.remove('sold-out'); noadsBtn.innerText = "1000 ğŸ¦´ è³¼è²·"; noadsBtn.disabled = false; }
        }

        window.buyItem = async (price, itemType) => {
            // é˜²å‘†æª¢æŸ¥ï¼šå¦‚æœå·²ç¶“æœ‰äº†ï¼Œç›´æ¥æ“‹ä¸‹ä¾†
            if(itemType !== 'meat' && myProfileData.inventory && myProfileData.inventory[itemType]) return;

            if (myProfileData.boneCoins < price) return triggerShibaReaction("éª¨é ­å¹£ä¸å¤ å•¦ï¼å¿«å»è¨˜å¸³ï¼(æ°£)");
            
            let confirmMsg = `ç¢ºå®šèŠ±è²» ${price} éª¨é ­å¹£è³¼è²·å—ï¼Ÿ`;
            if(itemType === 'meat') confirmMsg += "\n(å¿ƒæƒ…å°‡æ¢å¾©è‡³ 100)";
            
            if(!confirm(confirmMsg)) return;

            const userRef = doc(db, "users", currentUser.uid);
            let updates = { boneCoins: increment(-price) };
            let msg = "è³¼è²·æˆåŠŸï¼";

            if(itemType === 'meat') {
                updates.mood = 100;
                updates.lastMeatDate = new Date().toDateString();
                msg = "å¿ƒæƒ…è£œæ»¿äº†ï¼å¥½å¥½åƒï¼(æ±ª!)";
            } else {
                let invKey = "inventory." + itemType;
                updates[invKey] = true;
                
                if(itemType === 'hat') msg = "å¸¶ä¸Šæ–°å¸½å­äº†ï¼å¸¥å—ï¼Ÿ";
                if(itemType === 'black') msg = "è®Šèº«é»‘æŸ´ï¼å¸¥æ°£åº¦+100ï¼";
                if(itemType === 'noads') msg = "å»£å‘Šæ¶ˆå¤±äº†ï¼æ¸…çˆ½ï¼";
            }

            try {
                // é€™è£¡åªè¦æ›´æ–°è³‡æ–™åº«ï¼Œç›£è½å™¨æœƒè‡ªå‹•å¹«æˆ‘å€‘æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                await updateDoc(userRef, updates);
                playCoin(); 
                triggerShibaReaction(msg); 
            } catch (e) {
                alert("è³¼è²·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        };

        window.closeBonusModal = () => document.getElementById('daily-bonus-modal').classList.add('hidden');
        const shibaEl = document.getElementById('shiba-assistant'); const speechEl = document.getElementById('shiba-speech'); let speechTimeout; const normalMessages = ["æ±ªï¼ä»Šå¤©èŠ±äº†å¤šå°‘éŒ¢ï¼Ÿ", "éª¨é ­å¹£ä¸å¤ ç”¨äº†å—ï¼Ÿ", "æˆ‘æ˜¯ä¸æ˜¯å¾ˆå¯æ„›ï¼ŸğŸ•", "åŠªåŠ›å­˜éŒ¢è²·ç½ç½ï¼", "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼"]; const sadMessages = ["ä¸»äºº...ä½ ä¸æ„›æˆ‘äº†å—ï¼Ÿ(å—š)", "è‚šå­å¥½é¤“...æƒ³åƒç½ç½...", "å¥½ä¹…æ²’æ‘¸æ‘¸æˆ‘äº†...", "æˆ‘å¥½ç„¡èŠ...é™ªæˆ‘ç©...", "æ˜¯ä¸æ˜¯æŠŠæˆ‘å¿˜è¨˜äº†ï¼Ÿ"];
        window.triggerShibaClick = async () => { 
            playBark(); shibaEl.classList.remove('animate-shiba-float'); void shibaEl.offsetWidth; shibaEl.classList.add('animate-shiba-bounce'); setTimeout(() => { shibaEl.classList.remove('animate-shiba-bounce'); shibaEl.classList.add('animate-shiba-float'); }, 400); 
            const today = new Date().toDateString(); if(myProfileData.lastPetDate !== today) { myProfileData.dailyPetCount = 0; myProfileData.lastPetDate = today; }
            let msg = "";
            if((myProfileData.dailyPetCount || 0) < 4) { shibaMood = Math.min(100, shibaMood + 5); myProfileData.dailyPetCount = (myProfileData.dailyPetCount || 0) + 1; await updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, dailyPetCount: myProfileData.dailyPetCount, lastPetDate: today }); updateMoodUI(); const heart = document.createElement('div'); heart.classList.add('animate-heart'); heart.innerText = 'â¤ï¸'; heart.style.left = '50%'; heart.style.bottom = '100%'; document.getElementById('shiba-assistant-container').appendChild(heart); setTimeout(() => heart.remove(), 1000); }
            const pool = shibaMood <= 50 ? sadMessages : normalMessages; msg = pool[Math.floor(Math.random() * pool.length)]; showSpeechBubble(msg); 
        };
        function triggerShibaReaction(message) { shibaEl.classList.remove('animate-shiba-float'); void shibaEl.offsetWidth; shibaEl.classList.add('animate-shiba-bounce'); setTimeout(() => { shibaEl.classList.remove('animate-shiba-bounce'); shibaEl.classList.add('animate-shiba-float'); }, 400); showSpeechBubble(message); }
        function showSpeechBubble(text) { clearTimeout(speechTimeout); speechEl.innerText = text; speechEl.classList.remove('hidden'); speechTimeout = setTimeout(() => { speechEl.classList.add('hidden'); }, 3000); }
        window.toggleFriendModal = () => { const modal = document.getElementById('friend-modal'); const panel = document.getElementById('friend-panel'); const isHidden = modal.classList.contains('hidden'); if (isHidden) { modal.classList.remove('hidden'); lockScroll(); loadFriends(true); } else { modal.classList.add('hidden'); panel.style.transform = ''; unlockScroll(); } };
        
        window.loadFriends = (force = false) => {
            if (!currentUser) return;
            if (friendUnsubscribe && !force) return;
            if (friendUnsubscribe) friendUnsubscribe();
            
            const el = document.getElementById('friend-list-container');
            el.innerHTML = ''; 
            
            // å„ªå…ˆæ¸²æŸ“è‡ªå·±
            const me = document.createElement('div');
            me.className = `p-4 rounded-2xl flex items-center gap-3 cursor-pointer ${currentViewUid===currentUser.uid ? 'bg-[#FFF0D4] border-2 border-[#F4A261]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`;
            const myPhoto = myProfileData?.photo || DEFAULT_AVATAR;
            me.innerHTML = `<img src="${myPhoto}" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div class="font-bold text-[#4A3B32]">æˆ‘çš„ç›¸ç°¿</div>`;
            me.onclick = () => { switchView(currentUser.uid, 'æˆ‘çš„å¸³æœ¬'); toggleFriendModal(); };
            el.appendChild(me);

            const q = query(collection(db, "users", currentUser.uid, "friends"));
            friendUnsubscribe = onSnapshot(q, (snapshot) => {
                while(el.children.length > 1) { el.removeChild(el.lastChild); }

                snapshot.forEach(doc => {
                    try {
                        const f = doc.data();
                        const div = document.createElement('div');
                        div.className = `p-4 rounded-2xl flex items-center justify-between cursor-pointer mt-2 ${currentViewUid===f.uid ? 'bg-[#E1F5FE] border-2 border-[#81D4FA]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`;
                        const fName = f.name || "ç¥ç§˜æŸ´å‹"; const fPhoto = f.photo || DEFAULT_AVATAR; const fId = f.shortId || "???";
                        
                        div.innerHTML = `<div class="flex items-center gap-3 flex-1"><img src="${fPhoto}" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div><div class="font-bold text-sm text-[#4A3B32]">${fName}</div><div class="text-xs text-[#8D6E63]">ID: ${fId}</div></div></div><button id="del-btn-${f.uid}" class="text-[#8D6E63] hover:text-[#E76F51] p-2">Ã—</button>`;
                        
                        div.onclick = (e) => { 
                            if(e.target.id !== `del-btn-${f.uid}`) openUserProfile(f.uid); 
                        };
                        
                        setTimeout(() => {
                            document.getElementById(`del-btn-${f.uid}`).onclick = (e) => {
                                e.stopPropagation();
                                deleteFriend(f.uid);
                            };
                        }, 0);

                        el.appendChild(div);
                    } catch(e) { console.error(e); }
                });
            }, (error) => {
                console.error(error);
                const errDiv = document.createElement('div');
                errDiv.innerText = "è®€å–å¤±æ•—";
                errDiv.className = "text-center text-red-400 mt-4 text-xs";
                el.appendChild(errDiv);
            });
        };

        window.updateUI = () => { const listEl = document.getElementById('transaction-list'); const mode = document.getElementById('filter-type').value; const filterDate = mode === 'day' ? document.getElementById('filter-day').value : mode === 'month' ? document.getElementById('filter-month').value : document.getElementById('filter-year').value; const filtered = transactions.filter(t => { const d = new Date(t.dateTimestamp); const iso = d.toISOString().split('T')[0]; if(mode==='day') return iso===filterDate; if(mode==='month') return iso.slice(0,7)===filterDate; if(mode==='year') return String(d.getFullYear())===filterDate; return true; }); listEl.innerHTML = ''; let inc=0, exp=0, expData={}; if(filtered.length===0) document.getElementById('empty-state').classList.remove('hidden'); else document.getElementById('empty-state').classList.add('hidden'); filtered.forEach(t => { if(t.type==='income') inc+=Number(t.amount); else { exp+=Number(t.amount); expData[t.category]=(expData[t.category]||0)+Number(t.amount); } const div = document.createElement('div'); div.className = "aspect-square rounded-2xl overflow-hidden relative cursor-pointer border-2 border-white shadow-sm hover:scale-95 transition bg-white"; if(t.photo) { div.innerHTML = `<img src="${t.photo}" class="w-full h-full object-cover">`; } else { const isInc = t.type==='income'; const colorClass = isInc ? 'bg-[#E0F2F1] text-[#2A9D8F]' : 'bg-[#FFEBEE] text-[#E76F51]'; const icon = categoryIcons[t.category] || 'âœ¨'; div.innerHTML = `<div class="w-full h-full ${colorClass} flex flex-col items-center justify-center p-2 text-center"><span class="text-4xl mb-1 filter drop-shadow-sm">${icon}</span><span class="text-[10px] font-black truncate w-full">${t.category}</span><span class="text-[10px] font-bold mt-0.5 opacity-80">$${t.amount}</span></div>`; } if(t.photo) { div.innerHTML += `<div class="absolute bottom-0 right-0 bg-[#4A3B32]/60 backdrop-blur-sm text-white text-[10px] font-bold px-2 py-0.5 rounded-tl-lg border-t border-l border-white/20">$${t.amount}</div>`; } div.onclick = () => openDetailModal(t.id); listEl.appendChild(div); }); document.getElementById('display-balance').innerText=(inc-exp).toLocaleString(); document.getElementById('display-income').innerText=inc.toLocaleString(); document.getElementById('display-expense').innerText=exp.toLocaleString(); renderChart(expData); };
        window.openDetailModal = (id) => { const t = transactions.find(x => x.id === id); if(!t) return; currentDetailId = id; document.getElementById('detail-title').innerText = t.title || t.category; document.getElementById('detail-amount').innerText = `$ ${Number(t.amount).toLocaleString()}`; document.getElementById('detail-amount').className = t.type==='income' ? 'text-2xl font-black text-[#2A9D8F]' : 'text-2xl font-black text-[#E76F51]'; document.getElementById('detail-date').innerText = t.date; document.getElementById('detail-category').innerText = t.category; document.getElementById('detail-type').innerText = t.type==='income'?'æ”¶å…¥':'æ”¯å‡º'; const imgEl = document.getElementById('detail-img'); const noImgEl = document.getElementById('detail-no-img'); const detailIconEl = document.getElementById('detail-icon'); if(t.photo) { imgEl.src = t.photo; imgEl.classList.remove('hidden'); noImgEl.classList.add('hidden'); } else { imgEl.classList.add('hidden'); noImgEl.classList.remove('hidden'); detailIconEl.innerText = categoryIcons[t.category] || 'ğŸ•'; } const actionsEl = document.getElementById('detail-actions'); if(currentViewUid === currentUser.uid) actionsEl.classList.remove('hidden'); else actionsEl.classList.add('hidden'); renderDetailComments(t); document.getElementById('detail-modal').classList.remove('hidden'); };
        window.closeDetailModal = () => document.getElementById('detail-modal').classList.add('hidden');
        window.editCurrentDetail = () => { window.closeDetailModal(); window.editTransaction(currentDetailId); };
        window.deleteCurrentDetail = () => { if(confirm('åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) { window.deleteTransactionCloud(currentDetailId); window.closeDetailModal(); }};
        function renderDetailComments(t) { const list = document.getElementById('detail-comments-list'); list.innerHTML = ''; const comms = (t.comments||[]).filter(c => Date.now()-c.timestamp < 86400000); if(comms.length===0) list.innerHTML = '<div class="text-xs text-[#8D6E63] text-center py-4 bg-[#FFF8E1] rounded-xl border border-[#FFE8D6]">âœ¨ é‚„æ²’æœ‰ç•™è¨€ï¼Œæ¶é ­é¦™ï¼</div>'; comms.forEach(c => { const d = document.createElement('div'); d.className="text-sm bg-white border border-[#FFE8D6] p-3 rounded-xl mb-1 shadow-sm"; d.innerHTML = `<span class="font-bold text-[#F4A261] mr-1">${c.authorName}:</span><span class="text-[#4A3B32]">${c.text}</span>`; list.appendChild(d); }); }
        window.submitDetailComment = async () => { const txt = document.getElementById('detail-comment-input').value.trim(); if(!txt) return; const ref = doc(db,"users",currentViewUid,"transactions",currentDetailId); const snap = await getDoc(ref); let arr = snap.data().comments || []; arr.push({text:txt, authorName:myProfileData.name, timestamp:Date.now()}); await updateDoc(ref, {comments:arr}); document.getElementById('detail-comment-input').value=''; renderDetailComments({...snap.data(), comments:arr}); };
        async function ensureUserHasId(user) { const ref = doc(db, "users", user.uid); const snap = await getDoc(ref); const userPhoto = user.photoURL || DEFAULT_AVATAR; if(snap.exists()) { const d = snap.data(); myShortId = d.shortId; myProfileData = {...d, photo: d.photo || userPhoto}; if (myProfileData.boneCoins === undefined) { await updateDoc(ref, { boneCoins: 100 }); myProfileData.boneCoins = 100; } if (myProfileData.mood === undefined) { await updateDoc(ref, { mood: 100 }); myProfileData.mood = 100; } if (!myProfileData.inventory) myProfileData.inventory = {}; } else { let id = Math.floor(100000 + Math.random()*900000).toString(); const newData = { shortId: id, name: user.displayName, email: user.email, photo: userPhoto, boneCoins: 100, mood: 100, inventory: {} }; await setDoc(doc(db, "public_codes", id), {uid: user.uid, email: user.email, photo: userPhoto}); await setDoc(ref, newData); myShortId = id; myProfileData = newData; } document.getElementById('my-short-id').innerText = `ID: ${myShortId}`; document.getElementById('profile-short-id').innerText = myShortId; document.getElementById('profile-email').innerText = user.email; document.getElementById('profile-name-input').value = myProfileData.name; document.getElementById('profile-avatar').src = myProfileData.photo; }
        function loadDataRealtime(targetUid) { if(unsubscribe) unsubscribe(); const q = query(collection(db, "users", targetUid, "transactions"), orderBy("dateTimestamp", "desc")); unsubscribe = onSnapshot(q, (snap) => { transactions = snap.docs.map(d => ({id: d.id, ...d.data()})); const years = new Set([new Date().getFullYear()]); transactions.forEach(t => years.add(new Date(t.dateTimestamp).getFullYear())); const ySelect = document.getElementById('filter-year'); const currY = ySelect.value; ySelect.innerHTML = Array.from(years).sort((a,b)=>b-a).map(y => `<option value="${y}">${y} å¹´</option>`).join(''); if(currY) ySelect.value = currY; updateUI(); }, (error) => { console.error("è®€å–å¤±æ•—:", error); alert("è®€å–æ¬Šé™ä¸è¶³ï¼Œè«‹ç¢ºèªå°æ–¹å·²åŠ ä½ ç‚ºå¥½å‹"); }); }
        
        window.openInputModal = () => { 
            try {
                if(!editingId) window.resetForm(); 
                
                const panel = document.getElementById('input-panel');
                const modal = document.getElementById('input-modal');
                
                // 1. é¡¯ç¤ºé®ç½©
                modal.classList.remove('hidden'); 
                
                // 2. é–å®šèƒŒæ™¯æ»¾å‹•
                lockScroll(); 

            } catch(e) {
                console.error("é–‹å•Ÿè¨˜å¸³è¦–çª—å¤±æ•—:", e);
                alert("é–‹å•Ÿå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢è©¦è©¦");
                unlockScroll(); 
                document.getElementById('input-modal').classList.add('hidden');
            }
        };

        window.closeInputModal = () => { 
            const panel = document.getElementById('input-panel');
            const modal = document.getElementById('input-modal');
            
            modal.classList.add('hidden'); // ç›´æ¥éš±è—ï¼Œä¸åšé›¢å ´å‹•ç•«é¿å…å¡ä½
            window.resetForm(); 
            unlockScroll(); 
        };

        window.triggerSubmit = () => { document.getElementById('transaction-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true})); };
        
        window.resetForm = () => { 
            editingId = null; 
            const titleEl = document.getElementById('form-title');
            if(titleEl) titleEl.innerText = "è¨˜ä¸€ç­†"; 
            
            document.getElementById('inp-amount').value = ''; 
            document.getElementById('inp-title').value = ''; 
            
            try { document.getElementById('inp-date').valueAsDate = new Date(); } catch(e) { console.log(e); }
            
            window.clearPhoto(); 
        };

        window.editTransaction = (id) => { const tx = transactions.find(t => t.id === id); if (!tx) return; editingId = id; inpTitle.value = tx.title; inpAmount.value = tx.amount; inpType.value = tx.type; updateCategoryOptions(); inpCategory.value = tx.category; inpDate.valueAsDate = new Date(tx.dateTimestamp); currentPhotoData = tx.photo || null; if (currentPhotoData) { document.getElementById('img-preview').src = currentPhotoData; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); } else window.clearPhoto(); document.getElementById('form-title').innerText = "ç·¨è¼¯"; window.openInputModal(); };
        document.getElementById('transaction-form').addEventListener('submit', async (e) => { e.preventDefault(); if(currentViewUid !== currentUser.uid) return alert("åªèƒ½ç·¨è¼¯è‡ªå·±çš„å¸³æœ¬å–”"); const amount = Number(inpAmount.value); if(amount <= 0) return alert("é‡‘é¡éŒ¯èª¤"); const data = { amount, type: inpType.value, category: inpCategory.value, title: inpTitle.value.trim() || inpCategory.value, dateTimestamp: inpDate.valueAsDate.getTime(), date: inpDate.valueAsDate.toLocaleDateString(), photo: currentPhotoData }; try { if(editingId) { await updateDoc(doc(db, "users", currentUser.uid, "transactions", editingId), data); } else { await addDoc(collection(db, "users", currentUser.uid, "transactions"), data); await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: increment(10) }); myProfileData.boneCoins += 10; triggerShibaReaction("è¨˜å¸³æˆåŠŸï¼éª¨é ­å¹£ +10ï¼(é–‹å¿ƒ)"); playCoin(); } window.closeInputModal(); } catch(e) { alert("éŒ¯èª¤: " + e.message); } });
        window.deleteTransactionCloud = async (id) => { await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id)); };
        
        window.changeFilterMode = () => { const mode = document.getElementById('filter-type').value; document.getElementById('filter-day').classList.add('hidden'); document.getElementById('filter-month').classList.add('hidden'); document.getElementById('filter-year').classList.add('hidden'); if(mode === 'day') document.getElementById('filter-day').classList.remove('hidden'); if(mode === 'month') document.getElementById('filter-month').classList.remove('hidden'); if(mode === 'year') document.getElementById('filter-year').classList.remove('hidden'); updateUI(); }
        async function loadCustomCategories(user) { const s = await getDoc(doc(db, "users", user.uid)); if(s.exists() && s.data().customCategories) userCustomCategories = s.data().customCategories; updateCategoryOptions(); }
        window.updateCategoryOptions = () => { const type = inpType.value; const cats = [...defaultCategories[type], ...(userCustomCategories[type]||[])]; inpCategory.innerHTML = cats.map(c => { const icon = categoryIcons[c] || 'âœ¨'; return `<option value="${c}">${icon} ${c}</option>`; }).join(''); }
        window.addCustomCategory = async () => { const n = prompt("æ–°åˆ†é¡åç¨±:"); if(n) { const t = inpType.value; if(!userCustomCategories[t]) userCustomCategories[t] = []; userCustomCategories[t].push(n); await setDoc(doc(db, "users", currentUser.uid), {customCategories: userCustomCategories}, {merge:true}); updateCategoryOptions(); inpCategory.value = n; } }
        document.getElementById('filter-day').addEventListener('input', updateUI); document.getElementById('filter-month').addEventListener('input', updateUI); document.getElementById('filter-year').addEventListener('change', updateUI);
        
        Chart.register(ChartDataLabels);
        function renderChart(data) { const ctx = document.getElementById('expenseChart').getContext('2d'); const legendContainer = document.getElementById('chart-legend'); const lbs = Object.keys(data); const vals = Object.values(data); if(myChart) myChart.destroy(); if(lbs.length === 0) { document.getElementById('chart-placeholder').classList.remove('hidden'); legendContainer.innerHTML = ''; return; } document.getElementById('chart-placeholder').classList.add('hidden'); const colors = ['#F4A261','#E76F51','#E9C46A','#2A9D8F','#264653','#8D6E63','#F4D35E','#DA627D']; myChart = new Chart(ctx, { type: 'doughnut', data: { labels: lbs, datasets: [{ data: vals, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } } } }); const total = vals.reduce((a, b) => a + b, 0); legendContainer.innerHTML = lbs.map((label, i) => { const val = vals[i]; const percent = Math.round((val / total) * 100); const color = colors[i % colors.length]; const icon = categoryIcons[label] || 'âœ¨'; return `<div class="flex items-center justify-between"><div class="flex items-center gap-1.5 min-w-0"><div class="w-2.5 h-2.5 rounded-full shrink-0" style="background-color: ${color}"></div><span class="truncate font-bold text-[#4A3B32]">${icon} ${label}</span></div><div class="text-[#8D6E63] font-mono shrink-0">${percent}%</div></div>`; }).join(''); }

        window.toggleChart = () => { document.getElementById('chart-container').classList.toggle('hidden'); }
        window.toggleFriendModal = () => document.getElementById('friend-modal').classList.toggle('hidden');
        window.toggleProfileModal = () => document.getElementById('profile-modal').classList.toggle('hidden');
        window.handlePhotoSelect = (e) => processImage(e.target.files[0], (data) => { currentPhotoData = data; document.getElementById('img-preview').src = data; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); });
        window.handleProfilePhotoSelect = (e) => processImage(e.target.files[0], (data) => { currentProfilePhotoData = data; document.getElementById('profile-avatar').src = data; });
        function processImage(file, cb) { if(!file) return; const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); const scale = 600/i.width; c.width = 600; c.height = i.height*scale; c.getContext('2d').drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/jpeg', 0.6)); }; i.src = e.target.result; }; r.readAsDataURL(file); }
        window.clearPhoto = () => { document.getElementById('inp-photo').value=''; currentPhotoData=null; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('btn-camera').classList.remove('hidden'); };
        window.saveProfile = async () => { await updateDoc(doc(db,"users",currentUser.uid), {name:document.getElementById('profile-name-input').value, photo:currentProfilePhotoData}); alert('å·²å„²å­˜'); window.toggleProfileModal(); };
        window.toggleStoreModal = async () => { const modal = document.getElementById('store-modal'); const isHidden = modal.classList.contains('hidden'); if (isHidden) { const userRef = doc(db, "users", currentUser.uid); const snap = await getDoc(userRef); if (snap.exists()) { myProfileData.boneCoins = snap.data().boneCoins || 0; document.getElementById('store-coin-count').innerText = myProfileData.boneCoins; } modal.classList.remove('hidden'); } else { modal.classList.add('hidden'); } };
        window.buyItem = async (price, itemName) => { if (myProfileData.boneCoins >= price) { if(confirm(`ç¢ºå®šèŠ±è²» ${price} éª¨é ­å¹£è³¼è²· ${itemName} å—ï¼Ÿ`)) { await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: increment(-price) }); myProfileData.boneCoins -= price; document.getElementById('store-coin-count').innerText = myProfileData.boneCoins; triggerShibaReaction(`è¬è¬æƒ é¡§ï¼ä½ è²·äº† ${itemName} (æ±ª!)`); playCoin(); } } else { triggerShibaReaction("éª¨é ­å¹£ä¸å¤ å•¦ï¼å¿«å»è¨˜å¸³ï¼(æ°£)"); } };
        window.setMoney = async (amount) => { if (!currentUser) return alert("è«‹å…ˆç™»å…¥"); try { await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: Number(amount) }); if(myProfileData) myProfileData.boneCoins = Number(amount); const storeCountEl = document.getElementById('store-coin-count'); if(storeCountEl) storeCountEl.innerText = amount; alert(`ğŸ¶ æ¸¬è©¦æ¨¡å¼ï¼šéª¨é ­å¹£å·²ä¿®æ”¹ç‚º ${amount}`); } catch (e) { console.error(e); alert("ä¿®æ”¹å¤±æ•—"); } };
        
        window.openUserProfile = async (targetUid) => {
            let userData = null;
            if(targetUid === currentUser.uid) {
                userData = myProfileData;
            } else {
                const snap = await getDoc(doc(db, "users", targetUid));
                if(snap.exists()) userData = snap.data();
            }

            if(!userData) return alert("æŸ¥ç„¡æ­¤äºº");

            document.getElementById('profile-avatar').src = userData.photo || DEFAULT_AVATAR;
            document.getElementById('profile-short-id').innerText = userData.shortId || "???";
            document.getElementById('profile-email').innerText = userData.email || "";
            document.getElementById('profile-name-input').value = userData.name || "";

            const isMe = (targetUid === currentUser.uid);
            const nameInput = document.getElementById('profile-name-input');
            const cameraBtn = document.getElementById('profile-camera-btn');
            const myActions = document.getElementById('profile-actions');
            const friendActions = document.getElementById('profile-friend-actions');
            const viewLedgerBtn = document.getElementById('btn-view-ledger');

            if(isMe) {
                nameInput.disabled = false; 
                cameraBtn.classList.remove('hidden'); 
                myActions.classList.remove('hidden'); 
                friendActions.classList.add('hidden'); 
            } else {
                nameInput.disabled = true; 
                cameraBtn.classList.add('hidden'); 
                myActions.classList.add('hidden'); 
                friendActions.classList.remove('hidden'); 
                
                viewLedgerBtn.onclick = () => {
                    switchView(targetUid, userData.name);
                    toggleProfileModal(); 
                };
            }

            const modal = document.getElementById('profile-modal');
            if(modal.classList.contains('hidden')) modal.classList.remove('hidden');
        };

        window.switchView = (uid, name) => { 
            currentViewUid = uid; 
            const isMe = uid === currentUser.uid;
            
            document.getElementById('header-title').innerText = isMe ? 'æˆ‘çš„ç›¸ç°¿' : `${name} çš„ç›¸ç°¿`;
            document.getElementById('current-view-label').innerText = isMe ? 'å€‹äºº' : 'å¥½å‹';
            
            const header = document.querySelector('header');
            if (isMe) {
                header.classList.remove('bg-[#E1F5FE]/95');
                header.classList.add('bg-[#FFFCF5]/95');
                document.getElementById('header-title').classList.remove('text-[#0277BD]');
                document.getElementById('header-title').classList.add('text-[#4A3B32]');
            } else {
                header.classList.remove('bg-[#FFFCF5]/95');
                header.classList.add('bg-[#E1F5FE]/95');
                document.getElementById('header-title').classList.remove('text-[#4A3B32]');
                document.getElementById('header-title').classList.add('text-[#0277BD]'); 
            }

            updateViewMode(); 
            loadDataRealtime(uid); 
            document.getElementById('friend-modal').classList.add('hidden'); 
        }
        function updateViewMode() { const isMe = currentViewUid === currentUser.uid; document.getElementById('fab-btn').classList.toggle('hidden', !isMe); }
    </script>
</body>
</html>
