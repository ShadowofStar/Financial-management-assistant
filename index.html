<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ´ç®¡å®¶ - ç©©å®šå•Ÿå‹•ç‰ˆ v6.7</title>
    
    <link rel="icon" type="image/png" href="./Shiba Logo.png">
    <link rel="shortcut icon" href="./Shiba Logo.png">
    <link rel="apple-touch-icon" href="./Shiba Logo.png">
    <meta name="theme-color" content="#FFFCF5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/zh-tw.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: pan-y; user-select: none; overscroll-behavior-y: none; overflow-x: hidden; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        /* åŸºç¤å‹•ç•« */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* æŸ´çŠ¬æµ®å‹• */
        @keyframes shiba-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        .animate-shiba-float { animation: shiba-float 3s ease-in-out infinite; }
        @keyframes shiba-bounce { 0%, 100% { transform: scale(1) rotate(0deg); } 40% { transform: scale(1.15) rotate(5deg); } 80% { transform: scale(0.95) rotate(-3deg); } }
        .animate-shiba-bounce { animation: shiba-bounce 0.4s ease-out; }
        
        /* æ¿¾é¡èˆ‡æ¨£å¼ */
        .black-shiba-filter { filter: grayscale(100%) brightness(0.6) contrast(1.2); }
        .sold-out { opacity: 0.6 !important; pointer-events: none !important; background-color: #BDBDBD !important; color: #FFFFFF !important; box-shadow: none !important; border: none !important; cursor: not-allowed !important; }

        /* ğŸ”¥ å¼·åˆ¶è¦†è“‹é¡¯ç¤ºé¡åˆ¥ (è§£æ±ºé¡¯ç¤ºä¸å‡ºä¾†çš„å•é¡Œ) */
        .modal-hidden { display: none !important; }
        .modal-show { display: flex !important; animation: fadeIn 0.2s ease-out forwards; }
        
        /* Modal èƒŒæ™¯å±¤ç´šè¨­å®š */
        #friend-modal, #store-modal, #settings-modal, #detail-modal, #daily-bonus-modal, #profile-modal { z-index: 50; }
        #input-modal { z-index: 50; }
        #start-overlay { z-index: 100; }
        #login-screen { z-index: 90; }
    </style>

    <script>
        let audioCtx, bgmGainNode, bgmSource;
        let globalBGMVolume = 0.5; let globalSFXVolume = 0.5; let isMusicPlaying = false;

        // éŸ³æ•ˆåˆå§‹åŒ–
        window.initAudio = () => {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                bgmGainNode = audioCtx.createGain();
                bgmGainNode.gain.value = globalBGMVolume;
                bgmGainNode.connect(audioCtx.destination);
                const bgMusic = document.getElementById('bg-music');
                bgmSource = audioCtx.createMediaElementSource(bgMusic);
                bgmSource.connect(bgmGainNode);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        };

        window.playPop = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); };
        window.playBark = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15); };
        window.playCoin = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); };

        // ğŸ”¥ å•Ÿå‹• App (ä¿è­‰èƒ½é»)
        window.startApp = () => {
            window.initAudio();
            const overlay = document.getElementById('start-overlay');
            overlay.classList.add('hidden'); // ç›´æ¥éš±è—
            
            const bgMusic = document.getElementById('bg-music');
            bgMusic.play().then(() => {
                isMusicPlaying = true;
                const btn = document.getElementById('music-btn');
                if(btn) { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); }
            }).catch(e => console.log("Play failed:", e));

            // å¦‚æœ Firebase é‚„æ²’è¼‰å…¥å®Œï¼Œå…ˆé¡¯ç¤ºè¼‰å…¥ä¸­æˆ–ç™»å…¥é 
            // é€™è£¡å‡è¨­ Firebase onAuthStateChanged æœƒæ¥æ‰‹
            setTimeout(() => {
                if(document.getElementById('app-screen').classList.contains('hidden') && document.getElementById('login-screen').classList.contains('hidden')) {
                     document.getElementById('login-screen').classList.remove('hidden');
                     document.getElementById('login-screen').classList.add('modal-show');
                }
            }, 500);
        };

        window.toggleMusic = () => { const bgMusic = document.getElementById('bg-music'); const btn = document.getElementById('music-btn'); if(!audioCtx) window.initAudio(); if (isMusicPlaying) { bgMusic.pause(); btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); isMusicPlaying = false; } else { bgMusic.play().then(() => { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); isMusicPlaying = true; }); } };
        window.updateBGMVolume = (val) => { globalBGMVolume = parseFloat(val); if(bgmGainNode) bgmGainNode.gain.value = globalBGMVolume; document.getElementById('bgm-val-display').innerText = Math.round(globalBGMVolume * 100) + '%'; };
        window.updateSFXVolume = (val) => { globalSFXVolume = parseFloat(val); document.getElementById('sfx-val-display').innerText = Math.round(globalSFXVolume * 100) + '%'; window.playPop(); };

        // ğŸ”¥ è¬ç”¨è¦–çª—åˆ‡æ› (æœ€ç©©å®šçš„ display:none åˆ‡æ›)
        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            if (el.classList.contains('hidden') || el.classList.contains('modal-hidden')) {
                el.classList.remove('hidden', 'modal-hidden');
                el.classList.add('modal-show');
                // å¦‚æœæ˜¯ç‰¹å®šè¦–çª—ï¼Œè§¸ç™¼è¼‰å…¥
                if(id === 'friend-modal' && window.loadFriends) window.loadFriends(true);
                if(id === 'store-modal' && window.updateStoreButtons) window.updateStoreButtons();
            } else {
                el.classList.remove('modal-show');
                el.classList.add('modal-hidden');
            }
        };

        // é»æ“ŠéŸ³æ•ˆ
        document.addEventListener('click', (e) => { if((e.target.closest('button') || e.target.closest('.cursor-pointer')) && e.target.type !== 'range') { window.playPop(); } });
    </script>
</head>
<body class="bg-[#FFFCF5] text-[#4A3B32] min-h-screen selection:bg-[#F4A261] selection:text-white">

    <audio id="bg-music" loop crossorigin="anonymous">
        <source src="./[J&B No Copyright Music] Yummy Flavor Background Music.mp3" type="audio/mpeg">
    </audio>

    <div id="start-overlay" class="fixed inset-0 bg-[#FFFCF5] z-[100] flex flex-col items-center justify-center fade-in">
        <img src="./Shiba Logo.png" class="w-32 h-32 rounded-[2rem] shadow-xl mb-6 animate-shiba-float border-4 border-white">
        <h2 class="text-2xl font-black text-[#4A3B32] mb-2">æ­¡è¿ä¾†åˆ°æŸ´ç®¡å®¶</h2>
        <p class="text-[#8D6E63] text-sm font-bold mb-8">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•ŸéŸ³æ•ˆé«”é©— ğŸµ</p>
        <button onclick="startApp()" class="bg-[#F4A261] text-white text-lg font-black py-4 px-12 rounded-2xl shadow-[0_4px_0_#E76F51] active:translate-y-1 active:shadow-none transition-all animate-bounce">é€²å…¥ App</button>
    </div>

    <div id="login-screen" class="hidden fixed inset-0 bg-[#FFFCF5] z-[90] flex flex-col items-center justify-center p-6 text-center">
        <div class="relative"><div class="absolute -inset-4 bg-[#F4A261] rounded-full opacity-20 blur-xl"></div><img src="./Shiba Logo.png" class="relative w-32 h-32 rounded-[2rem] shadow-xl mb-6 object-cover border-4 border-white"></div>
        <h1 class="text-3xl font-black text-[#4A3B32] mb-2 tracking-tight">æŸ´ç®¡å®¶</h1><p class="text-[#8D6E63] mb-10 font-bold">è®“è¨˜å¸³è®Šå¾—å¯æ„›åˆç°¡å–®</p>
        <button id="btn-google-login" class="w-full max-w-sm bg-white border-2 border-[#F4A261] text-[#4A3B32] font-bold py-4 px-4 rounded-2xl shadow-[0_4px_0_#F4A261] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center gap-3"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
    </div>

    <div id="app-screen" class="hidden max-w-md mx-auto min-h-screen bg-[#FFFCF5] relative overflow-hidden flex flex-col shadow-2xl">
        <header class="bg-[#FFFCF5]/95 px-5 pt-12 pb-2 flex items-center justify-between sticky top-0 z-30 backdrop-blur-md">
            <button onclick="toggleMusic()" id="music-btn" class="text-xl w-9 h-9 flex items-center justify-center rounded-full bg-[#FFF0D4] text-[#8D6E63] border-2 border-[#FFE8D6] shadow-sm transition active:scale-95">ğŸ”‡</button>
            <div class="flex flex-col items-center">
                <div class="flex items-center gap-2"><h1 id="header-title" class="text-2xl font-black text-[#4A3B32] tracking-tight">æˆ‘çš„ç›¸ç°¿</h1></div>
                <div class="flex items-center gap-1 mt-1 text-xs text-[#8D6E63] font-bold cursor-pointer bg-[#FFF0D4] px-2 py-1 rounded-lg w-fit transition active:scale-95" onclick="openUserProfile(currentViewUid)"><span id="current-view-label">å€‹äºº</span><span class="text-[#F4A261]">|</span><span id="my-short-id" class="font-mono">ID...</span></div>
            </div>
            <div class="flex gap-2">
                <div class="bg-white border-2 border-[#FFE8D6] p-0.5 rounded-xl flex text-xs font-bold relative shadow-sm">
                    <select id="filter-type" onchange="changeFilterMode()" class="bg-transparent appearance-none px-2 py-1.5 text-[#8D6E63] focus:outline-none z-10 relative cursor-pointer"><option value="day">æ—¥</option><option value="month" selected>æœˆ</option><option value="year">å¹´</option><option value="all">å…¨</option></select>
                    <div class="pr-1 text-[#F4A261]">â–¼</div>
                    <input type="month" id="filter-month" class="absolute inset-0 opacity-0 cursor-pointer"><input type="date" id="filter-day" class="absolute inset-0 opacity-0 cursor-pointer hidden"><select id="filter-year" class="absolute inset-0 opacity-0 cursor-pointer hidden"></select>
                </div>
                <button onclick="toggleModal('settings-modal')" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border-2 border-[#FFE8D6] text-[#8D6E63] shadow-sm active:scale-95 text-lg">âš™ï¸</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-32 no-scrollbar" id="main-content">
            <div class="px-5 mt-2 mb-4">
                <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border-2 border-[#FFE8D6] flex justify-between items-center relative overflow-hidden" onclick="toggleChart()">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#FFF0D4] rounded-full opacity-50"></div>
                    <div class="relative z-10"><div class="text-[10px] text-[#8D6E63] font-bold uppercase tracking-wider mb-1">æœ¬æœˆçµé¤˜</div><div class="text-3xl font-black text-[#4A3B32] flex items-baseline"><span class="text-sm font-bold mr-1 text-[#F4A261]">$</span><span id="display-balance">0</span></div></div>
                    <div class="flex gap-4 text-right relative z-10"><div><div class="text-[10px] text-[#8D6E63] mb-0.5">æ”¶</div><div class="font-bold text-[#2A9D8F] text-sm" id="display-income">0</div></div><div><div class="text-[10px] text-[#8D6E63] mb-0.5">æ”¯</div><div class="font-bold text-[#E76F51] text-sm" id="display-expense">0</div></div></div>
                </div>
                <div id="chart-container" class="hidden bg-white mt-2 rounded-[1.5rem] p-4 border-2 border-[#FFE8D6] fade-in"><div class="flex items-center gap-3"><div class="w-[45%] h-32 relative"><canvas id="expenseChart"></canvas><p id="chart-placeholder" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#8D6E63] text-xs font-bold">ç„¡æ•¸æ“š</p></div><div id="chart-legend" class="w-[55%] space-y-1.5 max-h-32 overflow-y-auto text-xs pr-1"></div></div></div>
            </div>
            <div id="transaction-list" class="grid grid-cols-3 gap-1.5 px-3"></div>
            <div id="empty-state" class="hidden py-16 text-center"><img src="./Shiba Logo.png" class="w-20 h-20 mx-auto mb-4 opacity-40 grayscale rounded-2xl"><p class="text-[#8D6E63] text-sm font-bold">æ±ªï¼Ÿé€™è£¡æ²’æœ‰æ±è¥¿å–”</p><button onclick="toggleModal('input-modal')" class="mt-2 text-[#F4A261] text-xs font-bold hover:underline">å»è¨˜ä¸€ç­† (+10éª¨é ­å¹£)</button></div>
        </main>

        <div id="shiba-assistant-container" class="fixed bottom-[100px] right-4 z-20 pointer-events-auto group flex flex-col items-center">
             <div id="shiba-speech" class="hidden absolute bottom-full mb-3 right-0 bg-white p-3 rounded-2xl shadow-lg border-2 border-[#FFE8D6] text-xs font-black text-[#4A3B32] whitespace-nowrap scale-in origin-bottom-right">æ±ªï¼ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼<div class="absolute -bottom-1.5 right-6 w-3 h-3 bg-white border-b-2 border-r-2 border-[#FFE8D6] rotate-45"></div></div>
             <div class="relative" onclick="triggerShibaClick()">
                 <div id="shiba-hat" class="hidden absolute -top-8 left-1/2 -translate-x-1/2 text-5xl z-50 pointer-events-none drop-shadow-xl" style="transform: rotate(-10deg);">ğŸ©</div>
                 <img src="./Shiba Logo.png" id="shiba-assistant" class="w-20 h-20 rounded-full border-2 border-white shadow-md object-cover animate-shiba-float cursor-pointer hover:scale-105 transition-transform z-10 relative">
                 <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-white px-2 py-0.5 rounded-full border border-[#FFE8D6] shadow-sm flex items-center gap-1 z-30">
                     <span id="mood-icon" class="text-[10px]">â¤ï¸</span>
                     <div class="w-10 h-1.5 bg-[#E0E0E0] rounded-full overflow-hidden">
                         <div id="mood-bar" class="h-full bg-[#FF7096] w-full transition-all duration-500"></div>
                     </div>
                 </div>
             </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-md bg-[#FFFCF5]/95 backdrop-blur-md border-t-2 border-[#FFE8D6] pb-safe pt-2 px-8 flex justify-between items-end z-30 h-[88px] rounded-t-[2rem]">
            <button onclick="toggleModal('friend-modal')" class="flex flex-col items-center gap-1 w-16 pb-3 text-[#4A3B32] transition hover:scale-105 active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span class="text-[11px] font-black">å¥½å‹</span></button>
            <button id="fab-btn" onclick="toggleModal('input-modal')" class="mb-6 bg-[#F4A261] text-white rounded-2xl w-14 h-14 shadow-[0_6px_20px_rgba(244,162,97,0.4)] flex items-center justify-center transform transition active:scale-90 hover:bg-[#E76F51] hover:-translate-y-1 border-4 border-[#FFFCF5]"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg></button>
            <button onclick="toggleModal('store-modal')" class="flex flex-col items-center gap-1 w-16 pb-3 text-[#4A3B32] transition hover:scale-105 active:scale-95 group"><div class="relative"><svg class="w-6 h-6 group-hover:text-[#F4A261] transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg><div class="absolute -top-1 -right-1 w-2 h-2 bg-[#E76F51] rounded-full hidden"></div></div><span class="text-[11px] font-black group-hover:text-[#F4A261] transition">å•†åº—</span></button>
        </nav>

        <div id="settings-modal" class="hidden fixed inset-0 bg-[#4A3B32]/50 flex items-center justify-center p-6 fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleModal('settings-modal')"></div><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-6 relative z-10 shadow-2xl scale-in border-4 border-white"><div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-black text-[#4A3B32]">ç³»çµ±è¨­å®š</h2><button onclick="toggleModal('settings-modal')" class="text-[#8D6E63] text-xl font-bold bg-[#FFE8D6] w-8 h-8 rounded-full flex items-center justify-center">Ã—</button></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] mb-4"><div class="flex justify-between items-center mb-2"><span class="font-bold text-[#4A3B32] text-sm">ğŸµ èƒŒæ™¯éŸ³æ¨‚</span><span class="text-xs text-[#8D6E63] font-bold" id="bgm-val-display">50%</span></div><input type="range" min="0" max="1" step="0.05" value="0.5" oninput="updateBGMVolume(this.value)"></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] mb-6"><div class="flex justify-between items-center mb-2"><span class="font-bold text-[#4A3B32] text-sm">ğŸ”Š æŒ‰éˆ•éŸ³æ•ˆ</span><span class="text-xs text-[#8D6E63] font-bold" id="sfx-val-display">50%</span></div><input type="range" min="0" max="1" step="0.05" value="0.5" oninput="updateSFXVolume(this.value)"></div><div class="text-center text-xs text-[#8D6E63] opacity-60 font-bold">ShibaManager v6.7</div></div></div>
        
        <div id="store-modal" class="hidden fixed inset-0 bg-[#4A3B32]/50 flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleModal('store-modal')"></div>
            <div class="bg-[#FFFCF5] w-full max-w-sm h-[85vh] rounded-[2rem] flex flex-col relative z-10 scale-in shadow-2xl border-4 border-white">
                <div class="p-6 pb-2 flex justify-between items-center border-b-2 border-[#FFE8D6]"><div><h2 class="text-2xl font-black text-[#4A3B32]">æŸ´æŸ´é›œè²¨èˆ–</h2><p class="text-xs text-[#8D6E63] font-bold">æ¶ˆè²»è®“ç”Ÿæ´»æ›´ç¾å¥½</p></div><div class="bg-[#FFF0D4] px-3 py-1.5 rounded-xl flex items-center gap-2 border border-[#F4A261]"><span class="text-xl">ğŸ¦´</span><span id="store-coin-count" class="font-black text-[#F4A261] text-lg">0</span></div></div>
                <div class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 no-scrollbar">
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ¥©</div><h3 class="font-black text-[#4A3B32] mb-1">é«˜ç´šè‚‰ç½é ­</h3><p class="text-[10px] text-[#8D6E63] mb-3">å¿ƒæƒ…å…¨æ»¿ (é™1æ¬¡/æ—¥)</p><button id="btn-buy-meat" onclick="window.buyItem(50, 'meat', 'btn-buy-meat')" class="w-full bg-[#F4A261] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#E76F51] transition">50 ğŸ¦´ è³¼è²·</button></div>
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ©</div><h3 class="font-black text-[#4A3B32] mb-1">ç´³å£«å¸½å­</h3><p class="text-[10px] text-[#8D6E63] mb-3">æ°¸ä¹…è£é£¾ (é™1æ¬¡)</p><button id="btn-buy-hat" onclick="window.buyItem(200, 'hat', 'btn-buy-hat')" class="w-full bg-[#2A9D8F] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#264653] transition">200 ğŸ¦´ è³¼è²·</button></div>
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ•â€ğŸ¦º</div><h3 class="font-black text-[#4A3B32] mb-1">é»‘æŸ´ä¸»é¡Œ</h3><p class="text-[10px] text-[#8D6E63] mb-3">å¸¥æ°£é¢¨æ ¼ (é™1æ¬¡)</p><button id="btn-buy-black" onclick="window.buyItem(500, 'black', 'btn-buy-black')" class="w-full bg-[#4A3B32] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-black transition">500 ğŸ¦´ è³¼è²·</button></div>
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸš«</div><h3 class="font-black text-[#4A3B32] mb-1">å»é™¤å»£å‘Š</h3><p class="text-[10px] text-[#8D6E63] mb-3">æ°¸ä¹…æ¸…çˆ½ (é™1æ¬¡)</p><button id="btn-buy-noads" onclick="window.buyItem(1000, 'noads', 'btn-buy-noads')" class="w-full bg-[#E76F51] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-red-600 transition">1000 ğŸ¦´ è³¼è²·</button></div>
                </div>
                <div class="p-4 border-t border-[#FFE8D6]"><button onclick="toggleModal('store-modal')" class="w-full bg-[#FFE8D6] text-[#8D6E63] py-3 rounded-xl font-bold hover:bg-[#F4A261] hover:text-white transition">é—œé–‰å•†åº—</button></div>
            </div>
        </div>

        <div id="input-modal" class="hidden fixed inset-0 bg-[#4A3B32]/40 flex flex-col justify-end fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleModal('input-modal')"></div>
            <div id="input-panel" class="bg-[#FFFCF5] w-full rounded-t-[2.5rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] relative z-50 pb-safe">
                <div class="w-12 h-1.5 bg-[#FFE8D6] rounded-full mx-auto mb-6"></div>
                <div class="flex justify-between items-center mb-6"><button onclick="toggleModal('input-modal')" class="text-[#8D6E63] text-sm font-bold p-2 hover:bg-[#FFE8D6] rounded-lg">å–æ¶ˆ</button><h2 class="text-sm font-black text-[#F4A261] uppercase tracking-widest" id="form-title">è¨˜ä¸€ç­†</h2><button onclick="window.triggerSubmit()" class="text-[#E76F51] text-sm font-bold p-2 hover:bg-[#FFE8D6] rounded-lg">å®Œæˆ</button></div>
                <form id="transaction-form" class="flex flex-col gap-5"><div class="relative group"><span class="absolute left-6 top-1/2 -translate-y-1/2 text-2xl text-[#F4A261] font-bold">$</span><input type="number" id="inp-amount" placeholder="0" class="w-full bg-white border-2 border-[#FFE8D6] rounded-2xl py-4 pl-12 pr-4 text-4xl font-black text-[#4A3B32] text-center focus:ring-4 focus:ring-[#F4A261]/20 focus:border-[#F4A261] transition-all outline-none" required inputmode="decimal"></div><div class="bg-[#FFF0D4] p-1.5 rounded-2xl flex"><select id="inp-type" onchange="window.updateCategoryOptions()" class="bg-white rounded-xl shadow-sm w-24 text-center text-sm font-bold text-[#4A3B32] focus:outline-none py-3 border border-[#FFE8D6]"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select><select id="inp-category" class="flex-1 bg-transparent px-4 text-sm font-bold text-[#4A3B32] focus:outline-none text-center"></select><button type="button" onclick="window.addCustomCategory()" class="px-3 text-[#E76F51] font-black text-lg hover:bg-white/50 rounded-lg">+</button></div><div class="flex gap-3"><input type="date" id="inp-date" class="bg-white border-2 border-[#FFE8D6] rounded-2xl px-4 py-3.5 text-sm font-bold text-[#4A3B32] w-1/3 focus:border-[#F4A261] outline-none"><input type="text" id="inp-title" placeholder="å‚™è¨»..." class="flex-1 bg-white border-2 border-[#FFE8D6] rounded-2xl px-4 py-3.5 text-sm font-bold text-[#4A3B32] focus:border-[#F4A261] outline-none placeholder-[#D7CCC8]"></div><div class="flex gap-3"><input type="file" id="inp-photo" accept="image/*" onchange="window.handlePhotoSelect(event)" class="hidden"><label for="inp-photo" id="btn-camera" class="w-full border-2 border-dashed border-[#F4A261]/50 bg-[#FFF8E1] rounded-2xl py-3 flex items-center justify-center gap-2 text-[#F4A261] cursor-pointer hover:bg-[#F4A261] hover:text-white transition"><span class="text-xl">ğŸ“·</span><span class="text-xs font-bold">æ‹å¼µç…§</span></label><div id="preview-container" class="hidden relative w-full h-24"><img id="img-preview" class="w-full h-full object-cover rounded-2xl border-2 border-[#F4A261]"><button type="button" onclick="window.clearPhoto()" class="absolute -top-2 -right-2 bg-[#E76F51] text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-md">Ã—</button></div></div></form>
            </div>
        </div>

        <div id="friend-modal" class="hidden fixed inset-0 bg-[#4A3B32]/50 flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleModal('friend-modal')"></div>
            <div class="bg-[#FFFCF5] w-full max-w-sm h-[85vh] rounded-[2rem] flex flex-col relative z-10 scale-in shadow-2xl border-4 border-white">
                <div class="p-6 pb-2 flex justify-between items-center border-b-2 border-[#FFE8D6]">
                    <h2 class="text-2xl font-black text-[#4A3B32]">æŸ´å‹åˆ—è¡¨</h2>
                    <div class="flex gap-2"><button onclick="window.loadFriends(true)" class="text-[#2A9D8F] text-sm font-bold bg-[#E0F2F1] px-2 py-1 rounded-lg">ğŸ”„ åˆ·æ–°</button><button onclick="toggleModal('friend-modal')" class="text-[#8D6E63] text-xl font-bold bg-[#FFE8D6] w-8 h-8 rounded-full">Ã—</button></div>
                </div>
                <div class="mb-6 bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] shadow-sm"><label class="text-xs font-bold text-[#F4A261] block mb-2 uppercase tracking-wide">åŠ å…¥å¥½å‹ (è¼¸å…¥ ID)</label><div class="flex gap-2"><input type="tel" maxlength="6" id="friend-id-input" placeholder="000000" class="flex-1 min-w-0 bg-[#FFF8E1] border-none rounded-xl px-4 py-3 text-lg font-mono font-bold tracking-widest text-center text-[#4A3B32] outline-none focus:ring-2 focus:ring-[#F4A261]"><button onclick="window.addFriend()" class="shrink-0 bg-[#F4A261] text-white px-4 rounded-xl text-lg font-bold hover:bg-[#E76F51] transition shadow-md">+</button></div></div><div class="flex-1 overflow-y-auto space-y-2 h-full" id="friend-list-container"><div class="text-center text-[#8D6E63] text-xs mt-10">è¼‰å…¥ä¸­...</div></div>
            </div>
        </div>
        
        <div id="daily-bonus-modal" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 fade-in backdrop-blur-sm"><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl scale-in relative border-4 border-[#F4A261]"><div class="absolute -top-12 left-1/2 -translate-x-1/2 bg-[#FFF0D4] w-24 h-24 rounded-full flex items-center justify-center border-4 border-[#F4A261] shadow-md"><span class="text-5xl animate-coin">ğŸ¦´</span></div><h2 class="text-2xl font-black text-[#4A3B32] mt-10 mb-1">æ¯æ—¥ç°½åˆ°æˆåŠŸï¼</h2><p class="text-[#8D6E63] text-sm font-bold mb-6">é€£çºŒç™»å…¥ç¬¬ <span id="streak-days" class="text-[#E76F51] text-lg">1</span> å¤©</p><div class="bg-[#FFF8E1] rounded-2xl p-4 mb-6 border-2 border-[#FFE8D6]"><div class="text-xs text-[#F4A261] font-bold uppercase tracking-wider mb-1">ç²å¾—çå‹µ</div><div class="text-4xl font-black text-[#4A3B32] flex items-center justify-center gap-2">+<span id="bonus-amount">10</span> ğŸ¦´</div></div><div class="flex justify-between items-end mb-6 px-2 h-16"><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-2 rounded-t-sm" id="bar-1"></div><span class="text-[10px] font-bold text-[#BDBDBD]">1å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-4 rounded-t-sm" id="bar-2"></div><span class="text-[10px] font-bold text-[#BDBDBD]">2å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-6 rounded-t-sm" id="bar-3"></div><span class="text-[10px] font-bold text-[#BDBDBD]">3å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-8 rounded-t-sm" id="bar-4"></div><span class="text-[10px] font-bold text-[#BDBDBD]">4å¤©</span></div><div class="flex flex-col items-center gap-1 w-1/5"><div class="w-full bg-[#E0E0E0] h-10 rounded-t-sm" id="bar-5"></div><span class="text-[10px] font-bold text-[#BDBDBD]">5+</span></div></div><button onclick="window.closeBonusModal()" class="w-full bg-[#F4A261] text-white font-black py-3.5 rounded-xl shadow-[0_4px_0_#E76F51] active:shadow-none active:translate-y-1 transition-all hover:bg-[#E76F51]">é–‹å¿ƒæ”¶ä¸‹ï¼</button></div></div>
        <div id="detail-modal" class="hidden fixed inset-0 bg-[#4A3B32]/60 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm" onclick="toggleModal('detail-modal')"><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl scale-in relative flex flex-col max-h-[90vh]" onclick="event.stopPropagation()"><div class="relative w-full bg-[#FFE8D6] aspect-square group shrink-0"><img id="detail-img" src="" class="w-full h-full object-cover" onerror="this.src='./Shiba Logo.png'"><div id="detail-no-img" class="hidden w-full h-full flex flex-col items-center justify-center bg-[#FFF0D4] text-[#F4A261]"><span class="text-8xl" id="detail-icon">ğŸ•</span><span class="text-sm font-bold mt-4 text-[#8D6E63]">æ²’æœ‰ç…§ç‰‡</span></div><button onclick="toggleModal('detail-modal')" class="absolute top-4 right-4 bg-white/80 text-[#4A3B32] w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-md shadow-md font-bold">âœ•</button></div><div class="p-6 flex-1 overflow-y-auto no-scrollbar"><div class="flex justify-between items-start mb-2"><div><span id="detail-date" class="text-xs font-bold text-[#8D6E63] uppercase tracking-wide bg-[#FFE8D6] px-2 py-0.5 rounded-md">...</span><h2 id="detail-title" class="text-xl font-black text-[#4A3B32] mt-2">...</h2></div><div id="detail-amount" class="text-2xl font-black text-[#4A3B32]">...</div></div><div class="flex items-center gap-2 mb-6"><span id="detail-category" class="bg-[#F4A261]/20 text-[#E76F51] px-3 py-1 rounded-lg text-xs font-bold">...</span><span id="detail-type" class="text-xs font-bold text-[#8D6E63]">...</span></div><div id="detail-actions" class="grid grid-cols-2 gap-3 mb-6 hidden"><button onclick="window.editCurrentDetail()" class="flex-1 bg-[#FFF0D4] text-[#4A3B32] py-3.5 rounded-xl font-bold hover:bg-[#FFE8D6] transition">âœ ç·¨è¼¯</button><button onclick="window.deleteCurrentDetail()" class="flex-1 bg-white border-2 border-[#FFCDD2] text-[#E76F51] py-3.5 rounded-xl font-bold hover:bg-[#FFEBEE] transition">ğŸ—‘ï¸ åˆªé™¤</button></div><div class="border-t border-[#FFE8D6] pt-4"><div class="text-xs font-bold text-[#F4A261] mb-2 uppercase tracking-wider">ç•™è¨€æ¿</div><div id="detail-comments-list" class="space-y-3 mb-4 min-h-[60px]"></div><div class="flex gap-2"><input type="text" id="detail-comment-input" placeholder="èªªé»å¥½è½çš„..." class="flex-1 bg-white border border-[#FFE8D6] rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[#F4A261] shadow-sm"><button onclick="window.submitDetailComment()" class="bg-[#F4A261] text-white rounded-xl px-4 font-bold shadow-[0_3px_0_#E76F51] active:shadow-none active:translate-y-1 transition hover:bg-[#E76F51]">å‚³é€</button></div></div></div></div></div>
        <div id="profile-modal" class="hidden fixed inset-0 bg-[#4A3B32]/50 z-50 flex items-center justify-center fade-in p-6 backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleModal('profile-modal')"></div><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-6 relative z-10 shadow-2xl scale-in border-4 border-white"><div class="flex flex-col items-center mb-6"><div class="relative"><img id="profile-avatar" src="./Shiba Logo.png" class="w-24 h-24 rounded-full border-[6px] border-white shadow-lg mb-4 object-cover bg-white" onerror="this.src='./Shiba Logo.png'"><label id="profile-camera-btn" for="inp-profile-photo" class="absolute bottom-4 right-0 bg-[#4A3B32] text-white p-2 rounded-full shadow-md cursor-pointer hover:bg-[#F4A261] transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></label><input type="file" id="inp-profile-photo" accept="image/*" onchange="window.handleProfilePhotoSelect(event)" class="hidden"></div><div class="text-xs font-bold text-[#8D6E63] uppercase tracking-widest mb-1">ID</div><div id="profile-short-id" class="font-mono font-black text-3xl text-[#F4A261] tracking-wider mb-1 select-all">...</div><div id="profile-email" class="text-xs text-[#8D6E63] font-bold">...</div></div><div class="space-y-3"><input type="text" id="profile-name-input" class="w-full bg-white border-2 border-[#FFE8D6] rounded-xl px-4 py-3 text-sm font-bold text-center outline-none focus:border-[#F4A261]" placeholder="é¡¯ç¤ºåç¨±"><div id="profile-actions" class="space-y-3"><button onclick="window.saveProfile()" class="w-full bg-[#F4A261] hover:bg-[#E76F51] text-white font-bold py-3.5 rounded-xl shadow-md transition">å„²å­˜è®Šæ›´</button><button onclick="window.setMoney(10000)" class="w-full bg-green-100 text-green-600 font-bold py-3.5 rounded-xl hover:bg-green-200 transition border-2 border-green-200">ğŸ’° é ˜å–æ¸¬è©¦ç¶“è²»</button><button onclick="window.logout()" class="w-full bg-white border-2 border-[#FFCDD2] text-[#E76F51] font-bold py-3.5 rounded-xl hover:bg-[#FFEBEE] transition">ç™»å‡ºå¸³è™Ÿ</button></div><div id="profile-friend-actions" class="hidden space-y-3"><button id="btn-view-ledger" onclick="" class="w-full bg-[#F4A261] text-white font-black py-4 rounded-xl shadow-[0_4px_0_#E76F51] active:translate-y-1 active:shadow-none transition hover:bg-[#E76F51]">ğŸ“– æŸ¥çœ‹ä»–çš„å¸³æœ¬</button><button onclick="toggleModal('profile-modal')" class="w-full bg-[#FFE8D6] text-[#8D6E63] font-bold py-3 rounded-xl hover:bg-[#F4A261] hover:text-white transition">é—œé–‰</button></div></div></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, deleteDoc, updateDoc, doc, getDoc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQRVE28OmopT1v6hybciDaigW4-9GaVzY", authDomain: "fma-cloud.firebaseapp.com", projectId: "fma-cloud", storageBucket: "fma-cloud.firebasestorage.app", messagingSenderId: "496004687854", appId: "1:496004687854:web:fb40424dabe2f1566a10ff", measurementId: "G-MTPV76EV3R" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();
        const DEFAULT_AVATAR = './Shiba Logo.png';
        
        let currentUser=null, currentViewUid=null, transactions=[], unsubscribe=null, friendUnsubscribe=null;
        let myShortId=null, myProfileData=null, editingId=null, currentPhotoData=null, currentProfilePhotoData=null, myChart=null;
        let shibaMood = 100; let myInventory = {}; 

        const defaultCategories = { expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'], income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'] };
        let userCustomCategories = { expense: [], income: [] };
        const categoryIcons = { 'é¤é£²': 'ğŸ”', 'äº¤é€š': 'ğŸš—', 'è³¼ç‰©': 'ğŸ›ï¸', 'å¨›æ¨‚': 'ğŸ®', 'å±…ä½': 'ğŸ ', 'é†«ç™‚': 'ğŸ’Š', 'æ•™è‚²': 'ğŸ“š', 'å…¶ä»–': 'âœ¨', 'è–ªè³‡': 'ğŸ’°', 'çé‡‘': 'ğŸ§§', 'æŠ•è³‡': 'ğŸ“ˆ', 'å…¼è·': 'ğŸ’¼' };

        document.getElementById('btn-google-login').addEventListener('click', () => { signInWithPopup(auth, provider).catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message)); });
        window.logout = () => { if(confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) signOut(auth); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user; currentViewUid = user.uid;
                await ensureUserHasId(user); await loadCustomCategories(user);
                
                // éš±è—ç™»å…¥é  (ä½¿ç”¨é€šç”¨é¡åˆ¥)
                document.getElementById('login-screen').classList.remove('modal-show');
                document.getElementById('login-screen').classList.add('hidden');
                
                if (document.getElementById('app-screen').classList.contains('hidden')) {
                    document.getElementById('app-screen').classList.remove('hidden');
                    document.getElementById('start-overlay').classList.add('hidden'); // ç¢ºä¿å•Ÿå‹•é é—œé–‰
                }
                
                loadDataRealtime(user.uid); window.loadFriends(true); updateViewMode(); await checkDailyBonus(user.uid); 
                initMoodSystem(); applyInventoryEffects();
                setTimeout(() => window.playBark(), 1000);
            } else {
                if (document.getElementById('start-overlay').classList.contains('hidden')) {
                    document.getElementById('login-screen').classList.remove('hidden'); 
                    document.getElementById('login-screen').classList.add('modal-show');
                    document.getElementById('app-screen').classList.add('hidden');
                }
                if(unsubscribe) unsubscribe();
            }
        });

        // ... (çœç•¥éƒ¨åˆ†è¼”åŠ©å‡½æ•¸ï¼Œç›´æ¥ç¶å®šé—œéµåŠŸèƒ½) ...
        
        // ç¶å®šåˆ° window è®“å¤–éƒ¨ script å¯å‘¼å«
        window.loadFriends = (force = false) => {
            if (!currentUser) return;
            if (friendUnsubscribe && !force) return;
            if (friendUnsubscribe) friendUnsubscribe();
            
            const el = document.getElementById('friend-list-container');
            el.innerHTML = ''; // æ¸…é™¤æ–‡å­—
            
            // æ°¸é å…ˆé¡¯ç¤ºè‡ªå·±
            const me = document.createElement('div');
            me.className = `p-4 rounded-2xl flex items-center gap-3 cursor-pointer ${currentViewUid===currentUser.uid ? 'bg-[#FFF0D4] border-2 border-[#F4A261]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`;
            const myPhoto = myProfileData?.photo || DEFAULT_AVATAR;
            me.innerHTML = `<img src="${myPhoto}" onerror="this.src='${DEFAULT_AVATAR}'" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div class="font-bold text-[#4A3B32]">æˆ‘çš„ç›¸ç°¿</div>`;
            me.onclick = () => { window.switchView(currentUser.uid, 'æˆ‘çš„å¸³æœ¬'); window.toggleModal('friend-modal'); };
            el.appendChild(me);

            const q = query(collection(db, "users", currentUser.uid, "friends"));
            friendUnsubscribe = onSnapshot(q, (snapshot) => {
                while(el.children.length > 1) { el.removeChild(el.lastChild); } // ä¿ç•™è‡ªå·±

                snapshot.forEach(doc => {
                    try {
                        const f = doc.data();
                        const div = document.createElement('div');
                        div.className = `p-4 rounded-2xl flex items-center justify-between cursor-pointer mt-2 ${currentViewUid===f.uid ? 'bg-[#E1F5FE] border-2 border-[#81D4FA]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`;
                        const fName = f.name || "ç¥ç§˜æŸ´å‹"; const fPhoto = f.photo || DEFAULT_AVATAR; const fId = f.shortId || "???";
                        
                        div.innerHTML = `<div class="flex items-center gap-3 flex-1"><img src="${fPhoto}" onerror="this.src='${DEFAULT_AVATAR}'" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div><div class="font-bold text-sm text-[#4A3B32]">${fName}</div><div class="text-xs text-[#8D6E63]">ID: ${fId}</div></div></div><div class="flex gap-2"><button id="btn-view-${f.uid}" class="text-2xl p-1 hover:scale-110 transition">ğŸ“–</button><button id="del-btn-${f.uid}" class="text-[#8D6E63] hover:text-[#E76F51] p-2">Ã—</button></div>`;
                        
                        // ç¶å®šäº‹ä»¶
                        div.onclick = (e) => { if(e.target.tagName !== 'BUTTON') window.openUserProfile(f.uid); };
                        
                        setTimeout(() => {
                             document.getElementById(`btn-view-${f.uid}`).onclick = (e) => { e.stopPropagation(); window.switchView(f.uid, fName); };
                             document.getElementById(`del-btn-${f.uid}`).onclick = (e) => { e.stopPropagation(); window.deleteFriend(f.uid); };
                        }, 0);

                        el.appendChild(div);
                    } catch(e) { console.error(e); }
                });
            });
        };

        window.buyItem = async (price, itemType, btnId) => {
            const btn = document.getElementById(btnId);
            if(btn.disabled) return;

            if (!myProfileData.inventory) myProfileData.inventory = {}; 
            if (itemType !== 'meat' && myProfileData.inventory[itemType]) return alert('å·²ç¶“æ“æœ‰æ­¤ç‰©å“å›‰ï¼');
            if (itemType === 'meat' && myProfileData.lastMeatDate === new Date().toDateString()) return alert('ä»Šå¤©å·²ç¶“åƒéå¤§é¤äº†ï¼');
            if (myProfileData.boneCoins < price) return alert("éª¨é ­å¹£ä¸å¤ å•¦ï¼");
            
            if(!confirm(`ç¢ºå®šèŠ±è²» ${price} éª¨é ­å¹£è³¼è²·å—ï¼Ÿ`)) return;

            btn.innerText = "è™•ç†ä¸­...";
            btn.disabled = true;

            // æ¨‚è§€æ›´æ–°
            if(itemType === 'meat') { shibaMood = 100; myProfileData.lastMeatDate = new Date().toDateString(); } 
            else { myProfileData.inventory[itemType] = true; }
            myProfileData.boneCoins -= price;
            
            document.getElementById('store-coin-count').innerText = myProfileData.boneCoins;
            window.updateStoreButtons();
            
            // DB
            const userRef = doc(db, "users", currentUser.uid);
            let updates = { boneCoins: increment(-price) };
            if(itemType === 'meat') { updates.mood = 100; updates.lastMeatDate = new Date().toDateString(); }
            else { updates.inventory = myProfileData.inventory; }

            await updateDoc(userRef, updates);
            window.playCoin(); 
        };

        window.updateStoreButtons = () => { 
            const inv = myProfileData.inventory || {}; const today = new Date().toDateString(); const lastMeat = myProfileData.lastMeatDate; 
            const setBtn = (id, price, condition) => {
                const btn = document.getElementById(id);
                if(condition) { btn.classList.add('sold-out'); btn.innerText = "å·²æ“æœ‰/ä¸Šé™"; btn.disabled = true; }
                else { btn.classList.remove('sold-out'); btn.innerText = `${price} ğŸ¦´ è³¼è²·`; btn.disabled = false; }
            };
            setBtn('btn-buy-meat', 50, lastMeat === today);
            setBtn('btn-buy-hat', 200, inv.hat);
            setBtn('btn-buy-black', 500, inv.black);
            setBtn('btn-buy-noads', 1000, inv.noads);
            
            // æ‡‰ç”¨æ•ˆæœ
            if(inv.hat) document.getElementById('shiba-hat').classList.remove('hidden'); 
            if(inv.black) document.getElementById('shiba-assistant').classList.add('black-shiba-filter'); 
        };
        
        // å¿…é ˆçš„è¼”åŠ©å‡½å¼ (éœ€è£œé½Šæ‰€æœ‰ä¹‹å‰çœç•¥çš„é‚è¼¯)
        window.switchView = (uid, name) => { currentViewUid = uid; document.getElementById('header-title').innerText = uid===currentUser.uid?'æˆ‘çš„ç›¸ç°¿':`${name} çš„ç›¸ç°¿`; document.getElementById('filter-type').value='all'; window.changeFilterMode(); loadDataRealtime(uid); document.getElementById('friend-modal').classList.remove('modal-show'); document.getElementById('friend-modal').classList.add('modal-hidden'); };
        async function ensureUserHasId(user) { const ref = doc(db, "users", user.uid); const snap = await getDoc(ref); if(snap.exists()) { myProfileData = snap.data(); if(!myProfileData.inventory) myProfileData.inventory={}; } else { const newData = { shortId: Math.floor(100000+Math.random()*900000).toString(), name: user.displayName, email: user.email, photo: user.photoURL, boneCoins: 100, mood: 100, inventory: {} }; await setDoc(doc(db, "public_codes", newData.shortId), {uid: user.uid, email: user.email, photo: user.photoURL}); await setDoc(ref, newData); myProfileData = newData; } document.getElementById('my-short-id').innerText = `ID: ${myProfileData.shortId}`; }
        async function loadCustomCategories(user) { const s = await getDoc(doc(db, "users", user.uid)); if(s.exists() && s.data().customCategories) userCustomCategories = s.data().customCategories; window.updateCategoryOptions(); }
        window.updateCategoryOptions = () => { const type = document.getElementById('inp-type').value; const cats = [...defaultCategories[type], ...(userCustomCategories[type]||[])]; document.getElementById('inp-category').innerHTML = cats.map(c => `<option value="${c}">${categoryIcons[c]||'âœ¨'} ${c}</option>`).join(''); }
        window.addCustomCategory = async () => { const n = prompt("æ–°åˆ†é¡åç¨±:"); if(n) { const t = document.getElementById('inp-type').value; if(!userCustomCategories[t]) userCustomCategories[t] = []; userCustomCategories[t].push(n); await setDoc(doc(db, "users", currentUser.uid), {customCategories: userCustomCategories}, {merge:true}); window.updateCategoryOptions(); document.getElementById('inp-category').value = n; } }
        window.changeFilterMode = () => { const mode = document.getElementById('filter-type').value; document.getElementById('filter-day').classList.add('hidden'); document.getElementById('filter-month').classList.add('hidden'); document.getElementById('filter-year').classList.add('hidden'); if(mode === 'day') document.getElementById('filter-day').classList.remove('hidden'); if(mode === 'month') document.getElementById('filter-month').classList.remove('hidden'); if(mode === 'year') document.getElementById('filter-year').classList.remove('hidden'); window.updateUI(); }
        window.triggerSubmit = () => { document.getElementById('transaction-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true})); }
        window.closeBonusModal = () => document.getElementById('daily-bonus-modal').classList.remove('modal-show');
        window.openUserProfile = async (targetUid) => { const isMe = (targetUid === currentUser.uid); let userData = isMe ? myProfileData : (await getDoc(doc(db, "users", targetUid))).data(); document.getElementById('profile-avatar').src = userData.photo || DEFAULT_AVATAR; document.getElementById('profile-name-input').value = userData.name || "ç¥ç§˜æŸ´å‹"; document.getElementById('profile-short-id').innerText = userData.shortId; document.getElementById('profile-email').innerText = userData.email; if(isMe) { document.getElementById('profile-actions').classList.remove('hidden'); document.getElementById('profile-friend-actions').classList.add('hidden'); } else { document.getElementById('profile-actions').classList.add('hidden'); document.getElementById('profile-friend-actions').classList.remove('hidden'); document.getElementById('btn-view-ledger').onclick = () => window.switchView(targetUid, userData.name); } window.toggleModal('profile-modal'); }
        window.saveProfile = async () => { await updateDoc(doc(db,"users",currentUser.uid), {name:document.getElementById('profile-name-input').value}); alert('å·²å„²å­˜'); window.toggleModal('profile-modal'); };
        window.addFriend = async () => { const id = document.getElementById('friend-id-input').value; if(id.length !== 6) return alert("ID éŒ¯èª¤"); if(id === myProfileData.shortId) return alert("ä¸èƒ½åŠ è‡ªå·±"); const target = await getDoc(doc(db, "public_codes", id)); if(!target.exists()) return alert("æ‰¾ä¸åˆ°æ­¤ ID"); const td = target.data(); await setDoc(doc(db, "users", currentUser.uid, "friends", td.uid), { uid: td.uid, shortId: id, name: "æ–°å¥½å‹", photo: td.photo }); await setDoc(doc(db, "users", td.uid, "friends", currentUser.uid), { uid: currentUser.uid, shortId: myProfileData.shortId, name: myProfileData.name, photo: myProfileData.photo }); alert("æ·»åŠ æˆåŠŸ"); }
        window.handlePhotoSelect = (e) => { const r = new FileReader(); r.onload = (e) => { document.getElementById('img-preview').src = e.target.result; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); }; r.readAsDataURL(e.target.files[0]); }
        window.clearPhoto = () => { document.getElementById('inp-photo').value=''; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('btn-camera').classList.remove('hidden'); }
        async function checkDailyBonus(uid) { const today = new Date().toDateString(); if(myProfileData.lastLoginDate !== today) { await updateDoc(doc(db,"users",uid), {lastLoginDate: today, boneCoins: increment(10)}); document.getElementById('daily-bonus-modal').classList.remove('hidden'); document.getElementById('daily-bonus-modal').classList.add('modal-show'); myProfileData.boneCoins += 10; } }
        function initMoodSystem() { setInterval(() => { if(shibaMood > 0) { shibaMood -= 5; updateMoodUI(); } }, 3600000); } // ç°¡åŒ–ç‰ˆå¿ƒæƒ…
        
        Chart.register(ChartDataLabels);
    </script>
</body>
</html>

