<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ´ç®¡å®¶ v10.7 - é™¤éŒ¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/zh-tw.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        #inp-photo, #inp-profile-photo { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .friend-active { border-color: #2563EB; background-color: #EFF6FF; }
        .filter-hidden { display: none; }
        .page-content { display: none; padding-bottom: 80px; } 
        .page-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        .nav-item.active { color: #2563EB; }
        .nav-item.active svg { fill: currentColor; }
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
        
        /* è¼‰å…¥é®ç½© */
        #loading-overlay { position: fixed; inset: 0; bg-white; z-index: 9999; display: flex; align-items: center; justify-content: center; background: white; flex-col; gap: 4; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <div id="loading-overlay" class="flex flex-col gap-4">
        <img src="./Shiba Logo.png" class="w-16 h-16 rounded-xl animate-bounce">
        <p class="text-gray-500 font-bold">ç³»çµ±å•Ÿå‹•ä¸­...</p>
        <p class="text-xs text-red-400 px-10 text-center">å¦‚æœå¡åœ¨é€™è£¡å¾ˆä¹…ï¼Œè«‹æª¢æŸ¥æ˜¯å¦ä½¿ç”¨äº† file:// é–‹å•Ÿ</p>
    </div>

    <div id="global-error-box" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[10000] text-xs font-mono break-all"></div>

    <div id="login-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 text-center fade-in hidden">
        <img src="./Shiba Logo.png" class="w-24 h-24 rounded-3xl shadow-2xl mb-8 object-cover">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 tracking-tight">æŸ´ç®¡å®¶ v10.7</h1>
        <p class="text-gray-500 mb-8">é™¤éŒ¯è¨ºæ–·æ¨¡å¼</p>
        
        <div id="login-error-msg" class="hidden bg-red-50 text-red-500 text-xs p-3 rounded-xl mb-4 text-left border border-red-100"></div>

        <button id="btn-login-popup" class="w-full max-w-sm bg-blue-600 text-white font-bold py-3.5 px-6 rounded-2xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition flex items-center justify-center gap-3 mb-4">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 bg-white rounded-full p-0.5" alt="Google">
            <span id="btn-text-a">æ¨¡å¼ Aï¼šå½ˆçª—ç™»å…¥</span>
        </button>

        <button id="btn-login-redirect" class="w-full max-w-sm bg-white border border-gray-200 text-gray-700 font-bold py-3.5 px-6 rounded-2xl shadow-sm hover:bg-gray-50 transition flex items-center justify-center gap-3">
            <span id="btn-text-b">æ¨¡å¼ Bï¼šè·³è½‰ç™»å…¥</span>
        </button>
    </div>

    <div id="app-screen" class="hidden w-full max-w-md mx-auto bg-white min-h-screen shadow-2xl relative flex flex-col">
        <header class="bg-white/90 backdrop-blur-md px-6 py-4 flex items-center justify-between sticky top-0 z-30 border-b border-gray-100">
            <div class="flex items-center gap-2">
                <img src="./Shiba Logo.png" class="w-8 h-8 rounded-lg shadow-sm object-cover">
                <span class="font-extrabold text-lg text-gray-800" id="header-title">è¨˜å¸³</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs font-bold font-mono" id="my-short-id">ID: ...</span>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-4">
            <div id="page-ledger" class="page-content active space-y-5">
                <div class="bg-white p-2 rounded-2xl border border-gray-100 shadow-sm flex gap-2 items-center">
                    <select id="filter-type" onchange="App.changeFilterMode()" class="bg-gray-50 border-none text-gray-700 text-sm rounded-xl font-bold focus:ring-0 block p-2 w-20">
                        <option value="day">æ—¥</option>
                        <option value="month" selected>æœˆ</option>
                        <option value="year">å¹´</option>
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                    <div class="flex-1">
                        <input type="date" id="filter-day" class="filter-hidden w-full bg-transparent border-none text-sm font-medium focus:ring-0 p-0 text-center">
                        <input type="month" id="filter-month" class="w-full bg-transparent border-none text-sm font-medium focus:ring-0 p-0 text-center">
                        <select id="filter-year" class="filter-hidden w-full bg-transparent border-none text-sm font-medium focus:ring-0 p-0 text-center"></select>
                        <div id="filter-all" class="filter-hidden text-xs text-gray-400 text-center">å…¨éƒ¨ç´€éŒ„</div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-gray-900 to-gray-800 text-white rounded-3xl p-6 shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="text-gray-400 text-xs font-medium uppercase mb-1" id="dashboard-title">æœ¬æœˆçµé¤˜</div>
                        <div class="text-4xl font-bold mb-6 tracking-tight" id="display-balance">$ 0</div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-xs text-gray-400 block mb-1">æ”¶å…¥</span><div class="font-semibold text-lg text-green-400" id="display-income">0</div></div>
                            <div><span class="text-xs text-gray-400 block mb-1">æ”¯å‡º</span><div class="font-semibold text-lg text-red-400" id="display-expense">0</div></div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-end gap-2 mb-2 px-1">
                        <span class="text-xs text-gray-400 font-bold">é¡¯ç¤ºåœ–è¡¨</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="chart-toggle-checkbox" class="sr-only peer" checked onchange="UI.toggleChart()">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div id="chart-container" class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4 transition-all duration-300">
                        <div class="relative h-64 w-full flex justify-center items-center">
                            <canvas id="expenseChart"></canvas>
                            <p id="chart-placeholder" class="hidden text-gray-400 text-sm">ğŸ¶ æ­¤å€é–“å°šç„¡æ•¸æ“š</p>
                        </div>
                    </div>
                </div>

                <div id="input-section" class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider" id="form-title">æ–°å¢äº¤æ˜“</h2>
                        <button id="btn-cancel-edit" onclick="App.resetForm()" class="hidden text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">å–æ¶ˆ</button>
                    </div>
                    <form id="transaction-form" class="space-y-3">
                        <div class="flex gap-2">
                            <select id="inp-account" class="w-1/2 bg-gray-50 border-none rounded-xl px-3 py-3 text-sm font-bold text-gray-700 focus:ring-2 focus:ring-blue-100"></select>
                            <input type="date" id="inp-date" class="w-1/2 bg-gray-50 border-none rounded-xl px-3 py-3 text-sm text-gray-600 focus:ring-2 focus:ring-blue-100">
                        </div>
                        <div class="flex gap-2">
                            <select id="inp-type" onchange="UI.updateCategoryOptions()" class="w-1/3 bg-gray-50 border-none rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-blue-100"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select>
                            <select id="inp-category" class="w-2/3 bg-gray-50 border-none rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-blue-100"></select>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="inp-amount" placeholder="$ é‡‘é¡" min="1" class="w-1/3 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-blue-100" required>
                            <input type="text" id="inp-title" placeholder="å‚™è¨» (é¸å¡«)" class="w-2/3 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-100">
                        </div>
                        <div class="flex gap-2 pt-2">
                            <input type="file" id="inp-photo" accept="image/*" onchange="App.handlePhotoSelect(event)">
                            <label for="inp-photo" id="btn-camera" class="w-12 h-12 flex-shrink-0 cursor-pointer bg-gray-100 text-gray-400 rounded-xl flex items-center justify-center hover:bg-gray-200 transition">ğŸ“·</label>
                            <div id="preview-container" class="hidden relative w-12 h-12">
                                <img id="img-preview" class="w-full h-full object-cover rounded-xl border border-gray-200">
                                <button type="button" onclick="App.clearPhoto()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md">Ã—</button>
                            </div>
                            <button type="submit" id="btn-submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition">è¨˜ä¸€ç­†</button>
                        </div>
                    </form>
                </div>

                <div id="transaction-list" class="space-y-2 pb-20"></div>
                <div id="empty-state" class="hidden py-10 text-center text-gray-400 text-sm">æ­¤å€é–“ç„¡ç´€éŒ„</div>
            </div>

            <div id="page-chart" class="page-content space-y-6">
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 flex items-center justify-center h-64 text-gray-400">é€²éšçµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...</div>
            </div>

            <div id="page-accounts" class="page-content space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-bold text-gray-800">æˆ‘çš„å¸³æˆ¶</h2>
                    <button onclick="App.createNewAccount()" class="text-sm bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg font-bold">+ æ–°å¢</button>
                </div>
                <div id="account-list-container" class="grid gap-3"></div>
            </div>

            <div id="page-settings" class="page-content space-y-6">
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 flex flex-col items-center">
                    <div class="relative">
                        <img id="profile-avatar" src="" class="w-24 h-24 rounded-full border-4 border-blue-50 mb-3 shadow-sm object-cover">
                        <label for="inp-profile-photo" class="absolute bottom-1 right-0 bg-blue-600 text-white p-2 rounded-full shadow-lg cursor-pointer hover:bg-blue-700 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </label>
                        <input type="file" id="inp-profile-photo" accept="image/*" onchange="App.handleProfilePhotoSelect(event)">
                    </div>
                    <div class="w-full flex gap-2 justify-center items-center mb-4">
                        <input type="text" id="profile-name-input" class="text-center text-lg font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1 w-32" placeholder="è¼¸å…¥æš±ç¨±">
                        <button onclick="App.saveProfileName()" class="text-blue-600 text-sm font-bold">å„²å­˜</button>
                    </div>
                    <div class="text-xs text-gray-400 bg-gray-100 px-3 py-1 rounded-full tracking-wider font-mono select-all" id="profile-short-id-display">...</div>
                </div>
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 flex justify-between items-center">å¥½å‹åˆ—è¡¨<button onclick="App.addFriendPrompt()" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-full">åŠ å…¥å¥½å‹</button></h3>
                    <div id="friend-list-container" class="space-y-3"></div>
                </div>
                <div class="bg-white rounded-3xl p-2 shadow-sm border border-gray-100">
                    <button onclick="addCustomCategory()" class="w-full text-left px-6 py-4 text-gray-700 font-medium hover:bg-gray-50 rounded-2xl flex justify-between">æ–°å¢è‡ªè¨‚åˆ†é¡ <span>+</span></button>
                    <div class="border-t border-gray-50 my-1"></div>
                    <button onclick="window.logout()" class="w-full text-left px-6 py-4 text-red-500 font-medium hover:bg-red-50 rounded-2xl flex justify-between">ç™»å‡ºå¸³è™Ÿ <span>â†’</span></button>
                </div>
            </div>
        </main>

        <footer class="bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center sticky bottom-0 z-40 pb-safe">
            <button onclick="UI.switchPage('ledger')" class="nav-item active flex flex-col items-center gap-1 text-gray-400 w-16"><svg class="w-6 h-6 transition-transform active:scale-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg><span class="text-[10px] font-bold">è¨˜å¸³</span></button>
            <button onclick="UI.switchPage('chart')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16"><svg class="w-6 h-6 transition-transform active:scale-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg><span class="text-[10px] font-bold">çµ±è¨ˆ</span></button>
            <button onclick="UI.switchPage('accounts')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16"><svg class="w-6 h-6 transition-transform active:scale-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg><span class="text-[10px] font-bold">å¸³æˆ¶</span></button>
            <button onclick="UI.switchPage('settings')" class="nav-item flex flex-col items-center gap-1 text-gray-400 w-16"><svg class="w-6 h-6 transition-transform active:scale-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span class="text-[10px] font-bold">è¨­å®š</span></button>
        </footer>

        <div id="comment-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center fade-in">
            <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 flex flex-col h-[60vh]">
                <div class="flex justify-between items-center mb-2 border-b border-gray-100 pb-2">
                    <h2 class="text-lg font-bold">ç•™è¨€æ¿ <span class="text-xs text-gray-400 font-normal ml-2">(24hr)</span></h2>
                    <button onclick="App.closeCommentModal()" class="text-gray-400 text-xl">&times;</button>
                </div>
                <div id="comments-list" class="flex-1 overflow-y-auto space-y-3 py-2"></div>
                <div class="mt-3 pt-3 flex gap-2 border-t border-gray-100">
                    <input type="text" id="comment-input" placeholder="ç•™è¨€..." class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-300">
                    <button onclick="App.submitComment()" class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-md hover:bg-blue-700 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg></button>
                </div>
            </div>
        </div>

        <div id="photo-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4" onclick="UI.closePhotoModal()">
            <img id="modal-img" src="" class="max-w-full max-h-full rounded-lg shadow-2xl">
        </div>
    </div>

    <script>
        window.addEventListener('error', function(e) {
            const box = document.getElementById('global-error-box');
            box.classList.remove('hidden');
            box.innerText = "âŒ ç³»çµ±éŒ¯èª¤: " + e.message;
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, deleteDoc, updateDoc, doc, getDoc, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ================= é…ç½®å€ =================
        const firebaseConfig = {
            apiKey: "AIzaSyCQRVE28OmopT1v6hybciDaigW4-9GaVzY",
            authDomain: "fma-cloud.firebaseapp.com",
            projectId: "fma-cloud",
            storageBucket: "fma-cloud.firebasestorage.app",
            messagingSenderId: "496004687854",
            appId: "1:496004687854:web:fb40424dabe2f1566a10ff",
            measurementId: "G-MTPV76EV3R"
        };

        let app, auth, db, provider;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            provider = new GoogleAuthProvider();
            // ç§»é™¤ Loading
            document.getElementById('loading-overlay').style.display = 'none';
        } catch (err) {
            document.getElementById('global-error-box').classList.remove('hidden');
            document.getElementById('global-error-box').innerText = "Firebase Init å¤±æ•—: " + err.message;
        }

        let currentUser = null;
        let currentViewUid = null;
        let transactions = [];
        let accounts = [];
        let myProfileData = null;
        let editingId = null;
        let currentCommentTxId = null;
        let currentPhotoData = null;
        let currentProfilePhotoData = null;
        let unsubTransactions = null;
        let unsubAccounts = null;

        const defaultCategories = { expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'], income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'] };
        let userCustomCategories = { expense: [], income: [] };

        // ç™»å…¥é‚è¼¯
        getRedirectResult(auth).then((result) => { if (result) console.log("Redirect Success"); }).catch((error) => { console.error("Redirect Error:", error); showLoginError(error); });

        document.getElementById('btn-login-popup').addEventListener('click', async () => {
            document.getElementById('btn-text-a').innerText = "è™•ç†ä¸­...";
            try { await setPersistence(auth, browserLocalPersistence); await signInWithPopup(auth, provider); } 
            catch (error) { showLoginError(error); }
            document.getElementById('btn-text-a').innerText = "æ¨¡å¼ Aï¼šå½ˆçª—ç™»å…¥";
        });

        document.getElementById('btn-login-redirect').addEventListener('click', async () => {
            document.getElementById('btn-text-b').innerText = "è·³è½‰ä¸­...";
            try { await setPersistence(auth, browserLocalPersistence); await signInWithRedirect(auth, provider); } 
            catch (error) { showLoginError(error); }
        });

        function showLoginError(error) {
            const errorDiv = document.getElementById('login-error-msg');
            errorDiv.classList.remove('hidden');
            errorDiv.innerText = "ç™»å…¥å¤±æ•— (" + error.code + "): " + error.message;
        }

        window.logout = () => { if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) signOut(auth); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                currentViewUid = user.uid;
                await App.init(user);
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                if(unsubTransactions) unsubTransactions();
                if(unsubAccounts) unsubAccounts();
            }
        });

        window.UI = {
            switchPage: (pageId) => {
                document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
                document.getElementById(`page-${pageId}`).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navIndex = { 'ledger': 0, 'chart': 1, 'accounts': 2, 'settings': 3 }[pageId];
                document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
                const titles = { 'ledger': 'è¨˜å¸³', 'chart': 'çµ±è¨ˆ', 'accounts': 'å¸³æˆ¶ç®¡ç†', 'settings': 'è¨­å®š' };
                document.getElementById('header-title').innerText = titles[pageId];
            },
            updateCategoryOptions: () => {
                const type = document.getElementById('inp-type').value;
                const allCats = [...defaultCategories[type], ...(userCustomCategories[type] || [])];
                document.getElementById('inp-category').innerHTML = allCats.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            },
            updateAccountOptions: () => {
                const select = document.getElementById('inp-account');
                select.innerHTML = accounts.length ? accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('') : '<option value="default">é è¨­å¸³æˆ¶</option>';
            },
            renderAccounts: () => {
                const container = document.getElementById('account-list-container');
                container.innerHTML = '';
                const balances = {};
                accounts.forEach(acc => balances[acc.id] = 0);
                transactions.forEach(t => {
                    const accId = t.accountId || 'default';
                    if (balances[accId] !== undefined) {
                        if (t.type === 'income') balances[accId] += Number(t.amount);
                        else balances[accId] -= Number(t.amount);
                    }
                });
                accounts.forEach(acc => {
                    const balance = balances[acc.id] || 0;
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center";
                    let icon = acc.type === 'bank' ? 'ğŸ¦' : (acc.type === 'card' ? 'ğŸ’³' : 'ğŸ’°');
                    div.innerHTML = `<div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl">${icon}</div><div><div class="font-bold text-gray-800">${acc.name}</div><div class="text-xs text-gray-400 capitalize">${acc.type}</div></div></div><div class="font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-500'}">$ ${balance.toLocaleString()}</div>`;
                    container.appendChild(div);
                });
            },
            toggleChart: () => {
                const checkbox = document.getElementById('chart-toggle-checkbox');
                const container = document.getElementById('chart-container');
                checkbox.checked ? container.classList.remove('hidden') : container.classList.add('hidden');
            },
            openPhotoModal: (src) => { document.getElementById('modal-img').src = src; document.getElementById('photo-modal').classList.remove('hidden'); },
            closePhotoModal: () => document.getElementById('photo-modal').classList.add('hidden')
        };

        window.App = {
            init: async (user) => {
                await App.ensureUserHasId(user);
                await App.loadCustomCategories(user);
                await App.ensureDefaultAccounts(user);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                App.loadAccountsRealtime();
                App.loadDataRealtime(user.uid);
                App.loadFriends();
                const today = new Date();
                document.getElementById('inp-date').valueAsDate = today;
                document.getElementById('filter-day').valueAsDate = today;
                document.getElementById('filter-month').value = today.toISOString().slice(0, 7);
                UI.updateCategoryOptions();
            },
            ensureDefaultAccounts: async (user) => {
                const accRef = collection(db, "users", user.uid, "accounts");
                const snapshot = await getDocs(query(accRef));
                if (snapshot.empty) {
                    await addDoc(accRef, { name: 'ç¾é‡‘', type: 'cash', createdAt: Date.now() });
                    await addDoc(accRef, { name: 'éŠ€è¡Œ', type: 'bank', createdAt: Date.now() });
                }
            },
            loadAccountsRealtime: () => {
                if (unsubAccounts) unsubAccounts();
                const q = query(collection(db, "users", currentUser.uid, "accounts"), orderBy("createdAt", "asc"));
                unsubAccounts = onSnapshot(q, (snapshot) => {
                    accounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    UI.updateAccountOptions();
                    UI.renderAccounts();
                });
            },
            createNewAccount: async () => {
                const name = prompt("è¼¸å…¥æ–°å¸³æˆ¶åç¨±:");
                if (name) await addDoc(collection(db, "users", currentUser.uid, "accounts"), { name: name, type: 'cash', createdAt: Date.now() });
            },
            ensureUserHasId: async (user) => {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                let userName = user.displayName || "User", userPhoto = user.photoURL;
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    myShortId = data.shortId;
                    if(data.name) userName = data.name;
                    if(data.photo) userPhoto = data.photo;
                    myProfileData = { ...data, photo: userPhoto };
                } else {
                    let isUnique = false, newId = "";
                    while (!isUnique) {
                        newId = Math.floor(100000 + Math.random() * 900000).toString();
                        const checkSnap = await getDoc(doc(db, "public_codes", newId));
                        if (!checkSnap.exists()) isUnique = true;
                    }
                    myProfileData = { shortId: newId, name: userName, email: user.email, photo: userPhoto };
                    await setDoc(doc(db, "public_codes", newId), { uid: user.uid, email: user.email, name: userName, photo: userPhoto });
                    await setDoc(userRef, { shortId: newId, name: userName, email: user.email, photo: userPhoto }, { merge: true });
                    myShortId = newId;
                }
                document.getElementById('my-short-id').innerText = `ID: ${myShortId}`;
                document.getElementById('profile-name-input').value = userName;
                document.getElementById('profile-avatar').src = userPhoto;
                document.getElementById('profile-short-id-display').innerText = myShortId;
            },
            loadCustomCategories: async (user) => {
                const userSnap = await getDoc(doc(db, "users", user.uid));
                if (userSnap.exists()) { const data = userSnap.data(); if(data.customCategories) userCustomCategories = data.customCategories; }
            },
            loadDataRealtime: (targetUid) => {
                if (unsubTransactions) unsubTransactions();
                //document.getElementById('sync-status').innerText = "è®€å–ä¸­...";
                const q = query(collection(db, "users", targetUid, "transactions"), orderBy("dateTimestamp", "desc"));
                unsubTransactions = onSnapshot(q, (snapshot) => {
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    UI.renderAccounts();
                    if(document.getElementById('filter-type').value === 'year') App.populateYearSelect();
                    App.updateUI();
                    //document.getElementById('sync-status').innerText = "å·²åŒæ­¥";
                }, (error) => { console.error(error); });
            },
            submitTransaction: async (e) => {
                e.preventDefault();
                if(currentViewUid !== currentUser.uid) return alert("åªèƒ½ç·¨è¼¯è‡ªå·±çš„å¸³æœ¬");
                const category = document.getElementById('inp-category').value;
                let title = document.getElementById('inp-title').value.trim();
                if (!title) title = category;
                const amount = Number(document.getElementById('inp-amount').value);
                const type = document.getElementById('inp-type').value;
                const accountId = document.getElementById('inp-account').value;
                const dateValue = document.getElementById('inp-date').valueAsDate;
                if (!dateValue) return alert("è«‹é¸æ“‡æ—¥æœŸ");
                const dateTimestamp = dateValue.getTime();
                const dateString = dateValue.toLocaleDateString();
                if (amount <= 0) return alert('ç„¡æ•ˆé‡‘é¡');
                document.getElementById('btn-submit').innerText = "è™•ç†ä¸­...";
                try {
                    const txData = { title, amount, type, category, accountId, dateTimestamp, date: dateString, photo: currentPhotoData };
                    if (editingId) { await updateDoc(doc(db, "users", currentUser.uid, "transactions", editingId), txData); App.resetForm(); }
                    else { await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData); App.resetForm(); }
                } catch (e) { alert("å¤±æ•—: " + e.message); }
                document.getElementById('btn-submit').innerText = "è¨˜ä¸€ç­†";
            },
            changeFilterMode: () => {
                const mode = document.getElementById('filter-type').value;
                document.querySelectorAll('.filter-hidden').forEach(el => el.style.display = 'none');
                document.getElementById('filter-day').classList.add('filter-hidden');
                document.getElementById('filter-month').classList.add('filter-hidden');
                document.getElementById('filter-year').classList.add('filter-hidden');
                document.getElementById('filter-all').classList.add('filter-hidden');
                if(mode === 'day') document.getElementById('filter-day').classList.remove('filter-hidden');
                else if(mode === 'month') document.getElementById('filter-month').classList.remove('filter-hidden');
                else if(mode === 'year') { document.getElementById('filter-year').classList.remove('filter-hidden'); App.populateYearSelect(); }
                else if(mode === 'all') document.getElementById('filter-all').classList.remove('filter-hidden');
                App.updateUI();
            },
            populateYearSelect: () => {
                const years = new Set([new Date().getFullYear()]);
                transactions.forEach(t => years.add(new Date(t.dateTimestamp).getFullYear()));
                const sortedYears = Array.from(years).sort((a, b) => b - a);
                const select = document.getElementById('filter-year');
                const currentVal = select.value;
                select.innerHTML = sortedYears.map(y => `<option value="${y}">${y} å¹´</option>`).join('');
                if (currentVal) select.value = currentVal;
            },
            updateUI: () => {
                const listEl = document.getElementById('transaction-list');
                const isSelf = currentViewUid === currentUser.uid;
                const mode = document.getElementById('filter-type').value;
                const dTitle = document.getElementById('dashboard-title');
                if(mode === 'day') dTitle.innerText = 'æœ¬æ—¥çµé¤˜';
                else if(mode === 'month') dTitle.innerText = 'æœ¬æœˆçµé¤˜';
                else if(mode === 'year') dTitle.innerText = 'æœ¬å¹´çµé¤˜';
                else dTitle.innerText = 'ç”Ÿæ¶¯ç¸½çµé¤˜';

                const filteredTransactions = transactions.filter(t => {
                    const date = new Date(t.dateTimestamp);
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    if (mode === 'day') return `${yyyy}-${mm}-${dd}` === document.getElementById('filter-day').value;
                    if (mode === 'month') return `${yyyy}-${mm}` === document.getElementById('filter-month').value;
                    if (mode === 'year') return `${yyyy}` == document.getElementById('filter-year').value;
                    return true;
                });

                listEl.innerHTML = '';
                let totalIncome = 0, totalExpense = 0, expenseData = {};
                if (filteredTransactions.length === 0) document.getElementById('empty-state').classList.remove('hidden');
                else document.getElementById('empty-state').classList.add('hidden');

                let lastDate = '';
                filteredTransactions.forEach(t => {
                    if (t.type === 'income') totalIncome += Number(t.amount);
                    else {
                        totalExpense += Number(t.amount);
                        let cat = t.category || 'å…¶ä»–';
                        expenseData[cat] = (expenseData[cat] || 0) + Number(t.amount);
                    }
                    const dateObj = new Date(t.dateTimestamp);
                    const dateStr = dateObj.toLocaleDateString('zh-TW');
                    if (dateStr !== lastDate) {
                        const header = document.createElement('div');
                        header.className = 'text-xs font-bold text-gray-400 mt-4 mb-2 ml-1 flex items-center gap-2';
                        header.innerHTML = `<span class="bg-gray-200 w-1.5 h-1.5 rounded-full"></span> ${dateStr}`;
                        listEl.appendChild(header);
                        lastDate = dateStr;
                    }
                    const isIncome = t.type === 'income';
                    const colorClass = isIncome ? 'text-green-500' : 'text-gray-900';
                    let leftIconHTML = t.photo ? `<img src="${t.photo}" onclick="UI.openPhotoModal('${t.photo}')" class="w-12 h-12 rounded-xl object-cover border border-gray-100 cursor-pointer shrink-0 shadow-sm">` : `<div class="w-12 h-12 rounded-xl ${isIncome ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-500'} flex items-center justify-center shrink-0 font-bold text-lg shadow-sm">${isIncome ? 'å…¥' : 'å‡º'}</div>`;
                    
                    let actionBtns = '';
                    if (isSelf) {
                        actionBtns = `<div class="flex gap-1 ml-2"><button onclick="App.editTransaction('${t.id}')" class="text-gray-300 hover:text-blue-500 p-1.5"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><button onclick="App.deleteTransaction('${t.id}')" class="text-gray-300 hover:text-red-500 p-1.5"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>`;
                    } else {
                        const now = Date.now();
                        const validCount = (t.comments || []).filter(c => now - c.timestamp < 86400000).length;
                        const badge = validCount > 0 ? `<span class="bg-red-500 text-white text-[10px] px-1.5 rounded-full absolute -top-1 -right-1 border border-white">${validCount}</span>` : '';
                        actionBtns = `<div class="relative ml-2"><button onclick="App.openCommentModal('${t.id}')" class="text-gray-300 hover:text-blue-500 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></button>${badge}</div>`;
                    }
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between mb-2';
                    item.innerHTML = `<div class="flex items-center gap-3 overflow-hidden flex-1">${leftIconHTML}<div class="min-w-0"><p class="font-bold text-gray-800 text-sm truncate">${t.category} <span class="text-gray-400 font-normal mx-1">|</span> <span class="text-gray-500 font-normal">${t.title}</span></p><p class="text-xs text-gray-400 mt-0.5">${accounts.find(a=>a.id === t.accountId)?.name || 'é è¨­å¸³æˆ¶'}</p></div></div><div class="flex items-center"><span class="font-bold ${colorClass} text-base whitespace-nowrap">${isIncome ? '+' : '-'} ${Number(t.amount).toLocaleString()}</span>${actionBtns}</div>`;
                    listEl.appendChild(item);
                });
                document.getElementById('display-balance').innerText = `$ ${(totalIncome - totalExpense).toLocaleString()}`;
                document.getElementById('display-income').innerText = `+ ${totalIncome.toLocaleString()}`;
                document.getElementById('display-expense').innerText = `- ${totalExpense.toLocaleString()}`;
                UI.renderChart(expenseData);
            },
            renderChart: (dataObj) => {
                const ctx = document.getElementById('expenseChart').getContext('2d');
                const labels = Object.keys(dataObj);
                const values = Object.values(dataObj);
                if (window.myChart) window.myChart.destroy();
                if (labels.length === 0) {
                    document.getElementById('expenseChart').style.display = 'none';
                    document.getElementById('chart-placeholder').classList.remove('hidden');
                } else {
                    document.getElementById('expenseChart').style.display = 'block';
                    document.getElementById('chart-placeholder').classList.add('hidden');
                    window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#6366F1', '#14B8A6'], borderWidth: 0, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true } } } } });
                }
            },
            editTransaction: (id) => {
                const tx = transactions.find(t => t.id === id);
                if (!tx) return;
                editingId = id;
                document.getElementById('inp-title').value = tx.title;
                document.getElementById('inp-amount').value = tx.amount;
                document.getElementById('inp-type').value = tx.type;
                document.getElementById('inp-account').value = tx.accountId || 'default';
                UI.updateCategoryOptions();
                document.getElementById('inp-category').value = tx.category;
                document.getElementById('inp-date').valueAsDate = new Date(tx.dateTimestamp);
                currentPhotoData = tx.photo || null;
                if(currentPhotoData) { document.getElementById('img-preview').src = currentPhotoData; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); }
                else App.clearPhoto();
                document.getElementById('btn-submit').innerText = "ç¢ºèªä¿®æ”¹";
                document.getElementById('btn-submit').classList.replace('bg-blue-600', 'bg-green-600');
                document.getElementById('form-title').innerText = "ä¿®æ”¹æ¨¡å¼";
                document.getElementById('btn-cancel-edit').classList.remove('hidden');
                document.querySelector('.page-content.active').scrollTo({ top: 0, behavior: 'smooth' });
            },
            resetForm: () => {
                editingId = null;
                document.getElementById('transaction-form').reset();
                document.getElementById('inp-date').valueAsDate = new Date();
                App.clearPhoto();
                document.getElementById('btn-submit').innerText = "è¨˜ä¸€ç­†";
                document.getElementById('btn-submit').classList.replace('bg-green-600', 'bg-blue-600');
                document.getElementById('form-title').innerText = "æ–°å¢äº¤æ˜“";
                document.getElementById('btn-cancel-edit').classList.add('hidden');
            },
            deleteTransaction: async (id) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id)); },
            handlePhotoSelect: (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');const s=600/i.width;c.width=(i.width>600)?600:i.width;c.height=(i.width>600)?i.height*s:i.height;const ctx=c.getContext('2d');ctx.drawImage(i,0,0,c.width,c.height);currentPhotoData=c.toDataURL('image/jpeg',0.5);document.getElementById('img-preview').src=currentPhotoData;document.getElementById('preview-container').classList.remove('hidden');document.getElementById('btn-camera').classList.add('hidden');};i.src=ev.target.result;};r.readAsDataURL(f); },
            clearPhoto: () => { document.getElementById('inp-photo').value=''; currentPhotoData=null; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('btn-camera').classList.remove('hidden'); },
            handleProfilePhotoSelect: (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');const s=300/i.width;c.width=(i.width>300)?300:i.width;c.height=(i.width>300)?i.height*s:i.height;const ctx=c.getContext('2d');ctx.drawImage(i,0,0,c.width,c.height);currentProfilePhotoData=c.toDataURL('image/jpeg',0.5);document.getElementById('profile-avatar').src=currentProfilePhotoData;};i.src=ev.target.result;};r.readAsDataURL(f); },
            saveProfileName: async () => { const n=document.getElementById('profile-name-input').value.trim(); if(!n)return; try{ const d={name:n}; if(currentProfilePhotoData)d.photo=currentProfilePhotoData; await updateDoc(doc(db,"users",currentUser.uid),d); await updateDoc(doc(db,"public_codes",myShortId),d); myProfileData.name=n; alert("å·²æ›´æ–°"); }catch(e){alert("Error");} },
            addFriendPrompt: async () => { const id=prompt("è¼¸å…¥å¥½å‹ 6 ä½æ•¸ ID:"); if(!id||id.length!==6)return; try{ const tDoc=await getDoc(doc(db,"public_codes",id)); if(tDoc.exists()){ const tData=tDoc.data(); const d1=setDoc(doc(db,"users",currentUser.uid,"friends",tData.uid),{uid:tData.uid,shortId:id,name:tData.name,email:tData.email,photo:tData.photo||null}); const d2=setDoc(doc(db,"users",tData.uid,"friends",currentUser.uid),{uid:currentUser.uid,shortId:myProfileData.shortId,name:myProfileData.name,email:currentUser.email,photo:myProfileData.photo||null}); await Promise.all([d1,d2]); alert(`å·²åŠ å…¥ ${tData.name}`); }else{alert("æ‰¾ä¸åˆ° ID");} }catch(e){alert("Error");} },
            loadFriends: () => {
                onSnapshot(query(collection(db,"users",currentUser.uid,"friends")), (snap) => {
                    const c = document.getElementById('friend-list-container'); c.innerHTML='';
                    const myDiv = document.createElement('div');
                    myDiv.className = `p-3 rounded-2xl border cursor-pointer flex items-center gap-3 ${currentViewUid===currentUser.uid?'bg-blue-50 border-blue-200':'bg-white border-gray-100'}`;
                    myDiv.innerHTML = `<img src="${myProfileData?.photo||'./Shiba Logo.png'}" class="w-10 h-10 rounded-full bg-gray-200 object-cover"><span class="font-bold">ğŸ‘¤ æˆ‘çš„å¸³æœ¬</span>`;
                    myDiv.onclick = () => App.switchView(currentUser.uid, 'æˆ‘çš„å¸³æœ¬');
                    c.appendChild(myDiv);
                    snap.forEach(d=>{ const f=d.data(); const div=document.createElement('div'); div.className=`p-3 rounded-2xl border cursor-pointer flex justify-between items-center ${currentViewUid===f.uid?'bg-blue-50 border-blue-200':'bg-white border-gray-100'}`; div.innerHTML=`<div class="flex items-center gap-3"><img src="${f.photo||'./Shiba Logo.png'}" class="w-10 h-10 rounded-full bg-gray-200 object-cover"><div><div class="font-bold text-sm">${f.name}</div></div></div>`; div.onclick=()=>{App.switchView(f.uid,f.name)}; c.appendChild(div); });
                });
            },
            switchView: (uid, name) => {
                currentViewUid = uid;
                document.getElementById('current-view-label').innerText = name;
                App.loadDataRealtime(uid);
                UI.switchPage('ledger');
            },
            
            openCommentModal: (id) => { currentCommentTxId=id; document.getElementById('comment-modal').classList.remove('hidden'); App.renderComments(id); },
            closeCommentModal: () => { document.getElementById('comment-modal').classList.add('hidden'); currentCommentTxId=null; },
            submitComment: async () => { const t=document.getElementById('comment-input').value.trim(); if(!t)return; const ref=doc(db,"users",currentViewUid,"transactions",currentCommentTxId); const snap=await getDoc(ref); if(snap.exists()){ const d=snap.data(); const cs=(d.comments||[]).filter(c=>Date.now()-c.timestamp<86400000); cs.push({text:t,authorName:myProfileData.name,timestamp:Date.now()}); await updateDoc(ref,{comments:cs}); document.getElementById('comment-input').value=''; App.renderComments(currentCommentTxId); } },
            renderComments: (id) => { const tx=transactions.find(t=>t.id===id); const cDiv=document.getElementById('comments-list'); cDiv.innerHTML=''; const cs=(tx.comments||[]).filter(c=>Date.now()-c.timestamp<86400000); if(!cs.length)cDiv.innerHTML='<div class="text-center text-gray-400 mt-10">ç„¡ç•™è¨€</div>'; else cs.forEach(c=>{ const d=document.createElement('div'); d.className="bg-gray-50 p-3 rounded-xl text-sm"; d.innerHTML=`<div class="flex justify-between font-bold text-blue-600"><span>${c.authorName}</span><span class="text-gray-300 font-normal text-xs">${moment(c.timestamp).fromNow()}</span></div><div class="text-gray-700 mt-1">${c.text}</div>`; cDiv.appendChild(d); }); }
        };

        document.getElementById('btn-submit').onclick = App.submitTransaction;
        document.getElementById('filter-day').onchange = App.updateUI;
        document.getElementById('filter-month').onchange = App.updateUI;
        document.getElementById('filter-year').onchange = App.updateUI;

    </script>
    <script src="https://cdn.jsdelivr.net/npm/import-map-overrides@2.2.0/dist/import-map-overrides.js"></script>
</body>
</html>
