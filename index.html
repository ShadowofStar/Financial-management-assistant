<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, deleteDoc, updateDoc, doc, getDoc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQRVE28OmopT1v6hybciDaigW4-9GaVzY", authDomain: "fma-cloud.firebaseapp.com", projectId: "fma-cloud", storageBucket: "fma-cloud.firebasestorage.app", messagingSenderId: "496004687854", appId: "1:496004687854:web:fb40424dabe2f1566a10ff", measurementId: "G-MTPV76EV3R" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();
        const DEFAULT_AVATAR = './Shiba Logo.png';
        
        let audioCtx, bgmGainNode, bgmSource;
        let globalBGMVolume = 0.5; let globalSFXVolume = 0.5; let isMusicPlaying = false;

        window.initAudio = () => { if (!audioCtx) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); bgmGainNode = audioCtx.createGain(); bgmGainNode.gain.value = globalBGMVolume; bgmGainNode.connect(audioCtx.destination); const bgMusic = document.getElementById('bg-music'); bgmSource = audioCtx.createMediaElementSource(bgMusic); bgmSource.connect(bgmGainNode); } if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playPop = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); };
        const playBark = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15); };
        const playCoin = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); };
        window.startApp = () => { window.initAudio(); const overlay = document.getElementById('start-overlay'); overlay.classList.add('opacity-0', 'pointer-events-none'); const bgMusic = document.getElementById('bg-music'); bgMusic.play().then(() => { isMusicPlaying = true; const btn = document.getElementById('music-btn'); btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); }).catch(e => console.log("Play failed:", e)); if(currentUser) document.getElementById('app-screen').classList.remove('hidden'); else document.getElementById('login-screen').classList.remove('hidden'); };
        window.toggleMusic = () => { const bgMusic = document.getElementById('bg-music'); const btn = document.getElementById('music-btn'); if(!audioCtx) window.initAudio(); if (isMusicPlaying) { bgMusic.pause(); btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); isMusicPlaying = false; } else { bgMusic.play().then(() => { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); isMusicPlaying = true; }); } };
        window.toggleSettingsModal = () => document.getElementById('settings-modal').classList.toggle('hidden');
        window.updateBGMVolume = (val) => { globalBGMVolume = parseFloat(val); if(bgmGainNode) bgmGainNode.gain.value = globalBGMVolume; document.getElementById('bgm-val-display').innerText = Math.round(globalBGMVolume * 100) + '%'; const btn = document.getElementById('music-btn'); if(globalBGMVolume === 0) { btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); } else if(isMusicPlaying) { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); } };
        window.updateSFXVolume = (val) => { globalSFXVolume = parseFloat(val); document.getElementById('sfx-val-display').innerText = Math.round(globalSFXVolume * 100) + '%'; playPop(); };
        document.addEventListener('click', (e) => { if((e.target.closest('button') || e.target.closest('.cursor-pointer')) && e.target.type !== 'range') { playPop(); } });
        
        const inputPanel = document.getElementById('input-panel'); let panelStartY = 0; let isDragging = false; 
        inputPanel.addEventListener('touchstart', (e) => { if(inputPanel.scrollTop <= 0) { panelStartY = e.touches[0].clientY; isDragging = false; } }, {passive: true}); 
        inputPanel.addEventListener('touchmove', (e) => { const diff = e.touches[0].clientY - panelStartY; if(inputPanel.scrollTop <= 0 && diff > 0) { if(e.cancelable) e.preventDefault(); isDragging = true; inputPanel.style.transform = `translateY(${diff}px)`; inputPanel.style.transition = 'none'; } }, {passive: false}); 
        inputPanel.addEventListener('touchend', (e) => { if(!isDragging) return; if((e.changedTouches[0].clientY - panelStartY) > 100) closeInputModal(); else { inputPanel.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; inputPanel.style.transform = ''; } isDragging = false; });
        
        const friendPanel = document.getElementById('friend-panel'); let friendStartX = 0; let friendStartY = 0; let isFriendClosing = false; let isScrollingList = false; 
        friendPanel.addEventListener('touchstart', (e) => { friendStartX = e.touches[0].clientX; friendStartY = e.touches[0].clientY; isFriendClosing = false; isScrollingList = false; friendPanel.style.transition = 'none'; }, {passive: true}); 
        friendPanel.addEventListener('touchmove', (e) => { if (isScrollingList) return; const currentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const xDiff = currentX - friendStartX; const yDiff = currentY - friendStartY; if (isFriendClosing || (xDiff < -10 && Math.abs(xDiff) > Math.abs(yDiff))) { if (e.cancelable) e.preventDefault(); isFriendClosing = true; friendPanel.style.transform = `translateX(${xDiff}px)`; } else if (Math.abs(yDiff) > Math.abs(xDiff)) { isScrollingList = true; } }, {passive: false}); 
        friendPanel.addEventListener('touchend', (e) => { if (isFriendClosing) { const xDiff = e.changedTouches[0].clientX - friendStartX; if (xDiff < -100) toggleFriendModal(); else { friendPanel.style.transition = 'transform 0.3s ease-out'; friendPanel.style.transform = ''; } } isFriendClosing = false; isScrollingList = false; });
        
        const storePanel = document.getElementById('store-panel'); let storeStartX = 0; let storeStartY = 0; let isStoreClosing = false; let isStoreScrolling = false; 
        storePanel.addEventListener('touchstart', (e) => { storeStartX = e.touches[0].clientX; storeStartY = e.touches[0].clientY; isStoreClosing = false; isStoreScrolling = false; storePanel.style.transition = 'none'; }, {passive: true}); 
        storePanel.addEventListener('touchmove', (e) => { if (isStoreScrolling) return; const currentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const xDiff = currentX - storeStartX; const yDiff = currentY - storeStartY; if (isStoreClosing || (xDiff > 10 && Math.abs(xDiff) > Math.abs(yDiff))) { if (e.cancelable) e.preventDefault(); isStoreClosing = true; storePanel.style.transform = `translateX(${xDiff}px)`; } else if (Math.abs(yDiff) > Math.abs(xDiff)) { isStoreScrolling = true; } }, {passive: false}); 
        storePanel.addEventListener('touchend', (e) => { if (isStoreClosing) { const xDiff = e.changedTouches[0].clientX - storeStartX; if (xDiff > 100) toggleStoreModal(); else { storePanel.style.transition = 'transform 0.3s ease-out'; storePanel.style.transform = ''; } } isStoreClosing = false; isStoreScrolling = false; });
        
        let globalStartX = 0; let globalStartY = 0; 
        document.addEventListener('touchstart', e => { globalStartX = e.changedTouches[0].screenX; globalStartY = e.changedTouches[0].screenY; }, false); 
        document.addEventListener('touchend', e => { 
            let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; let xDiff = touchEndX - globalStartX; let yDiff = touchEndY - globalStartY; 
            if (Math.abs(xDiff) > Math.abs(yDiff) && Math.abs(xDiff) > 50) { 
                if(document.getElementById('friend-modal').classList.contains('hidden') && document.getElementById('store-modal').classList.contains('hidden') && document.getElementById('input-modal').classList.contains('hidden')) { 
                    if (xDiff > 0) toggleFriendModal(); 
                } 
            } 
        }, false);

        const lockScroll = () => document.body.style.overflow = 'hidden'; const unlockScroll = () => document.body.style.overflow = '';
        let currentUser=null, currentViewUid=null, transactions=[], unsubscribe=null, currentDetailId=null, friendUnsubscribe=null;
        let myShortId=null, myProfileData=null, editingId=null, currentPhotoData=null, currentProfilePhotoData=null, myChart=null;
        let shibaMood = 100; let myInventory = {}; 

        const defaultCategories = { expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'], income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'] };
        let userCustomCategories = { expense: [], income: [] };
        const categoryIcons = { 'é¤é£²': 'ğŸ”', 'äº¤é€š': 'ğŸš—', 'è³¼ç‰©': 'ğŸ›ï¸', 'å¨›æ¨‚': 'ğŸ®', 'å±…ä½': 'ğŸ ', 'é†«ç™‚': 'ğŸ’Š', 'æ•™è‚²': 'ğŸ“š', 'å…¶ä»–': 'âœ¨', 'è–ªè³‡': 'ğŸ’°', 'çé‡‘': 'ğŸ§§', 'æŠ•è³‡': 'ğŸ“ˆ', 'å…¼è·': 'ğŸ’¼' };

        const inpAmount = document.getElementById('inp-amount'); const inpType = document.getElementById('inp-type'); const inpCategory = document.getElementById('inp-category'); const inpDate = document.getElementById('inp-date'); const inpTitle = document.getElementById('inp-title');
        inpDate.valueAsDate = new Date(); document.getElementById('filter-month').value = new Date().toISOString().slice(0, 7);

        document.getElementById('btn-google-login').addEventListener('click', () => { signInWithPopup(auth, provider).catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message)); });
        window.logout = () => { if(confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) signOut(auth); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user; currentViewUid = user.uid;
                await ensureUserHasId(user); await loadCustomCategories(user);
                if (document.getElementById('start-overlay').classList.contains('opacity-0')) {
                    document.getElementById('app-screen').classList.remove('hidden');
                    document.getElementById('login-screen').classList.add('hidden');
                }
                loadDataRealtime(user.uid); window.loadFriends(true); updateViewMode(); await checkDailyBonus(user.uid); initMoodSystem(); applyInventoryEffects();
                setTimeout(() => triggerShibaReaction("æ­¡è¿å›ä¾†ï¼Œä¸»äººï¼æ±ªï¼"), 1500);
            } else {
                if (document.getElementById('start-overlay').classList.contains('opacity-0')) {
                    document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('app-screen').classList.add('hidden');
                }
                if(unsubscribe) unsubscribe();
            }
        });

        window.initMoodSystem = () => {
            const now = Date.now(); const lastUpdate = myProfileData.lastMoodUpdate || now; const hoursPassed = Math.floor((now - lastUpdate) / 3600000);
            if(hoursPassed > 0) { const deduct = hoursPassed * 5; shibaMood = Math.max(0, (myProfileData.mood || 100) - deduct); updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, lastMoodUpdate: now }); } else { shibaMood = myProfileData.mood || 100; }
            updateMoodUI();
            setInterval(() => { const currentNow = Date.now(); const last = myProfileData.lastMoodUpdate || currentNow; if (currentNow - last >= 3600000) { shibaMood = Math.max(0, shibaMood - 5); updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, lastMoodUpdate: currentNow }); updateMoodUI(); } }, 60000);
        };
        window.updateMoodUI = () => { const bar = document.getElementById('mood-bar'); bar.style.width = `${shibaMood}%`; if(shibaMood <= 20) bar.style.backgroundColor = '#9D4EDD'; else if(shibaMood <= 50) bar.style.backgroundColor = '#48CAE4'; else bar.style.backgroundColor = '#FF7096'; };
        
        window.applyInventoryEffects = () => { 
            myInventory = myProfileData.inventory || {}; 
            const hatEl = document.getElementById('shiba-hat');
            const shibaEl = document.getElementById('shiba-assistant');
            
            if(myInventory.hat) hatEl.classList.remove('hidden'); 
            else hatEl.classList.add('hidden'); 
            
            if(myInventory.black) shibaEl.classList.add('black-shiba-filter'); 
            else shibaEl.classList.remove('black-shiba-filter'); 
        };
        
        window.toggleStoreModal = async () => { 
            const modal = document.getElementById('store-modal'); const panel = document.getElementById('store-panel');
            const isHidden = modal.classList.contains('hidden'); 
            if (isHidden) { 
                const userRef = doc(db, "users", currentUser.uid); const snap = await getDoc(userRef); 
                if (snap.exists()) { myProfileData.boneCoins = snap.data().boneCoins || 0; myProfileData.inventory = snap.data().inventory || {}; myProfileData.lastMeatDate = snap.data().lastMeatDate || 0; document.getElementById('store-coin-count').innerText = myProfileData.boneCoins; updateStoreButtons(); } 
                modal.classList.remove('hidden'); lockScroll();
            } else { modal.classList.add('hidden'); panel.style.transform = ''; unlockScroll(); } 
        };

        function updateStoreButtons() { 
            const inv = myProfileData.inventory || {}; const today = new Date().toDateString(); const lastMeat = myProfileData.lastMeatDate; 
            const meatBtn = document.getElementById('btn-buy-meat'); 
            if(lastMeat === today) { meatBtn.classList.add('sold-out'); meatBtn.innerText = "ä»Šæ—¥å·²é”ä¸Šé™"; meatBtn.disabled = true; } 
            else { meatBtn.classList.remove('sold-out'); meatBtn.innerText = "50 ğŸ¦´ è³¼è²·"; meatBtn.disabled = false; } 
            
            const hatBtn = document.getElementById('btn-buy-hat');
            if(inv.hat) { hatBtn.classList.add('sold-out'); hatBtn.innerText = "å·²æ“æœ‰"; hatBtn.disabled = true; }
            else { hatBtn.classList.remove('sold-out'); hatBtn.innerText = "200 ğŸ¦´ è³¼è²·"; hatBtn.disabled = false; }
            
            const blackBtn = document.getElementById('btn-buy-black');
            if(inv.black) { blackBtn.classList.add('sold-out'); blackBtn.innerText = "å·²æ“æœ‰"; blackBtn.disabled = true; }
            else { blackBtn.classList.remove('sold-out'); blackBtn.innerText = "500 ğŸ¦´ è³¼è²·"; blackBtn.disabled = false; }
            
            const noadsBtn = document.getElementById('btn-buy-noads');
            if(inv.noads) { noadsBtn.classList.add('sold-out'); noadsBtn.innerText = "å·²æ“æœ‰"; noadsBtn.disabled = true; }
            else { noadsBtn.classList.remove('sold-out'); noadsBtn.innerText = "1000 ğŸ¦´ è³¼è²·"; noadsBtn.disabled = false; }
        }

        window.buyItem = async (price, itemType) => {
            if (!myProfileData.inventory) myProfileData.inventory = {}; 
            if (itemType !== 'meat' && myProfileData.inventory[itemType]) return alert('å·²ç¶“æ“æœ‰æ­¤ç‰©å“å›‰ï¼');
            if (itemType === 'meat' && myProfileData.lastMeatDate === new Date().toDateString()) return alert('ä»Šå¤©å·²ç¶“åƒéå¤§é¤äº†ï¼');

            if (myProfileData.boneCoins < price) return triggerShibaReaction("éª¨é ­å¹£ä¸å¤ å•¦ï¼å¿«å»è¨˜å¸³ï¼(æ°£)");
            
            let confirmMsg = `ç¢ºå®šèŠ±è²» ${price} éª¨é ­å¹£è³¼è²·å—ï¼Ÿ`;
            if(itemType === 'meat') confirmMsg += "\n(å¿ƒæƒ…å°‡æ¢å¾©è‡³ 100)";
            
            if(!confirm(confirmMsg)) return;

            const userRef = doc(db, "users", currentUser.uid);
            let updates = { boneCoins: increment(-price) };
            let msg = "è³¼è²·æˆåŠŸï¼";

            if(itemType === 'meat') {
                updates.mood = 100;
                updates.lastMeatDate = new Date().toDateString();
                shibaMood = 100;
                myProfileData.lastMeatDate = updates.lastMeatDate;
                msg = "å¿ƒæƒ…è£œæ»¿äº†ï¼å¥½å¥½åƒï¼(æ±ª!)";
            } else {
                let newInv = myProfileData.inventory || {};
                newInv[itemType] = true;
                updates.inventory = newInv;
                myProfileData.inventory = newInv; 
                if(itemType === 'hat') msg = "å¸¶ä¸Šæ–°å¸½å­äº†ï¼å¸¥å—ï¼Ÿ";
                if(itemType === 'black') msg = "è®Šèº«é»‘æŸ´ï¼å¸¥æ°£åº¦+100ï¼";
                if(itemType === 'noads') msg = "å»£å‘Šæ¶ˆå¤±äº†ï¼æ¸…çˆ½ï¼";
            }

            await updateDoc(userRef, updates);
            myProfileData.boneCoins -= price;
            document.getElementById('store-coin-count').innerText = myProfileData.boneCoins;
            playCoin(); triggerShibaReaction(msg); updateMoodUI(); applyInventoryEffects(); updateStoreButtons();
        };

        window.closeBonusModal = () => document.getElementById('daily-bonus-modal').classList.add('hidden');
        const shibaEl = document.getElementById('shiba-assistant'); const speechEl = document.getElementById('shiba-speech'); let speechTimeout; const normalMessages = ["æ±ªï¼ä»Šå¤©èŠ±äº†å¤šå°‘éŒ¢ï¼Ÿ", "éª¨é ­å¹£ä¸å¤ ç”¨äº†å—ï¼Ÿ", "æˆ‘æ˜¯ä¸æ˜¯å¾ˆå¯æ„›ï¼ŸğŸ•", "åŠªåŠ›å­˜éŒ¢è²·ç½ç½ï¼", "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼"]; const sadMessages = ["ä¸»äºº...ä½ ä¸æ„›æˆ‘äº†å—ï¼Ÿ(å—š)", "è‚šå­å¥½é¤“...æƒ³åƒç½ç½...", "å¥½ä¹…æ²’æ‘¸æ‘¸æˆ‘äº†...", "æˆ‘å¥½ç„¡èŠ...é™ªæˆ‘ç©...", "æ˜¯ä¸æ˜¯æŠŠæˆ‘å¿˜è¨˜äº†ï¼Ÿ"];
        window.triggerShibaClick = async () => { 
            playBark(); shibaEl.classList.remove('animate-shiba-float'); void shibaEl.offsetWidth; shibaEl.classList.add('animate-shiba-bounce'); setTimeout(() => { shibaEl.classList.remove('animate-shiba-bounce'); shibaEl.classList.add('animate-shiba-float'); }, 400); 
            const today = new Date().toDateString(); if(myProfileData.lastPetDate !== today) { myProfileData.dailyPetCount = 0; myProfileData.lastPetDate = today; }
            let msg = "";
            if((myProfileData.dailyPetCount || 0) < 4) { shibaMood = Math.min(100, shibaMood + 5); myProfileData.dailyPetCount = (myProfileData.dailyPetCount || 0) + 1; await updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, dailyPetCount: myProfileData.dailyPetCount, lastPetDate: today }); updateMoodUI(); const heart = document.createElement('div'); heart.classList.add('animate-heart'); heart.innerText = 'â¤ï¸'; heart.style.left = '50%'; heart.style.bottom = '100%'; document.getElementById('shiba-assistant-container').appendChild(heart); setTimeout(() => heart.remove(), 1000); }
            const pool = shibaMood <= 50 ? sadMessages : normalMessages; msg = pool[Math.floor(Math.random() * pool.length)]; showSpeechBubble(msg); 
        };
        function triggerShibaReaction(message) { shibaEl.classList.remove('animate-shiba-float'); void shibaEl.offsetWidth; shibaEl.classList.add('animate-shiba-bounce'); setTimeout(() => { shibaEl.classList.remove('animate-shiba-bounce'); shibaEl.classList.add('animate-shiba-float'); }, 400); showSpeechBubble(message); }
        function showSpeechBubble(text) { clearTimeout(speechTimeout); speechEl.innerText = text; speechEl.classList.remove('hidden'); speechTimeout = setTimeout(() => { speechEl.classList.add('hidden'); }, 3000); }
        window.toggleFriendModal = () => { const modal = document.getElementById('friend-modal'); const panel = document.getElementById('friend-panel'); const isHidden = modal.classList.contains('hidden'); if (isHidden) { modal.classList.remove('hidden'); lockScroll(); loadFriends(true); } else { modal.classList.add('hidden'); panel.style.transform = ''; unlockScroll(); } };
        
        window.loadFriends = (force = false) => {
            if (!currentUser) return;
            if (friendUnsubscribe && !force) return;
            if (friendUnsubscribe) friendUnsubscribe();
            
            const el = document.getElementById('friend-list-container');
            el.innerHTML = ''; 
            
            // å„ªå…ˆæ¸²æŸ“è‡ªå·±
            const me = document.createElement('div');
            me.className = `p-4 rounded-2xl flex items-center gap-3 cursor-pointer ${currentViewUid===currentUser.uid ? 'bg-[#FFF0D4] border-2 border-[#F4A261]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`;
            const myPhoto = myProfileData?.photo || DEFAULT_AVATAR;
            me.innerHTML = `<img src="${myPhoto}" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div class="font-bold text-[#4A3B32]">æˆ‘çš„ç›¸ç°¿</div>`;
            me.onclick = () => { switchView(currentUser.uid, 'æˆ‘çš„å¸³æœ¬'); toggleFriendModal(); };
            el.appendChild(me);

            const q = query(collection(db, "users", currentUser.uid, "friends"));
            friendUnsubscribe = onSnapshot(q, (snapshot) => {
                while(el.children.length > 1) { el.removeChild(el.lastChild); }

                snapshot.forEach(doc => {
                    try {
                        const f = doc.data();
                        const div = document.createElement('div');
                        div.className = `p-4 rounded-2xl flex items-center justify-between cursor-pointer mt-2 ${currentViewUid===f.uid ? 'bg-[#E1F5FE] border-2 border-[#81D4FA]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`;
                        const fName = f.name || "ç¥ç§˜æŸ´å‹"; const fPhoto = f.photo || DEFAULT_AVATAR; const fId = f.shortId || "???";
                        
                        div.innerHTML = `<div class="flex items-center gap-3 flex-1"><img src="${fPhoto}" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div><div class="font-bold text-sm text-[#4A3B32]">${fName}</div><div class="text-xs text-[#8D6E63]">ID: ${fId}</div></div></div><button id="del-btn-${f.uid}" class="text-[#8D6E63] hover:text-[#E76F51] p-2">Ã—</button>`;
                        
                        // é»æ“Šå¥½å‹ -> æ‰“é–‹å€‹äººæª”æ¡ˆ (åŒ…å«æŸ¥çœ‹å¸³æœ¬é¸é …)
                        div.onclick = (e) => { 
                            if(e.target.id !== `del-btn-${f.uid}`) openUserProfile(f.uid); 
                        };
                        
                        setTimeout(() => {
                            document.getElementById(`del-btn-${f.uid}`).onclick = (e) => {
                                e.stopPropagation();
                                deleteFriend(f.uid);
                            };
                        }, 0);

                        el.appendChild(div);
                    } catch(e) { console.error(e); }
                });
            }, (error) => {
                console.error(error);
                const errDiv = document.createElement('div');
                errDiv.innerText = "è®€å–å¤±æ•—";
                errDiv.className = "text-center text-red-400 mt-4 text-xs";
                el.appendChild(errDiv);
            });
        };

        window.updateUI = () => { const listEl = document.getElementById('transaction-list'); const mode = document.getElementById('filter-type').value; const filterDate = mode === 'day' ? document.getElementById('filter-day').value : mode === 'month' ? document.getElementById('filter-month').value : document.getElementById('filter-year').value; const filtered = transactions.filter(t => { const d = new Date(t.dateTimestamp); const iso = d.toISOString().split('T')[0]; if(mode==='day') return iso===filterDate; if(mode==='month') return iso.slice(0,7)===filterDate; if(mode==='year') return String(d.getFullYear())===filterDate; return true; }); listEl.innerHTML = ''; let inc=0, exp=0, expData={}; if(filtered.length===0) document.getElementById('empty-state').classList.remove('hidden'); else document.getElementById('empty-state').classList.add('hidden'); filtered.forEach(t => { if(t.type==='income') inc+=Number(t.amount); else { exp+=Number(t.amount); expData[t.category]=(expData[t.category]||0)+Number(t.amount); } const div = document.createElement('div'); div.className = "aspect-square rounded-2xl overflow-hidden relative cursor-pointer border-2 border-white shadow-sm hover:scale-95 transition bg-white"; if(t.photo) { div.innerHTML = `<img src="${t.photo}" class="w-full h-full object-cover">`; } else { const isInc = t.type==='income'; const colorClass = isInc ? 'bg-[#E0F2F1] text-[#2A9D8F]' : 'bg-[#FFEBEE] text-[#E76F51]'; const icon = categoryIcons[t.category] || 'âœ¨'; div.innerHTML = `<div class="w-full h-full ${colorClass} flex flex-col items-center justify-center p-2 text-center"><span class="text-4xl mb-1 filter drop-shadow-sm">${icon}</span><span class="text-[10px] font-black truncate w-full">${t.category}</span><span class="text-[10px] font-bold mt-0.5 opacity-80">$${t.amount}</span></div>`; } if(t.photo) { div.innerHTML += `<div class="absolute bottom-0 right-0 bg-[#4A3B32]/60 backdrop-blur-sm text-white text-[10px] font-bold px-2 py-0.5 rounded-tl-lg border-t border-l border-white/20">$${t.amount}</div>`; } div.onclick = () => openDetailModal(t.id); listEl.appendChild(div); }); document.getElementById('display-balance').innerText=(inc-exp).toLocaleString(); document.getElementById('display-income').innerText=inc.toLocaleString(); document.getElementById('display-expense').innerText=exp.toLocaleString(); renderChart(expData); };
        window.openDetailModal = (id) => { const t = transactions.find(x => x.id === id); if(!t) return; currentDetailId = id; document.getElementById('detail-title').innerText = t.title || t.category; document.getElementById('detail-amount').innerText = `$ ${Number(t.amount).toLocaleString()}`; document.getElementById('detail-amount').className = t.type==='income' ? 'text-2xl font-black text-[#2A9D8F]' : 'text-2xl font-black text-[#E76F51]'; document.getElementById('detail-date').innerText = t.date; document.getElementById('detail-category').innerText = t.category; document.getElementById('detail-type').innerText = t.type==='income'?'æ”¶å…¥':'æ”¯å‡º'; const imgEl = document.getElementById('detail-img'); const noImgEl = document.getElementById('detail-no-img'); const detailIconEl = document.getElementById('detail-icon'); if(t.photo) { imgEl.src = t.photo; imgEl.classList.remove('hidden'); noImgEl.classList.add('hidden'); } else { imgEl.classList.add('hidden'); noImgEl.classList.remove('hidden'); detailIconEl.innerText = categoryIcons[t.category] || 'ğŸ•'; } const actionsEl = document.getElementById('detail-actions'); if(currentViewUid === currentUser.uid) actionsEl.classList.remove('hidden'); else actionsEl.classList.add('hidden'); renderDetailComments(t); document.getElementById('detail-modal').classList.remove('hidden'); };
        window.closeDetailModal = () => document.getElementById('detail-modal').classList.add('hidden');
        window.editCurrentDetail = () => { window.closeDetailModal(); window.editTransaction(currentDetailId); };
        window.deleteCurrentDetail = () => { if(confirm('åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) { window.deleteTransactionCloud(currentDetailId); window.closeDetailModal(); }};
        function renderDetailComments(t) { const list = document.getElementById('detail-comments-list'); list.innerHTML = ''; const comms = (t.comments||[]).filter(c => Date.now()-c.timestamp < 86400000); if(comms.length===0) list.innerHTML = '<div class="text-xs text-[#8D6E63] text-center py-4 bg-[#FFF8E1] rounded-xl border border-[#FFE8D6]">âœ¨ é‚„æ²’æœ‰ç•™è¨€ï¼Œæ¶é ­é¦™ï¼</div>'; comms.forEach(c => { const d = document.createElement('div'); d.className="text-sm bg-white border border-[#FFE8D6] p-3 rounded-xl mb-1 shadow-sm"; d.innerHTML = `<span class="font-bold text-[#F4A261] mr-1">${c.authorName}:</span><span class="text-[#4A3B32]">${c.text}</span>`; list.appendChild(d); }); }
        window.submitDetailComment = async () => { const txt = document.getElementById('detail-comment-input').value.trim(); if(!txt) return; const ref = doc(db,"users",currentViewUid,"transactions",currentDetailId); const snap = await getDoc(ref); let arr = snap.data().comments || []; arr.push({text:txt, authorName:myProfileData.name, timestamp:Date.now()}); await updateDoc(ref, {comments:arr}); document.getElementById('detail-comment-input').value=''; renderDetailComments({...snap.data(), comments:arr}); };
        async function ensureUserHasId(user) { const ref = doc(db, "users", user.uid); const snap = await getDoc(ref); const userPhoto = user.photoURL || DEFAULT_AVATAR; if(snap.exists()) { const d = snap.data(); myShortId = d.shortId; myProfileData = {...d, photo: d.photo || userPhoto}; if (myProfileData.boneCoins === undefined) { await updateDoc(ref, { boneCoins: 100 }); myProfileData.boneCoins = 100; } if (myProfileData.mood === undefined) { await updateDoc(ref, { mood: 100 }); myProfileData.mood = 100; } if (!myProfileData.inventory) myProfileData.inventory = {}; } else { let id = Math.floor(100000 + Math.random()*900000).toString(); const newData = { shortId: id, name: user.displayName, email: user.email, photo: userPhoto, boneCoins: 100, mood: 100, inventory: {} }; await setDoc(doc(db, "public_codes", id), {uid: user.uid, email: user.email, photo: userPhoto}); await setDoc(ref, newData); myShortId = id; myProfileData = newData; } document.getElementById('my-short-id').innerText = `ID: ${myShortId}`; document.getElementById('profile-short-id').innerText = myShortId; document.getElementById('profile-email').innerText = user.email; document.getElementById('profile-name-input').value = myProfileData.name; document.getElementById('profile-avatar').src = myProfileData.photo; }
        function loadDataRealtime(targetUid) { if(unsubscribe) unsubscribe(); const q = query(collection(db, "users", targetUid, "transactions"), orderBy("dateTimestamp", "desc")); unsubscribe = onSnapshot(q, (snap) => { transactions = snap.docs.map(d => ({id: d.id, ...d.data()})); const years = new Set([new Date().getFullYear()]); transactions.forEach(t => years.add(new Date(t.dateTimestamp).getFullYear())); const ySelect = document.getElementById('filter-year'); const currY = ySelect.value; ySelect.innerHTML = Array.from(years).sort((a,b)=>b-a).map(y => `<option value="${y}">${y} å¹´</option>`).join(''); if(currY) ySelect.value = currY; updateUI(); }, (error) => { console.error("è®€å–å¤±æ•—:", error); alert("è®€å–æ¬Šé™ä¸è¶³ï¼Œè«‹ç¢ºèªå°æ–¹å·²åŠ ä½ ç‚ºå¥½å‹"); }); }
        
        window.openInputModal = () => { if(!editingId) window.resetForm(); document.getElementById('input-modal').classList.remove('hidden'); lockScroll(); };
        window.closeInputModal = () => { document.getElementById('input-modal').classList.add('hidden'); document.getElementById('input-panel').style.transform = ''; unlockScroll(); setTimeout(() => window.resetForm(), 300); };
        window.triggerSubmit = () => { document.getElementById('transaction-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true})); };
        window.resetForm = () => { editingId = null; document.getElementById('form-title').innerText = "è¨˜ä¸€ç­†"; inpAmount.value = ''; inpTitle.value = ''; inpDate.valueAsDate = new Date(); window.clearPhoto(); };
        window.editTransaction = (id) => { const tx = transactions.find(t => t.id === id); if (!tx) return; editingId = id; inpTitle.value = tx.title; inpAmount.value = tx.amount; inpType.value = tx.type; updateCategoryOptions(); inpCategory.value = tx.category; inpDate.valueAsDate = new Date(tx.dateTimestamp); currentPhotoData = tx.photo || null; if (currentPhotoData) { document.getElementById('img-preview').src = currentPhotoData; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); } else window.clearPhoto(); document.getElementById('form-title').innerText = "ç·¨è¼¯"; window.openInputModal(); };
        document.getElementById('transaction-form').addEventListener('submit', async (e) => { e.preventDefault(); if(currentViewUid !== currentUser.uid) return alert("åªèƒ½ç·¨è¼¯è‡ªå·±çš„å¸³æœ¬å–”"); const amount = Number(inpAmount.value); if(amount <= 0) return alert("é‡‘é¡éŒ¯èª¤"); const data = { amount, type: inpType.value, category: inpCategory.value, title: inpTitle.value.trim() || inpCategory.value, dateTimestamp: inpDate.valueAsDate.getTime(), date: inpDate.valueAsDate.toLocaleDateString(), photo: currentPhotoData }; try { if(editingId) { await updateDoc(doc(db, "users", currentUser.uid, "transactions", editingId), data); } else { await addDoc(collection(db, "users", currentUser.uid, "transactions"), data); await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: increment(10) }); myProfileData.boneCoins += 10; triggerShibaReaction("è¨˜å¸³æˆåŠŸï¼éª¨é ­å¹£ +10ï¼(é–‹å¿ƒ)"); playCoin(); } window.closeInputModal(); } catch(e) { alert("éŒ¯èª¤: " + e.message); } });
        window.deleteTransactionCloud = async (id) => { await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id)); };
        
        window.changeFilterMode = () => { const mode = document.getElementById('filter-type').value; document.getElementById('filter-day').classList.add('hidden'); document.getElementById('filter-month').classList.add('hidden'); document.getElementById('filter-year').classList.add('hidden'); if(mode === 'day') document.getElementById('filter-day').classList.remove('hidden'); if(mode === 'month') document.getElementById('filter-month').classList.remove('hidden'); if(mode === 'year') document.getElementById('filter-year').classList.remove('hidden'); updateUI(); }
        async function loadCustomCategories(user) { const s = await getDoc(doc(db, "users", user.uid)); if(s.exists() && s.data().customCategories) userCustomCategories = s.data().customCategories; updateCategoryOptions(); }
        window.updateCategoryOptions = () => { const type = inpType.value; const cats = [...defaultCategories[type], ...(userCustomCategories[type]||[])]; inpCategory.innerHTML = cats.map(c => { const icon = categoryIcons[c] || 'âœ¨'; return `<option value="${c}">${icon} ${c}</option>`; }).join(''); }
        window.addCustomCategory = async () => { const n = prompt("æ–°åˆ†é¡åç¨±:"); if(n) { const t = inpType.value; if(!userCustomCategories[t]) userCustomCategories[t] = []; userCustomCategories[t].push(n); await setDoc(doc(db, "users", currentUser.uid), {customCategories: userCustomCategories}, {merge:true}); updateCategoryOptions(); inpCategory.value = n; } }
        document.getElementById('filter-day').addEventListener('input', updateUI); document.getElementById('filter-month').addEventListener('input', updateUI); document.getElementById('filter-year').addEventListener('change', updateUI);
        
        Chart.register(ChartDataLabels);
        function renderChart(data) { const ctx = document.getElementById('expenseChart').getContext('2d'); const legendContainer = document.getElementById('chart-legend'); const lbs = Object.keys(data); const vals = Object.values(data); if(myChart) myChart.destroy(); if(lbs.length === 0) { document.getElementById('chart-placeholder').classList.remove('hidden'); legendContainer.innerHTML = ''; return; } document.getElementById('chart-placeholder').classList.add('hidden'); const colors = ['#F4A261','#E76F51','#E9C46A','#2A9D8F','#264653','#8D6E63','#F4D35E','#DA627D']; myChart = new Chart(ctx, { type: 'doughnut', data: { labels: lbs, datasets: [{ data: vals, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } } } }); const total = vals.reduce((a, b) => a + b, 0); legendContainer.innerHTML = lbs.map((label, i) => { const val = vals[i]; const percent = Math.round((val / total) * 100); const color = colors[i % colors.length]; const icon = categoryIcons[label] || 'âœ¨'; return `<div class="flex items-center justify-between"><div class="flex items-center gap-1.5 min-w-0"><div class="w-2.5 h-2.5 rounded-full shrink-0" style="background-color: ${color}"></div><span class="truncate font-bold text-[#4A3B32]">${icon} ${label}</span></div><div class="text-[#8D6E63] font-mono shrink-0">${percent}%</div></div>`; }).join(''); }

        window.toggleChart = () => { document.getElementById('chart-container').classList.toggle('hidden'); }
        window.toggleFriendModal = () => document.getElementById('friend-modal').classList.toggle('hidden');
        window.toggleProfileModal = () => document.getElementById('profile-modal').classList.toggle('hidden');
        window.handlePhotoSelect = (e) => processImage(e.target.files[0], (data) => { currentPhotoData = data; document.getElementById('img-preview').src = data; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); });
        window.handleProfilePhotoSelect = (e) => processImage(e.target.files[0], (data) => { currentProfilePhotoData = data; document.getElementById('profile-avatar').src = data; });
        function processImage(file, cb) { if(!file) return; const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); const scale = 600/i.width; c.width = 600; c.height = i.height*scale; c.getContext('2d').drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/jpeg', 0.6)); }; i.src = e.target.result; }; r.readAsDataURL(file); }
        window.clearPhoto = () => { document.getElementById('inp-photo').value=''; currentPhotoData=null; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('btn-camera').classList.remove('hidden'); };
        window.saveProfile = async () => { await updateDoc(doc(db,"users",currentUser.uid), {name:document.getElementById('profile-name-input').value, photo:currentProfilePhotoData}); alert('å·²å„²å­˜'); window.toggleProfileModal(); };
        window.toggleStoreModal = async () => { const modal = document.getElementById('store-modal'); const isHidden = modal.classList.contains('hidden'); if (isHidden) { const userRef = doc(db, "users", currentUser.uid); const snap = await getDoc(userRef); if (snap.exists()) { myProfileData.boneCoins = snap.data().boneCoins || 0; document.getElementById('store-coin-count').innerText = myProfileData.boneCoins; } modal.classList.remove('hidden'); } else { modal.classList.add('hidden'); } };
        window.buyItem = async (price, itemName) => { if (myProfileData.boneCoins >= price) { if(confirm(`ç¢ºå®šèŠ±è²» ${price} éª¨é ­å¹£è³¼è²· ${itemName} å—ï¼Ÿ`)) { await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: increment(-price) }); myProfileData.boneCoins -= price; document.getElementById('store-coin-count').innerText = myProfileData.boneCoins; triggerShibaReaction(`è¬è¬æƒ é¡§ï¼ä½ è²·äº† ${itemName} (æ±ª!)`); playCoin(); } } else { triggerShibaReaction("éª¨é ­å¹£ä¸å¤ å•¦ï¼å¿«å»è¨˜å¸³ï¼(æ°£)"); } };
        window.setMoney = async (amount) => { if (!currentUser) return alert("è«‹å…ˆç™»å…¥"); try { await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: Number(amount) }); if(myProfileData) myProfileData.boneCoins = Number(amount); const storeCountEl = document.getElementById('store-coin-count'); if(storeCountEl) storeCountEl.innerText = amount; alert(`ğŸ¶ æ¸¬è©¦æ¨¡å¼ï¼šéª¨é ­å¹£å·²ä¿®æ”¹ç‚º ${amount}`); } catch (e) { console.error(e); alert("ä¿®æ”¹å¤±æ•—"); } };
        
        // ğŸ”¥ æ–°å¢ï¼šé–‹å•Ÿå€‹äººæª”æ¡ˆå¡ç‰‡ (åŒ…å«æŸ¥çœ‹å¸³æœ¬é¸é …)
        window.openUserProfile = async (targetUid) => {
            let userData = null;
            if(targetUid === currentUser.uid) {
                userData = myProfileData;
            } else {
                const snap = await getDoc(doc(db, "users", targetUid));
                if(snap.exists()) userData = snap.data();
            }

            if(!userData) return alert("æŸ¥ç„¡æ­¤äºº");

            // å¡«å…¥è³‡æ–™
            document.getElementById('profile-avatar').src = userData.photo || DEFAULT_AVATAR;
            document.getElementById('profile-short-id').innerText = userData.shortId || "???";
            document.getElementById('profile-email').innerText = userData.email || "";
            document.getElementById('profile-name-input').value = userData.name || "";

            // åˆ¤æ–·æ˜¯è‡ªå·±é‚„æ˜¯å¥½å‹ï¼Œåˆ‡æ›ä»‹é¢
            const isMe = (targetUid === currentUser.uid);
            const nameInput = document.getElementById('profile-name-input');
            const cameraBtn = document.getElementById('profile-camera-btn');
            const myActions = document.getElementById('profile-actions');
            const friendActions = document.getElementById('profile-friend-actions');
            const viewLedgerBtn = document.getElementById('btn-view-ledger');

            if(isMe) {
                nameInput.disabled = false; // è‡ªå·±å¯æ”¹å
                cameraBtn.classList.remove('hidden'); // é¡¯ç¤ºç›¸æ©Ÿéˆ•
                myActions.classList.remove('hidden'); // é¡¯ç¤ºå„²å­˜/ç™»å‡º
                friendActions.classList.add('hidden'); // éš±è—å¥½å‹æŒ‰éˆ•
            } else {
                nameInput.disabled = true; // å¥½å‹ä¸å¯æ”¹å
                cameraBtn.classList.add('hidden'); // éš±è—ç›¸æ©Ÿéˆ•
                myActions.classList.add('hidden'); // éš±è—å„²å­˜/ç™»å‡º
                friendActions.classList.remove('hidden'); // é¡¯ç¤ºã€ŒæŸ¥çœ‹å¸³æœ¬ã€
                
                // è¨­å®šæŸ¥çœ‹æŒ‰éˆ•çš„å‹•ä½œ
                viewLedgerBtn.onclick = () => {
                    switchView(targetUid, userData.name);
                    toggleProfileModal(); // é—œé–‰å¡ç‰‡
                };
            }

            const modal = document.getElementById('profile-modal');
            if(modal.classList.contains('hidden')) modal.classList.remove('hidden');
        };

        // ğŸ”¥ æ›´æ–°ï¼šåˆ‡æ›è¦–è§’ (åŠ å…¥è¦–è¦ºæç¤º)
        window.switchView = (uid, name) => { 
            currentViewUid = uid; 
            const isMe = uid === currentUser.uid;
            
            // æ¨™é¡Œèˆ‡æ¨™ç±¤æ–‡å­—
            document.getElementById('header-title').innerText = isMe ? 'æˆ‘çš„ç›¸ç°¿' : `${name} çš„ç›¸ç°¿`;
            document.getElementById('current-view-label').innerText = isMe ? 'å€‹äºº' : 'å¥½å‹';
            
            // ğŸ”¥ è¦–è¦ºè¾¨è­˜ï¼šå¥½å‹æ¨¡å¼ä¸‹ï¼ŒHeader èƒŒæ™¯è®Šè—è‰²
            const header = document.querySelector('header');
            if (isMe) {
                header.classList.remove('bg-[#E1F5FE]/95');
                header.classList.add('bg-[#FFFCF5]/95');
                document.getElementById('header-title').classList.remove('text-[#0277BD]');
                document.getElementById('header-title').classList.add('text-[#4A3B32]');
            } else {
                header.classList.remove('bg-[#FFFCF5]/95');
                header.classList.add('bg-[#E1F5FE]/95');
                document.getElementById('header-title').classList.remove('text-[#4A3B32]');
                document.getElementById('header-title').classList.add('text-[#0277BD]'); // æ·±è—è‰²æ–‡å­—
            }

            updateViewMode(); 
            loadDataRealtime(uid); 
            document.getElementById('friend-modal').classList.add('hidden'); 
        }
        function updateViewMode() { const isMe = currentViewUid === currentUser.uid; document.getElementById('fab-btn').classList.toggle('hidden', !isMe); }
    </script>
