<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ´ç®¡å®¶ v7.0</title>
    
    <link rel="icon" type="image/png" href="./Shiba Logo.png">
    <link rel="shortcut icon" href="./Shiba Logo.png">
    <link rel="apple-touch-icon" href="./Shiba Logo.png">
    <meta name="theme-color" content="#FFFCF5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; background-color: #FFFCF5; color: #4A3B32; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        /* ç°¡å–®çš„æ·¡å…¥æ·¡å‡º */
        .fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* æŸ´çŠ¬å‹•ç•« */
        @keyframes shiba-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        .animate-shiba-float { animation: shiba-float 3s ease-in-out infinite; }
        
        /* ç‹€æ…‹é¡åˆ¥ */
        .black-shiba-filter { filter: grayscale(100%) brightness(0.6) contrast(1.2); }
        .sold-out { opacity: 0.5; pointer-events: none; background: #ccc !important; }
        
        /* ç¢ºä¿ Modal åœ¨æœ€ä¸Šå±¤ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(74, 59, 50, 0.6); z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(4px); }
        .modal-content { background: #FFFCF5; width: 100%; max-width: 24rem; border-radius: 2rem; padding: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); border: 4px solid white; position: relative; max-height: 85vh; display: flex; flex-direction: column; }
    </style>
</head>
<body>

    <div id="start-overlay" class="fixed inset-0 bg-[#FFFCF5] z-[100] flex flex-col items-center justify-center">
        <img src="./Shiba Logo.png" class="w-32 h-32 rounded-[2rem] shadow-xl mb-6 animate-shiba-float border-4 border-white">
        <h2 class="text-2xl font-black mb-2">æ­¡è¿ä¾†åˆ°æŸ´ç®¡å®¶</h2>
        <button onclick="window.startApp()" class="bg-[#F4A261] text-white text-lg font-black py-3 px-10 rounded-2xl shadow-lg active:scale-95 transition mt-8">é€²å…¥ App</button>
    </div>

    <div id="login-screen" class="hidden fixed inset-0 bg-[#FFFCF5] z-[90] flex flex-col items-center justify-center p-6 text-center">
        <img src="./Shiba Logo.png" class="w-32 h-32 rounded-[2rem] shadow-xl mb-6 border-4 border-white">
        <h1 class="text-3xl font-black mb-2">è«‹å…ˆç™»å…¥</h1>
        <button id="btn-google-login" class="w-full max-w-sm bg-white border-2 border-[#F4A261] font-bold py-4 rounded-2xl shadow-md mt-8">Google ç™»å…¥</button>
    </div>

    <div id="app-screen" class="hidden flex flex-col h-screen max-w-md mx-auto bg-[#FFFCF5] relative shadow-2xl">
        <header class="px-5 pt-10 pb-4 flex justify-between items-center z-10 bg-[#FFFCF5]/90 backdrop-blur-sm sticky top-0">
            <div class="text-2xl font-black" id="header-title">æˆ‘çš„ç›¸ç°¿</div>
            
            <div class="bg-white border-2 border-[#FFE8D6] rounded-xl flex text-xs font-bold relative p-1">
                <select id="filter-type" onchange="window.updateUI()" class="bg-transparent appearance-none px-2 py-1 text-[#8D6E63] focus:outline-none z-10">
                    <option value="all" selected>å…¨éƒ¨</option> <option value="month">æœ¬æœˆ</option>
                    <option value="day">ä»Šæ—¥</option>
                </select>
                <div class="pr-1 text-[#F4A261] self-center">â–¼</div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar pb-32 px-5">
            <div class="bg-white rounded-[2rem] p-5 shadow-sm border-2 border-[#FFE8D6] mb-4 relative overflow-hidden" onclick="document.getElementById('chart-container').classList.toggle('hidden')">
                <div class="relative z-10">
                    <div class="text-xs text-[#8D6E63] font-bold uppercase mb-1">ç¸½çµé¤˜</div>
                    <div class="text-3xl font-black flex items-baseline"><span class="text-sm mr-1">$</span><span id="display-balance">0</span></div>
                </div>
                <div class="absolute right-5 top-5 text-right">
                    <div><span class="text-[10px] text-[#8D6E63]">æ”¶</span> <span class="font-bold text-[#2A9D8F]" id="display-income">0</span></div>
                    <div><span class="text-[10px] text-[#8D6E63]">æ”¯</span> <span class="font-bold text-[#E76F51]" id="display-expense">0</span></div>
                </div>
            </div>

            <div id="chart-container" class="hidden bg-white rounded-[1.5rem] p-4 border-2 border-[#FFE8D6] mb-4">
                <div class="h-40 relative"><canvas id="expenseChart"></canvas></div>
            </div>

            <div id="transaction-list" class="grid grid-cols-3 gap-2"></div>
            <div id="empty-state" class="hidden py-20 text-center text-[#8D6E63] font-bold text-sm">é€™è£¡ç©ºç©ºçš„ (æ±ª?)</div>
        </main>

        <div id="shiba-container" class="fixed bottom-24 right-4 z-20 flex flex-col items-center" onclick="window.petShiba()">
            <div id="shiba-msg" class="hidden bg-white p-2 rounded-xl border-2 border-[#FFE8D6] text-xs font-bold mb-2 shadow-lg">æ±ªï¼</div>
            <img id="shiba-img" src="./Shiba Logo.png" class="w-16 h-16 rounded-full border-2 border-white shadow-lg animate-shiba-float transition-all duration-300">
            <div id="shiba-hat" class="hidden absolute -top-6 text-4xl pointer-events-none" style="transform: rotate(-10deg);">ğŸ©</div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-md bg-[#FFFCF5]/90 backdrop-blur-md border-t-2 border-[#FFE8D6] pb-safe pt-2 px-6 flex justify-between items-end z-30 h-20 rounded-t-[2rem]">
            <button onclick="window.toggleModal('friend-modal'); window.loadFriends()" class="flex flex-col items-center w-16 pb-2 text-[#8D6E63] active:scale-95 transition">
                <span class="text-xl">ğŸ‘¥</span><span class="text-[10px] font-bold">å¥½å‹</span>
            </button>
            
            <button onclick="window.openInputModal()" class="mb-5 bg-[#F4A261] text-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition border-4 border-[#FFFCF5]">
                <span class="text-3xl pb-1">+</span>
            </button>

            <button onclick="window.toggleModal('store-modal'); window.updateStoreUI()" class="flex flex-col items-center w-16 pb-2 text-[#8D6E63] active:scale-95 transition">
                <span class="text-xl">ğŸ </span><span class="text-[10px] font-bold">å•†åº—</span>
            </button>
        </nav>
    </div>

    <div id="input-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-black text-[#F4A261]">è¨˜ä¸€ç­†</h3>
                <button onclick="window.toggleModal('input-modal')" class="text-gray-400">âœ•</button>
            </div>
            
            <div class="flex flex-col gap-3">
                <input type="number" id="inp-amount" placeholder="é‡‘é¡" class="w-full bg-[#FFF8E1] p-3 rounded-xl text-2xl font-black text-center outline-none">
                
                <div class="flex gap-2">
                    <select id="inp-type" onchange="window.updateCats()" class="bg-white border-2 border-[#FFE8D6] rounded-xl p-2 font-bold">
                        <option value="expense">æ”¯å‡º</option>
                        <option value="income">æ”¶å…¥</option>
                    </select>
                    <select id="inp-category" class="flex-1 bg-white border-2 border-[#FFE8D6] rounded-xl p-2 font-bold"></select>
                </div>

                <input type="text" id="inp-title" placeholder="å‚™è¨» (é¸å¡«)" class="bg-white border-2 border-[#FFE8D6] p-3 rounded-xl font-bold outline-none">
                <input type="date" id="inp-date" class="bg-white border-2 border-[#FFE8D6] p-3 rounded-xl font-bold outline-none">
                
                <button onclick="window.saveTransaction()" class="w-full bg-[#F4A261] text-white font-black py-3 rounded-xl shadow-md active:translate-y-1 mt-2">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div id="friend-modal" class="modal-overlay hidden">
        <div class="modal-content h-[60vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-black text-[#4A3B32]">æŸ´å‹åˆ—è¡¨</h3>
                <button onclick="window.toggleModal('friend-modal')" class="text-gray-400">âœ•</button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <input type="tel" id="friend-id-input" placeholder="è¼¸å…¥å¥½å‹ ID" class="flex-1 bg-[#FFF8E1] p-2 rounded-xl font-bold text-center outline-none border-2 border-[#FFE8D6]">
                <button onclick="window.addFriend()" class="bg-[#F4A261] text-white px-4 rounded-xl font-bold shadow-sm">+</button>
            </div>

            <div id="friend-list" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="store-modal" class="modal-overlay hidden">
        <div class="modal-content h-[70vh]">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-black text-[#4A3B32]">å•†åº—</h3>
                <div class="bg-[#FFF0D4] px-2 py-1 rounded-lg font-black text-[#F4A261]">ğŸ¦´ <span id="store-coins">0</span></div>
            </div>
            <button onclick="window.toggleModal('store-modal')" class="absolute top-4 right-4 text-gray-400">âœ•</button>

            <div class="grid grid-cols-2 gap-3 overflow-y-auto mt-4 pb-2">
                <div class="bg-white border-2 border-[#FFE8D6] rounded-xl p-3 text-center">
                    <div class="text-3xl mb-1">ğŸ¥©</div>
                    <div class="font-bold text-sm mb-1">è‚‰ç½é ­</div>
                    <button id="btn-meat" onclick="window.buyItem(50, 'meat')" class="w-full bg-[#F4A261] text-white text-xs py-1 rounded-lg font-bold">50 ğŸ¦´</button>
                </div>
                <div class="bg-white border-2 border-[#FFE8D6] rounded-xl p-3 text-center">
                    <div class="text-3xl mb-1">ğŸ©</div>
                    <div class="font-bold text-sm mb-1">ç´³å£«å¸½</div>
                    <button id="btn-hat" onclick="window.buyItem(200, 'hat')" class="w-full bg-[#2A9D8F] text-white text-xs py-1 rounded-lg font-bold">200 ğŸ¦´</button>
                </div>
                <div class="bg-white border-2 border-[#FFE8D6] rounded-xl p-3 text-center">
                    <div class="text-3xl mb-1">ğŸ•â€ğŸ¦º</div>
                    <div class="font-bold text-sm mb-1">é»‘æŸ´</div>
                    <button id="btn-black" onclick="window.buyItem(500, 'black')" class="w-full bg-[#4A3B32] text-white text-xs py-1 rounded-lg font-bold">500 ğŸ¦´</button>
                </div>
                <div class="bg-white border-2 border-[#FFE8D6] rounded-xl p-3 text-center">
                    <div class="text-3xl mb-1">ğŸš«</div>
                    <div class="font-bold text-sm mb-1">å»å»£å‘Š</div>
                    <button id="btn-noads" onclick="window.buyItem(1000, 'noads')" class="w-full bg-[#E76F51] text-white text-xs py-1 rounded-lg font-bold">1000 ğŸ¦´</button>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button onclick="window.toggleModal('detail-modal')" class="absolute top-4 right-4 text-gray-400">âœ•</button>
            <div class="text-center mt-2">
                <div id="detail-emoji" class="text-6xl mb-2">ğŸ”</div>
                <h3 id="detail-title" class="text-xl font-black">åˆé¤</h3>
                <div id="detail-amount" class="text-3xl font-black text-[#E76F51] my-2">$100</div>
                <div id="detail-date" class="text-sm text-gray-400 font-bold">2023-10-10</div>
            </div>
            <button onclick="window.deleteCurrentDetail()" class="mt-6 w-full border-2 border-red-100 text-red-400 font-bold py-2 rounded-xl">åˆªé™¤ç´€éŒ„</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, deleteDoc, updateDoc, doc, getDoc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQRVE28OmopT1v6hybciDaigW4-9GaVzY", authDomain: "fma-cloud.firebaseapp.com", projectId: "fma-cloud", storageBucket: "fma-cloud.firebasestorage.app", messagingSenderId: "496004687854", appId: "1:496004687854:web:fb40424dabe2f1566a10ff", measurementId: "G-MTPV76EV3R" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentViewUid = null;
        let transactions = [];
        let myProfile = {};
        let currentDetailId = null;

        const cats = { expense: ['é¤é£²','äº¤é€š','è³¼ç‰©','å¨›æ¨‚','å±…ä½','é†«ç™‚','æ•™è‚²','å…¶ä»–'], income: ['è–ªè³‡','çé‡‘','æŠ•è³‡','å…¼è·'] };
        const icons = { 'é¤é£²':'ğŸ”','äº¤é€š':'ğŸš—','è³¼ç‰©':'ğŸ›ï¸','å¨›æ¨‚':'ğŸ®','å±…ä½':'ğŸ ','é†«ç™‚':'ğŸ’Š','æ•™è‚²':'ğŸ“š','å…¶ä»–':'âœ¨','è–ªè³‡':'ğŸ’°','çé‡‘':'ğŸ§§','æŠ•è³‡':'ğŸ“ˆ','å…¼è·':'ğŸ’¼' };

        // --- å…¨åŸŸå‡½å¼ç¶å®š (é—œéµ) ---
        window.startApp = () => {
            document.getElementById('start-overlay').classList.add('hidden');
            setTimeout(() => {
                if(!currentUser) document.getElementById('login-screen').classList.remove('hidden');
            }, 500);
        };

        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        };

        window.updateCats = () => {
            const type = document.getElementById('inp-type').value;
            const sel = document.getElementById('inp-category');
            sel.innerHTML = cats[type].map(c => `<option value="${c}">${c}</option>`).join('');
        };

        window.openInputModal = () => {
            document.getElementById('inp-amount').value = '';
            document.getElementById('inp-title').value = '';
            document.getElementById('inp-date').valueAsDate = new Date();
            window.updateCats();
            window.toggleModal('input-modal');
        };

        // ğŸ”¥ è¨˜å¸³æ ¸å¿ƒ (ä¿®å¾©)
        window.saveTransaction = async () => {
            const amt = document.getElementById('inp-amount').value;
            if(!amt) return alert("è«‹è¼¸å…¥é‡‘é¡");
            
            const data = {
                amount: Number(amt),
                type: document.getElementById('inp-type').value,
                category: document.getElementById('inp-category').value,
                title: document.getElementById('inp-title').value || document.getElementById('inp-category').value,
                dateTimestamp: document.getElementById('inp-date').valueAsDate.getTime(),
                date: document.getElementById('inp-date').value
            };

            try {
                await addDoc(collection(db, "users", currentUser.uid, "transactions"), data);
                await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: increment(10) });
                myProfile.boneCoins += 10; // æœ¬åœ°æ›´æ–°
                alert("è¨˜å¸³æˆåŠŸï¼+10 ğŸ¦´");
                window.toggleModal('input-modal');
            } catch(e) {
                alert("éŒ¯èª¤ï¼š" + e.message);
            }
        };

        // ğŸ”¥ è³¼è²·æ ¸å¿ƒ (ä¿®å¾©)
        window.buyItem = async (price, item, btnId) => {
            if((myProfile.boneCoins || 0) < price) return alert("éŒ¢ä¸å¤ å•¦ (æ±ª!)");
            if(myProfile.inventory && myProfile.inventory[item] && item !== 'meat') return alert("å·²ç¶“è²·éäº†ï¼");
            if(item === 'meat' && myProfile.lastMeat === new Date().toDateString()) return alert("ä»Šå¤©åƒéäº†ï¼");

            if(!confirm(`ç¢ºå®šèŠ±è²» ${price} è²·é€™å€‹å—ï¼Ÿ`)) return;

            // æœ¬åœ°å…ˆæ‰£
            if(!myProfile.inventory) myProfile.inventory = {};
            if(item !== 'meat') myProfile.inventory[item] = true;
            if(item === 'meat') myProfile.lastMeat = new Date().toDateString();
            myProfile.boneCoins -= price;

            window.updateStoreUI(); // ç«‹å³åˆ·æ–°æŒ‰éˆ•

            // å¯«å…¥ DB
            const updates = { boneCoins: increment(-price) };
            if(item === 'meat') updates.lastMeat = myProfile.lastMeat;
            else updates[`inventory.${item}`] = true;
            
            await updateDoc(doc(db, "users", currentUser.uid), updates);
            alert("è³¼è²·æˆåŠŸï¼");
            window.applySkin();
        };

        window.updateStoreUI = () => {
            document.getElementById('store-coins').innerText = myProfile.boneCoins || 0;
            const setBtn = (id, cond) => {
                const btn = document.getElementById(id);
                if(cond) { btn.classList.add('sold-out'); btn.innerText = "å·²æ“æœ‰/ä¸Šé™"; btn.disabled = true; }
                else { btn.classList.remove('sold-out'); btn.disabled = false; }
            };
            setBtn('btn-meat', myProfile.lastMeat === new Date().toDateString());
            setBtn('btn-hat', myProfile.inventory?.hat);
            setBtn('btn-black', myProfile.inventory?.black);
            setBtn('btn-noads', myProfile.inventory?.noads);
        };

        window.applySkin = () => {
            if(myProfile.inventory?.hat) document.getElementById('shiba-hat').classList.remove('hidden');
            if(myProfile.inventory?.black) document.getElementById('shiba-img').classList.add('black-shiba-filter');
        };

        // ğŸ”¥ å¥½å‹æ ¸å¿ƒ (ä¿®å¾©)
        window.loadFriends = () => {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            
            // è‡ªå·±
            const me = document.createElement('div');
            me.className = "bg-[#FFF0D4] p-3 rounded-xl flex items-center gap-3 border-2 border-[#F4A261] cursor-pointer";
            me.innerHTML = `<div class="font-bold flex-1">æˆ‘çš„ç›¸ç°¿</div><div class="text-xs font-mono">${myProfile.shortId}</div>`;
            me.onclick = () => window.switchView(currentUser.uid, 'æˆ‘çš„ç›¸ç°¿');
            list.appendChild(me);

            const q = query(collection(db, "users", currentUser.uid, "friends"));
            onSnapshot(q, (snap) => {
                // æ¸…é™¤é™¤äº†è‡ªå·±ä»¥å¤–çš„
                while(list.children.length > 1) list.removeChild(list.lastChild);
                
                snap.forEach(d => {
                    const f = d.data();
                    const row = document.createElement('div');
                    row.className = "bg-white p-3 rounded-xl flex items-center gap-3 border-2 border-[#FFE8D6] cursor-pointer";
                    row.innerHTML = `<div class="font-bold flex-1">${f.name}</div><button onclick="event.stopPropagation();window.deleteFriend('${f.uid}')" class="text-red-400">åˆª</button>`;
                    row.onclick = () => window.switchView(f.uid, f.name);
                    list.appendChild(row);
                });
            });
        };

        window.addFriend = async () => {
            const id = document.getElementById('friend-id-input').value;
            if(id === myProfile.shortId) return alert("ä¸èƒ½åŠ è‡ªå·±");
            const snap = await getDoc(doc(db, "public_codes", id));
            if(!snap.exists()) return alert("æ‰¾ä¸åˆ° ID");
            const target = snap.data();
            
            await setDoc(doc(db, "users", currentUser.uid, "friends", target.uid), { uid: target.uid, name: "æ–°å¥½å‹" });
            await setDoc(doc(db, "users", target.uid, "friends", currentUser.uid), { uid: currentUser.uid, name: myProfile.name });
            alert("æ·»åŠ æˆåŠŸï¼");
        };

        window.deleteFriend = async (uid) => {
             if(confirm("åˆªé™¤å¥½å‹ï¼Ÿ")) await deleteDoc(doc(db, "users", currentUser.uid, "friends", uid));
        };

        window.switchView = (uid, title) => {
            currentViewUid = uid;
            document.getElementById('header-title').innerText = title;
            document.getElementById('filter-type').value = 'all'; // å¼·åˆ¶å…¨é¸
            loadTransactions(uid);
            window.toggleModal('friend-modal');
        };

        // ç™»å…¥ç›£è½
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                currentViewUid = user.uid;
                
                // è®€å–/å»ºç«‹ä½¿ç”¨è€…è³‡æ–™
                const ref = doc(db, "users", user.uid);
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    myProfile = snap.data();
                } else {
                    const shortId = Math.floor(100000 + Math.random()*900000).toString();
                    myProfile = { name: user.displayName, email: user.email, photo: user.photoURL, boneCoins: 100, shortId: shortId, inventory: {} };
                    await setDoc(ref, myProfile);
                    await setDoc(doc(db, "public_codes", shortId), { uid: user.uid });
                }

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                loadTransactions(user.uid);
                window.applySkin();
            } else {
                 if (document.getElementById('start-overlay').classList.contains('hidden')) {
                    document.getElementById('login-screen').classList.remove('hidden');
                 }
            }
        });

        // è®€å–äº¤æ˜“ (å³æ™‚)
        function loadTransactions(uid) {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "users", uid, "transactions"), orderBy("dateTimestamp", "desc"));
            
            unsubscribe = onSnapshot(q, (snap) => {
                transactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                window.updateUI();
            });
        }

        // UI æ¸²æŸ“
        window.updateUI = () => {
            const container = document.getElementById('transaction-list');
            container.innerHTML = '';
            
            const filter = document.getElementById('filter-type').value;
            const now = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            const month = now.slice(0, 7); // YYYY-MM
            
            let filtered = transactions;
            if(filter === 'month') filtered = transactions.filter(t => t.date.startsWith(month));
            if(filter === 'day') filtered = transactions.filter(t => t.date === now);

            let inc = 0, exp = 0;
            const labels = [], data = [];
            const catMap = {};

            if(filtered.length === 0) document.getElementById('empty-state').classList.remove('hidden');
            else document.getElementById('empty-state').classList.add('hidden');

            filtered.forEach(t => {
                if(t.type === 'income') inc += t.amount;
                else {
                    exp += t.amount;
                    catMap[t.category] = (catMap[t.category] || 0) + t.amount;
                }
                
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-2xl shadow-sm border border-[#FFE8D6] text-center flex flex-col items-center justify-center aspect-square";
                div.innerHTML = `<div class="text-3xl mb-1">${icons[t.category] || 'âœ¨'}</div><div class="text-xs font-bold truncate w-full">${t.title}</div><div class="text-xs ${t.type==='income'?'text-teal-500':'text-orange-500'}">$${t.amount}</div>`;
                div.onclick = () => window.openDetail(t);
                container.appendChild(div);
            });

            document.getElementById('display-balance').innerText = inc - exp;
            document.getElementById('display-income').innerText = inc;
            document.getElementById('display-expense').innerText = exp;
            
            // Chart Update
            renderChart(catMap);
        };

        let myChart;
        function renderChart(dataObj) {
             const ctx = document.getElementById('expenseChart').getContext('2d');
             if(myChart) myChart.destroy();
             myChart = new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                     labels: Object.keys(dataObj),
                     datasets: [{ data: Object.values(dataObj), backgroundColor: ['#F4A261','#E76F51','#2A9D8F','#E9C46A'] }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
             });
        }
        
        window.openDetail = (t) => {
            currentDetailId = t.id;
            document.getElementById('detail-emoji').innerText = icons[t.category] || 'âœ¨';
            document.getElementById('detail-title').innerText = t.title;
            document.getElementById('detail-amount').innerText = '$' + t.amount;
            document.getElementById('detail-date').innerText = t.date;
            window.toggleModal('detail-modal');
        };

        window.deleteCurrentDetail = async () => {
            if(!confirm("åˆªé™¤ï¼Ÿ")) return;
            await deleteDoc(doc(db, "users", currentUser.uid, "transactions", currentDetailId));
            window.toggleModal('detail-modal');
        };

        // ç™»å…¥äº‹ä»¶ç¶å®š
        document.getElementById('btn-google-login').onclick = () => signInWithPopup(auth, provider);
        
        // ç¢ºä¿ Chart è¼‰å…¥
        Chart.register(ChartDataLabels);
    </script>
</body>
</html>

