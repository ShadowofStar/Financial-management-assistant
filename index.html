<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ´ç®¡å®¶ - çµ•å°å•Ÿå‹•ç‰ˆ</title>
    
    <link rel="icon" type="image/png" href="./Shiba Logo.png">
    <link rel="shortcut icon" href="./Shiba Logo.png">
    <link rel="apple-touch-icon" href="./Shiba Logo.png">
    <meta name="theme-color" content="#FFFCF5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/zh-tw.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: pan-y; user-select: none; overscroll-behavior-y: none; overflow-x: hidden; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .slide-in-left { animation: slideInLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .slide-in-right { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        :root { --shiba-bg: #FFFCF5; --shiba-orange: #F4A261; --shiba-brown: #4A3B32; }

        @keyframes shiba-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        .animate-shiba-float { animation: shiba-float 3s ease-in-out infinite; }
        
        @keyframes shiba-bounce { 0%, 100% { transform: scale(1) rotate(0deg); } 40% { transform: scale(1.15) rotate(5deg); } 80% { transform: scale(0.95) rotate(-3deg); } }
        .animate-shiba-bounce { animation: shiba-bounce 0.4s ease-out; }
        @keyframes coin-drop { 0% { transform: translateY(-50px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(0); opacity: 1; } }
        .animate-coin { animation: coin-drop 0.5s ease-out forwards; }
        @keyframes heart-float { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-40px) scale(1.5); opacity: 0; } }
        .animate-heart { position: absolute; animation: heart-float 0.8s ease-out forwards; pointer-events: none; font-size: 24px; z-index: 50; }

        .music-playing { animation: pulse-music 1.2s infinite; border-color: #F4A261 !important; color: #F4A261 !important; background: #FFF !important; }
        @keyframes pulse-music { 0% { box-shadow: 0 0 0 0 rgba(244, 162, 97, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(244, 162, 97, 0); } 100% { box-shadow: 0 0 0 0 rgba(244, 162, 97, 0); } }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #F4A261; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid white; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #FFE8D6; border-radius: 4px; }
        
        .black-shiba-filter { filter: grayscale(100%) brightness(0.6) contrast(1.2); }
        .sold-out { opacity: 0.6 !important; pointer-events: none !important; background-color: #BDBDBD !important; color: #FFFFFF !important; box-shadow: none !important; border: none !important; cursor: not-allowed !important; }
        
        #friend-panel, #store-panel, #input-panel { will-change: transform; }
    </style>
</head>
<body class="bg-[#FFFCF5] text-[#4A3B32] min-h-screen selection:bg-[#F4A261] selection:text-white">

    <audio id="bg-music" loop crossorigin="anonymous">
        <source src="./[J&B No Copyright Music] Yummy Flavor Background Music.mp3" type="audio/mpeg">
    </audio>

    <div id="start-overlay" class="fixed inset-0 bg-[#FFFCF5] z-[100] flex flex-col items-center justify-center fade-in">
        <img src="./Shiba Logo.png" class="w-32 h-32 rounded-[2rem] shadow-xl mb-6 animate-shiba-float border-4 border-white">
        <h2 class="text-2xl font-black text-[#4A3B32] mb-2">æ­¡è¿ä¾†åˆ°æŸ´ç®¡å®¶</h2>
        <p class="text-[#8D6E63] text-sm font-bold mb-8">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•ŸéŸ³æ•ˆé«”é©— ğŸµ</p>
        <button id="btn-start-app" class="bg-[#F4A261] text-white text-lg font-black py-4 px-12 rounded-2xl shadow-[0_4px_0_#E76F51] active:translate-y-1 active:shadow-none transition-all animate-bounce">é€²å…¥ App</button>
    </div>

    <div id="login-screen" class="fixed inset-0 bg-[#FFFCF5] z-50 flex flex-col items-center justify-center p-6 text-center">
        <div class="relative"><div class="absolute -inset-4 bg-[#F4A261] rounded-full opacity-20 blur-xl"></div><img src="./Shiba Logo.png" class="relative w-32 h-32 rounded-[2rem] shadow-xl mb-6 object-cover border-4 border-white"></div>
        <h1 class="text-3xl font-black text-[#4A3B32] mb-2 tracking-tight">æŸ´ç®¡å®¶</h1><p class="text-[#8D6E63] mb-10 font-bold">è®“è¨˜å¸³è®Šå¾—å¯æ„›åˆç°¡å–®</p>
        <button id="btn-google-login" class="w-full max-w-sm bg-white border-2 border-[#F4A261] text-[#4A3B32] font-bold py-4 px-4 rounded-2xl shadow-[0_4px_0_#F4A261] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center gap-3"><img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
    </div>

    <div id="app-screen" class="hidden max-w-md mx-auto min-h-screen bg-[#FFFCF5] relative overflow-hidden flex flex-col shadow-2xl">
        <header class="bg-[#FFFCF5]/95 px-5 pt-12 pb-2 flex items-center justify-between sticky top-0 z-10 backdrop-blur-md">
            <button onclick="toggleMusic()" id="music-btn" class="text-xl w-9 h-9 flex items-center justify-center rounded-full bg-[#FFF0D4] text-[#8D6E63] border-2 border-[#FFE8D6] shadow-sm transition active:scale-95">ğŸ”‡</button>
            <div class="flex flex-col items-center">
                <div class="flex items-center gap-2"><h1 id="header-title" class="text-2xl font-black text-[#4A3B32] tracking-tight">æˆ‘çš„ç›¸ç°¿</h1></div>
                <div class="flex items-center gap-1 mt-1 text-xs text-[#8D6E63] font-bold cursor-pointer bg-[#FFF0D4] px-2 py-1 rounded-lg w-fit transition active:scale-95" onclick="openUserProfile(window.currentUser ? window.currentUser.uid : null)"><span id="current-view-label">å€‹äºº</span><span class="text-[#F4A261]">|</span><span id="my-short-id" class="font-mono">ID...</span></div>
            </div>
            <div class="flex gap-2">
                <div class="bg-white border-2 border-[#FFE8D6] p-0.5 rounded-xl flex text-xs font-bold relative shadow-sm">
                    <select id="filter-type" onchange="changeFilterMode()" class="bg-transparent appearance-none px-2 py-1.5 text-[#8D6E63] focus:outline-none z-10 relative cursor-pointer"><option value="day">æ—¥</option><option value="month" selected>æœˆ</option><option value="year">å¹´</option><option value="all">å…¨</option></select>
                    <div class="pr-1 text-[#F4A261]">â–¼</div>
                    <input type="month" id="filter-month" class="absolute inset-0 opacity-0 cursor-pointer"><input type="date" id="filter-day" class="absolute inset-0 opacity-0 cursor-pointer hidden"><select id="filter-year" class="absolute inset-0 opacity-0 cursor-pointer hidden"></select>
                </div>
                <button onclick="toggleSettingsModal()" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border-2 border-[#FFE8D6] text-[#8D6E63] shadow-sm active:scale-95 text-lg">âš™ï¸</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-32 no-scrollbar" id="main-content">
            <div class="px-5 mt-2 mb-4">
                <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border-2 border-[#FFE8D6] flex justify-between items-center relative overflow-hidden" onclick="toggleChart()">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#FFF0D4] rounded-full opacity-50"></div>
                    <div class="relative z-10"><div class="text-[10px] text-[#8D6E63] font-bold uppercase tracking-wider mb-1">æœ¬æœˆçµé¤˜</div><div class="text-3xl font-black text-[#4A3B32] flex items-baseline"><span class="text-sm font-bold mr-1 text-[#F4A261]">$</span><span id="display-balance">0</span></div></div>
                    <div class="flex gap-4 text-right relative z-10"><div><div class="text-[10px] text-[#8D6E63] mb-0.5">æ”¶</div><div class="font-bold text-[#2A9D8F] text-sm" id="display-income">0</div></div><div><div class="text-[10px] text-[#8D6E63] mb-0.5">æ”¯</div><div class="font-bold text-[#E76F51] text-sm" id="display-expense">0</div></div></div>
                </div>
                <div id="chart-container" class="hidden bg-white mt-2 rounded-[1.5rem] p-4 border-2 border-[#FFE8D6] fade-in"><div class="flex items-center gap-3"><div class="w-[45%] h-32 relative"><canvas id="expenseChart"></canvas><p id="chart-placeholder" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#8D6E63] text-xs font-bold">ç„¡æ•¸æ“š</p></div><div id="chart-legend" class="w-[55%] space-y-1.5 max-h-32 overflow-y-auto text-xs pr-1"></div></div></div>
            </div>
            <div id="transaction-list" class="grid grid-cols-3 gap-1.5 px-3"></div>
            <div id="empty-state" class="hidden py-16 text-center"><img src="./Shiba Logo.png" class="w-20 h-20 mx-auto mb-4 opacity-40 grayscale rounded-2xl"><p class="text-[#8D6E63] text-sm font-bold">æ±ªï¼Ÿé€™è£¡æ²’æœ‰æ±è¥¿å–”</p><button onclick="openInputModal()" class="mt-2 text-[#F4A261] text-xs font-bold hover:underline">å»è¨˜ä¸€ç­† (+10éª¨é ­å¹£)</button></div>
        </main>

        <div id="shiba-assistant-container" class="fixed bottom-[100px] right-4 z-40 pointer-events-auto group flex flex-col items-center">
             <div id="shiba-speech" class="hidden absolute bottom-full mb-3 right-0 bg-white p-3 rounded-2xl shadow-lg border-2 border-[#FFE8D6] text-xs font-black text-[#4A3B32] whitespace-nowrap scale-in origin-bottom-right">æ±ªï¼ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼<div class="absolute -bottom-1.5 right-6 w-3 h-3 bg-white border-b-2 border-r-2 border-[#FFE8D6] rotate-45"></div></div>
             
             <div id="shiba-container-anim" class="relative animate-shiba-float" onclick="triggerShibaClick()">
                 <div id="shiba-hat-gentleman" class="hidden absolute -top-5 left-1/2 text-5xl z-50 pointer-events-none drop-shadow-xl" style="transform: translateX(-50%) rotate(-10deg); transform-origin: bottom center;">ğŸ©</div>
                 <div id="shiba-hat-cap" class="hidden absolute -top-5 left-1/2 text-5xl z-50 pointer-events-none drop-shadow-xl" style="transform: translateX(-50%) rotate(-5deg); transform-origin: bottom center;">ğŸ§¢</div>
                 <div id="shiba-hat-crown" class="hidden absolute -top-8 left-1/2 text-6xl z-50 pointer-events-none drop-shadow-xl" style="transform: translateX(-50%) rotate(0deg); transform-origin: bottom center;">ğŸ‘‘</div>
                 
                 <img src="./Shiba Logo.png" id="shiba-assistant" class="w-20 h-20 rounded-full border-2 border-white shadow-md object-cover cursor-pointer hover:scale-105 transition-transform z-10">
                 
                 <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-white px-2 py-0.5 rounded-full border border-[#FFE8D6] shadow-sm flex items-center gap-1 z-30">
                     <span id="mood-icon" class="text-[10px]">â¤ï¸</span>
                     <div class="w-10 h-1.5 bg-[#E0E0E0] rounded-full overflow-hidden">
                         <div id="mood-bar" class="h-full bg-[#FF7096] w-full transition-all duration-500"></div>
                     </div>
                 </div>
             </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-md bg-[#FFFCF5]/95 backdrop-blur-md border-t-2 border-[#FFE8D6] pb-safe pt-2 px-8 flex justify-between items-end z-30 h-[88px] rounded-t-[2rem]">
            <button onclick="toggleFriendModal()" class="flex flex-col items-center gap-1 w-16 pb-3 text-[#4A3B32] transition hover:scale-105 active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span class="text-[11px] font-black">å¥½å‹</span></button>
            <button id="fab-btn" onclick="openInputModal()" class="mb-6 bg-[#F4A261] text-white rounded-2xl w-14 h-14 shadow-[0_6px_20px_rgba(244,162,97,0.4)] flex items-center justify-center transform transition active:scale-90 hover:bg-[#E76F51] hover:-translate-y-1 border-4 border-[#FFFCF5]"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg></button>
            <button onclick="toggleStoreModal()" class="flex flex-col items-center gap-1 w-16 pb-3 text-[#4A3B32] transition hover:scale-105 active:scale-95 group"><div class="relative"><svg class="w-6 h-6 group-hover:text-[#F4A261] transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg><div class="absolute -top-1 -right-1 w-2 h-2 bg-[#E76F51] rounded-full hidden"></div></div><span class="text-[11px] font-black group-hover:text-[#F4A261] transition">å•†åº—</span></button>
        </nav>

        <div id="settings-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-center justify-center p-6 fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleSettingsModal()"></div><div class="bg-[#FFFCF5] w-full max-w-sm rounded-[2.5rem] p-6 relative z-10 shadow-2xl scale-in border-4 border-white"><div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-black text-[#4A3B32]">ç³»çµ±è¨­å®š</h2><button onclick="toggleSettingsModal()" class="text-[#8D6E63] text-xl font-bold bg-[#FFE8D6] w-8 h-8 rounded-full flex items-center justify-center">Ã—</button></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] mb-4"><div class="flex justify-between items-center mb-2"><span class="font-bold text-[#4A3B32] text-sm">ğŸµ èƒŒæ™¯éŸ³æ¨‚</span><span class="text-xs text-[#8D6E63] font-bold" id="bgm-val-display">50%</span></div><input type="range" min="0" max="1" step="0.05" value="0.5" oninput="updateBGMVolume(this.value)"></div><div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] mb-6"><div class="flex justify-between items-center mb-2"><span class="font-bold text-[#4A3B32] text-sm">ğŸ”Š æŒ‰éˆ•éŸ³æ•ˆ</span><span class="text-xs text-[#8D6E63] font-bold" id="sfx-val-display">50%</span></div><input type="range" min="0" max="1" step="0.05" value="0.5" oninput="updateSFXVolume(this.value)"></div><div class="text-center text-xs text-[#8D6E63] opacity-60 font-bold">ShibaManager v6.8 Absolute Fix</div></div></div>
        
        <div id="store-modal" class="fixed inset-0 bg-[#4A3B32]/50 z-50 hidden flex items-center justify-end fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="toggleStoreModal()"></div>
            <div id="store-panel" class="bg-[#FFFCF5] w-4/5 max-w-sm h-full flex flex-col relative z-10 slide-in-right shadow-2xl rounded-l-[2rem]" style="touch-action: pan-y;">
                <div class="p-6 pb-2 flex justify-between items-center border-b-2 border-[#FFE8D6]"><div><h2 class="text-2xl font-black text-[#4A3B32]">æŸ´æŸ´é›œè²¨èˆ–</h2><p class="text-xs text-[#8D6E63] font-bold">æ¶ˆè²»è®“ç”Ÿæ´»æ›´ç¾å¥½</p></div><div class="bg-[#FFF0D4] px-3 py-1.5 rounded-xl flex items-center gap-2 border border-[#F4A261]"><span class="text-xl">ğŸ¦´</span><span id="store-coin-count" class="font-black text-[#F4A261] text-lg">0</span></div></div>
                <div class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 no-scrollbar">
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ¥©</div><h3 class="font-black text-[#4A3B32] mb-1">é«˜ç´šè‚‰ç½é ­</h3><p class="text-[10px] text-[#8D6E63] mb-3">å¿ƒæƒ…å…¨æ»¿ (é™1æ¬¡/æ—¥)</p><button id="btn-buy-meat" onclick="buyItem(50, 'meat')" class="w-full bg-[#F4A261] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#E76F51] transition">50 ğŸ¦´ è³¼è²·</button></div>
                    
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ©</div><h3 class="font-black text-[#4A3B32] mb-1">ç´³å£«å¸½å­</h3><p class="text-[10px] text-[#8D6E63] mb-3">å„ªé›…é¢¨æ ¼</p><button id="btn-buy-hat" onclick="buyItem(200, 'hat')" class="w-full bg-[#2A9D8F] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#264653] transition">200 ğŸ¦´ è³¼è²·</button></div>
                    
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ§¢</div><h3 class="font-black text-[#4A3B32] mb-1">é‹å‹•é´¨èˆŒå¸½</h3><p class="text-[10px] text-[#8D6E63] mb-3">ä¼‘é–’é¢¨æ ¼</p><button id="btn-buy-cap" onclick="buyItem(500, 'cap')" class="w-full bg-[#4A3B32] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-black transition">500 ğŸ¦´ è³¼è²·</button></div>
                    
                    <div class="bg-white p-4 rounded-2xl border-2 border-[#FFE8D6] flex flex-col items-center text-center shadow-sm"><div class="text-4xl mb-2">ğŸ‘‘</div><h3 class="font-black text-[#4A3B32] mb-1">å°Šçˆµçš‡å† </h3><p class="text-[10px] text-[#8D6E63] mb-3">ç‹è€…é¢¨ç¯„</p><button id="btn-buy-crown" onclick="buyItem(1000, 'crown')" class="w-full bg-[#E76F51] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-red-600 transition">1000 ğŸ¦´ è³¼è²·</button></div>
                </div>
                <div class="p-4 border-t border-[#FFE8D6]"><button onclick="toggleStoreModal()" class="w-full bg-[#FFE8D6] text-[#8D6E63] py-3 rounded-xl font-bold hover:bg-[#F4A261] hover:text-white transition">é—œé–‰å•†åº—</button></div>
            </div>
        </div>

        <div id="input-modal" class="fixed inset-0 bg-[#4A3B32]/40 z-50 hidden flex flex-col justify-end fade-in backdrop-blur-sm"><div class="absolute inset-0" onclick="closeInputModal()"></div><div id="input-panel" class="bg-[#FFFCF5] w-full rounded-t-[2.5rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] slide-up relative z-10 pb-safe transition-transform duration-100 ease-out">
            <div id="modal-handle-area" class="w-full h-8 absolute top-0 left-0 z-20 flex justify-center pt-3 cursor-grab active:cursor-grabbing"><div class="w-12 h-1.5 bg-[#FFE8D6] rounded-full pointer-events-none"></div></div>
            <div class="mt-4 mb-6 flex justify-between items-center"><button onclick="closeInputModal()" class="text-[#8D6E63] text-sm font-bold p-2 hover:bg-[#FFE8D6] rounded-lg">å–æ¶ˆ</button><h2 class="text-sm font-black text-[#F4A261] uppercase tracking-widest" id="form-title">è¨˜ä¸€ç­†</h2><button onclick="triggerSubmit()" class="text-[#E76F51] text-sm font-bold p-2 hover:bg-[#FFE8D6] rounded-lg">å®Œæˆ</button></div><form id="transaction-form" class="flex flex-col gap-5"><div class="relative group"><span class="absolute left-6 top-1/2 -translate-y-1/2 text-2xl text-[#F4A261] font-bold">$</span><input type="number" id="inp-amount" placeholder="0" class="w-full bg-white border-2 border-[#FFE8D6] rounded-2xl py-4 pl-12 pr-4 text-4xl font-black text-[#4A3B32] text-center focus:ring-4 focus:ring-[#F4A261]/20 focus:border-[#F4A261] transition-all outline-none" required inputmode="decimal"></div><div class="bg-[#FFF0D4] p-1.5 rounded-2xl flex"><select id="inp-type" onchange="updateCategoryOptions()" class="bg-white rounded-xl shadow-sm w-24 text-center text-sm font-bold text-[#4A3B32] focus:outline-none py-3 border border-[#FFE8D6]"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select><select id="inp-category" class="flex-1 bg-transparent px-4 text-sm font-bold text-[#4A3B32] focus:outline-none text-center"></select><button type="button" onclick="addCustomCategory()" class="px-3 text-[#E76F51] font-black text-lg hover:bg-white/50 rounded-lg">+</button></div><div class="flex gap-3"><input type="date" id="inp-date" class="bg-white border-2 border-[#FFE8D6] rounded-2xl px-4 py-3.5 text-sm font-bold text-[#4A3B32] w-1/3 focus:border-[#F4A261] outline-none"><input type="text" id="inp-title" placeholder="å‚™è¨»..." class="flex-1 bg-white border-2 border-[#FFE8D6] rounded-2xl px-4 py-3.5 text-sm font-bold text-[#4A3B32] focus:border-[#F4A261] outline-none placeholder-[#D7CCC8]"></div><div class="flex gap-3"><input type="file" id="inp-photo" accept="image/*" onchange="handlePhotoSelect(event)" class="hidden"><label for="inp-photo" id="btn-camera" class="w-full border-2 border-dashed border-[#F4A261]/50 bg-[#FFF8E1] rounded-2xl py-3 flex items-center justify-center gap-2 text-[#F4A261] cursor-pointer hover:bg-[#F4A261] hover:text-white transition"><span class="text-xl">ğŸ“·</span><span class="text-xs font-bold">æ‹å¼µç…§</span></label><div id="preview-container" class="hidden relative w-full h-24"><img id="img-preview" class="w-full h-full object-cover rounded-2xl border-2 border-[#F4A261]"><button type="button" onclick="clearPhoto()" class="absolute -top-2 -right-2 bg-[#E76F51] text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-md">Ã—</button></div></div></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, deleteDoc, updateDoc, doc, getDoc, onSnapshot, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQRVE28OmopT1v6hybciDaigW4-9GaVzY", authDomain: "fma-cloud.firebaseapp.com", projectId: "fma-cloud", storageBucket: "fma-cloud.firebasestorage.app", messagingSenderId: "496004687854", appId: "1:496004687854:web:fb40424dabe2f1566a10ff", measurementId: "G-MTPV76EV3R" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();
        const DEFAULT_AVATAR = './Shiba Logo.png';
        
        let audioCtx, bgmGainNode, bgmSource;
        let globalBGMVolume = 0.5; let globalSFXVolume = 0.5; let isMusicPlaying = false;

        // ğŸ”¥ ç¶å®šåˆ° window ç¢ºä¿ HTML onclick æ‰¾å¾—åˆ°
        window.initAudio = () => { if (!audioCtx) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); bgmGainNode = audioCtx.createGain(); bgmGainNode.gain.value = globalBGMVolume; bgmGainNode.connect(audioCtx.destination); const bgMusic = document.getElementById('bg-music'); bgmSource = audioCtx.createMediaElementSource(bgMusic); bgmSource.connect(bgmGainNode); } if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playPop = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); };
        const playBark = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15); };
        const playCoin = () => { if (!audioCtx) window.initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1 * globalSFXVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); };
        
        // ğŸ”¥ ç¶å®šåˆ° window ç¢ºä¿ HTML onclick æ‰¾å¾—åˆ°
        window.startApp = () => { 
            // 1. å¼·åˆ¶éš±è—æ­¡è¿ç•«é¢
            const overlay = document.getElementById('start-overlay');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            
            // 2. å˜—è©¦æ’­æ”¾éŸ³æ¨‚ (å°±ç®—å¤±æ•—ä¹Ÿä¸æœƒå¡ä½ç•«é¢)
            try {
                window.initAudio(); 
                const bgMusic = document.getElementById('bg-music'); 
                bgMusic.play().then(() => { 
                    isMusicPlaying = true; 
                    const btn = document.getElementById('music-btn'); 
                    btn.innerText = "ğŸµ"; 
                    btn.classList.add('music-playing'); 
                }).catch(e => console.log("Audio play failed (normal in some browsers):", e));
            } catch(e) { console.error(e); }
        };

        // ğŸ”¥ ä¸‹é¢é€™æ®µ onAuthStateChanged æœƒåœ¨èƒŒæ™¯è‡ªå‹•åˆ‡æ›ã€Œç™»å…¥é ã€æˆ–ã€Œä¸»ç•«é¢ã€
        // ğŸ”¥ å› ç‚º startApp å·²ç¶“æŠŠæ­¡è¿é é—œæ‰äº†ï¼Œæ‰€ä»¥ä½¿ç”¨è€…æœƒç›´æ¥çœ‹åˆ°ä¸‹é¢é€™å…©è€…ä¹‹ä¸€
        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');

            if (user) {
                // å·²ç™»å…¥ï¼šé¡¯ç¤ºä¸»ç•«é¢
                currentUser = user; 
                window.currentUser = user; 
                currentViewUid = user.uid;
                
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden'); // ç¢ºä¿ä¸»ç•«é¢é¡¯ç¤º

                await ensureUserHasId(user); 
                listenToUserProfile(user.uid);
                await loadCustomCategories(user);
                loadDataRealtime(user.uid); window.loadFriends(true); updateViewMode(); await checkDailyBonus(user.uid); initMoodSystem();
                setTimeout(() => triggerShibaReaction("æ­¡è¿å›ä¾†ï¼Œä¸»äººï¼æ±ªï¼"), 1500);
            } else {
                // æœªç™»å…¥ï¼šé¡¯ç¤ºç™»å…¥ç•«é¢
                currentUser = null;
                appScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden'); // ç¢ºä¿ç™»å…¥ç•«é¢é¡¯ç¤º
                
                if(unsubscribe) unsubscribe();
                if(userProfileUnsubscribe) userProfileUnsubscribe();
            }
        });

        // --- ä»¥ä¸‹ç‚ºå…¶ä»–æ—¢æœ‰ç¨‹å¼ç¢¼ ---
        
        window.toggleMusic = () => { const bgMusic = document.getElementById('bg-music'); const btn = document.getElementById('music-btn'); if(!audioCtx) window.initAudio(); if (isMusicPlaying) { bgMusic.pause(); btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); isMusicPlaying = false; } else { bgMusic.play().then(() => { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); isMusicPlaying = true; }); } };
        window.toggleSettingsModal = () => document.getElementById('settings-modal').classList.toggle('hidden');
        window.updateBGMVolume = (val) => { globalBGMVolume = parseFloat(val); if(bgmGainNode) bgmGainNode.gain.value = globalBGMVolume; document.getElementById('bgm-val-display').innerText = Math.round(globalBGMVolume * 100) + '%'; const btn = document.getElementById('music-btn'); if(globalBGMVolume === 0) { btn.innerText = "ğŸ”‡"; btn.classList.remove('music-playing'); } else if(isMusicPlaying) { btn.innerText = "ğŸµ"; btn.classList.add('music-playing'); } };
        window.updateSFXVolume = (val) => { globalSFXVolume = parseFloat(val); document.getElementById('sfx-val-display').innerText = Math.round(globalSFXVolume * 100) + '%'; playPop(); };
        document.addEventListener('click', (e) => { if((e.target.closest('button') || e.target.closest('.cursor-pointer')) && e.target.type !== 'range') { playPop(); } });
        
        // ğŸ”¥ åŠ ä¸Š id="btn-start-app" ç›£è½ï¼Œä»¥é˜² onclick å±¬æ€§å¤±æ•ˆ
        document.getElementById('btn-start-app').addEventListener('click', window.startApp);

        const inputPanel = document.getElementById('input-panel'); 
        let panelStartY = 0; let isDragging = false; 
        
        inputPanel.addEventListener('touchstart', (e) => { 
            if(e.target.closest('#modal-handle-area')) { 
                panelStartY = e.touches[0].clientY; 
                isDragging = false; 
            } else {
                panelStartY = -1;
            }
        }, {passive: true}); 
        
        inputPanel.addEventListener('touchmove', (e) => { 
            if(panelStartY === -1) return; 
            
            const diff = e.touches[0].clientY - panelStartY; 
            if(diff > 0) { 
                if(e.cancelable) e.preventDefault(); 
                isDragging = true; 
                inputPanel.style.transform = `translateY(${diff}px)`; 
                inputPanel.style.transition = 'none'; 
            } 
        }, {passive: false}); 
        
        inputPanel.addEventListener('touchend', (e) => { 
            if(!isDragging || panelStartY === -1) return; 
            
            if((e.changedTouches[0].clientY - panelStartY) > 100) {
                closeInputModal(); 
            } else { 
                inputPanel.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; 
                inputPanel.style.transform = ''; 
            } 
            isDragging = false; 
        });
        
        const friendPanel = document.getElementById('friend-panel'); let friendStartX = 0; let friendStartY = 0; let isFriendClosing = false; let isScrollingList = false; 
        friendPanel.addEventListener('touchstart', (e) => { friendStartX = e.touches[0].clientX; friendStartY = e.touches[0].clientY; isFriendClosing = false; isScrollingList = false; friendPanel.style.transition = 'none'; }, {passive: true}); 
        friendPanel.addEventListener('touchmove', (e) => { if (isScrollingList) return; const currentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const xDiff = currentX - friendStartX; const yDiff = currentY - friendStartY; if (isFriendClosing || (xDiff < -10 && Math.abs(xDiff) > Math.abs(yDiff))) { if (e.cancelable) e.preventDefault(); isFriendClosing = true; friendPanel.style.transform = `translateX(${xDiff}px)`; } else if (Math.abs(yDiff) > Math.abs(xDiff)) { isScrollingList = true; } }, {passive: false}); 
        friendPanel.addEventListener('touchend', (e) => { if (isFriendClosing) { const xDiff = e.changedTouches[0].clientX - friendStartX; if (xDiff < -100) toggleFriendModal(); else { friendPanel.style.transition = 'transform 0.3s ease-out'; friendPanel.style.transform = ''; } } isFriendClosing = false; isScrollingList = false; });
        
        const storePanel = document.getElementById('store-panel'); let storeStartX = 0; let storeStartY = 0; let isStoreClosing = false; let isStoreScrolling = false; 
        storePanel.addEventListener('touchstart', (e) => { storeStartX = e.touches[0].clientX; storeStartY = e.touches[0].clientY; isStoreClosing = false; isStoreScrolling = false; storePanel.style.transition = 'none'; }, {passive: true}); 
        storePanel.addEventListener('touchmove', (e) => { if (isStoreScrolling) return; const currentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const xDiff = currentX - storeStartX; const yDiff = currentY - storeStartY; if (isStoreClosing || (xDiff > 10 && Math.abs(xDiff) > Math.abs(yDiff))) { if (e.cancelable) e.preventDefault(); isStoreClosing = true; storePanel.style.transform = `translateX(${xDiff}px)`; } else if (Math.abs(yDiff) > Math.abs(xDiff)) { isStoreScrolling = true; } }, {passive: false}); 
        storePanel.addEventListener('touchend', (e) => { if (isStoreClosing) { const xDiff = e.changedTouches[0].clientX - storeStartX; if (xDiff > 100) toggleStoreModal(); else { storePanel.style.transition = 'transform 0.3s ease-out'; storePanel.style.transform = ''; } } isStoreClosing = false; isStoreScrolling = false; });
        
        let globalStartX = 0; let globalStartY = 0; 
        document.addEventListener('touchstart', e => { globalStartX = e.changedTouches[0].screenX; globalStartY = e.changedTouches[0].screenY; }, false); 
        document.addEventListener('touchend', e => { 
            let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; let xDiff = touchEndX - globalStartX; let yDiff = touchEndY - globalStartY; 
            if (Math.abs(xDiff) > Math.abs(yDiff) && Math.abs(xDiff) > 50) { 
                if(document.getElementById('friend-modal').classList.contains('hidden') && document.getElementById('store-modal').classList.contains('hidden') && document.getElementById('input-modal').classList.contains('hidden')) { 
                    // if (xDiff > 0) toggleFriendModal(); 
                } 
            } 
        }, false);

        const lockScroll = () => document.body.style.overflow = 'hidden'; const unlockScroll = () => document.body.style.overflow = '';
        let currentUser=null, currentViewUid=null, transactions=[], unsubscribe=null, currentDetailId=null, friendUnsubscribe=null;
        let myShortId=null, myProfileData=null, editingId=null, currentPhotoData=null, currentProfilePhotoData=null, myChart=null;
        let shibaMood = 100; let myInventory = {}; 
        let userProfileUnsubscribe = null;

        const defaultCategories = { expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'], income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'] };
        let userCustomCategories = { expense: [], income: [] };
        const categoryIcons = { 'é¤é£²': 'ğŸ”', 'äº¤é€š': 'ğŸš—', 'è³¼ç‰©': 'ğŸ›ï¸', 'å¨›æ¨‚': 'ğŸ®', 'å±…ä½': 'ğŸ ', 'é†«ç™‚': 'ğŸ’Š', 'æ•™è‚²': 'ğŸ“š', 'å…¶ä»–': 'âœ¨', 'è–ªè³‡': 'ğŸ’°', 'çé‡‘': 'ğŸ§§', 'æŠ•è³‡': 'ğŸ“ˆ', 'å…¼è·': 'ğŸ’¼' };

        const inpAmount = document.getElementById('inp-amount'); const inpType = document.getElementById('inp-type'); const inpCategory = document.getElementById('inp-category'); const inpDate = document.getElementById('inp-date'); const inpTitle = document.getElementById('inp-title');
        inpDate.valueAsDate = new Date(); document.getElementById('filter-month').value = new Date().toISOString().slice(0, 7);

        document.getElementById('btn-google-login').addEventListener('click', () => { signInWithPopup(auth, provider).catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message)); });
        window.logout = () => { if(confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) signOut(auth); };

        function listenToUserProfile(uid) {
            if (userProfileUnsubscribe) userProfileUnsubscribe();
            const userRef = doc(db, "users", uid);
            
            userProfileUnsubscribe = onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    myProfileData = { ...myProfileData, ...data };
                    if (document.getElementById('store-coin-count')) {
                        document.getElementById('store-coin-count').innerText = myProfileData.boneCoins || 0;
                    }
                    applyInventoryEffects();
                    if (data.mood !== undefined) {
                        shibaMood = data.mood;
                        updateMoodUI();
                    }
                }
            });
        }

        window.initMoodSystem = () => {
            const now = Date.now(); const lastUpdate = myProfileData.lastMoodUpdate || now; const hoursPassed = Math.floor((now - lastUpdate) / 3600000);
            if(hoursPassed > 0) { const deduct = hoursPassed * 5; shibaMood = Math.max(0, (myProfileData.mood || 100) - deduct); updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, lastMoodUpdate: now }); } else { shibaMood = myProfileData.mood || 100; }
            updateMoodUI();
            setInterval(() => { const currentNow = Date.now(); const last = myProfileData.lastMoodUpdate || currentNow; if (currentNow - last >= 3600000) { shibaMood = Math.max(0, shibaMood - 5); updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, lastMoodUpdate: currentNow }); updateMoodUI(); } }, 60000);
        };
        window.updateMoodUI = () => { const bar = document.getElementById('mood-bar'); bar.style.width = `${shibaMood}%`; if(shibaMood <= 20) bar.style.backgroundColor = '#9D4EDD'; else if(shibaMood <= 50) bar.style.backgroundColor = '#48CAE4'; else bar.style.backgroundColor = '#FF7096'; };
        
        window.applyInventoryEffects = () => { 
            myInventory = myProfileData.inventory || {}; 
            
            const hatEl = document.getElementById('shiba-hat-gentleman');
            const capEl = document.getElementById('shiba-hat-cap');
            const crownEl = document.getElementById('shiba-hat-crown');
            
            // é‡ç½®æ‰€æœ‰å¸½å­é¡¯ç¤º
            hatEl.classList.add('hidden');
            capEl.classList.add('hidden');
            crownEl.classList.add('hidden');

            // ğŸ”¥ å„ªå…ˆé¡¯ç¤ºæœ€é«˜ç´šçš„è£é£¾ (çš‡å†  > é´¨èˆŒå¸½ > ç´³å£«å¸½)
            if(myInventory.crown) {
                crownEl.classList.remove('hidden');
            } else if (myInventory.cap) {
                capEl.classList.remove('hidden');
            } else if (myInventory.hat) {
                hatEl.classList.remove('hidden');
            }
            
            // æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹ (å³ä½¿å·²ç¶“ç©¿æˆ´ï¼Œä¹Ÿæ›´æ–°æ‰€æœ‰æŒ‰éˆ•ç‚ºé€€è²¨ç‹€æ…‹)
            updateStoreButtons();
        };
        
        window.toggleStoreModal = async () => { 
            const modal = document.getElementById('store-modal'); const panel = document.getElementById('store-panel');
            const isHidden = modal.classList.contains('hidden'); 
            if (isHidden) { 
                if(myProfileData) {
                    document.getElementById('store-coin-count').innerText = myProfileData.boneCoins || 0; 
                    updateStoreButtons(); 
                }
                modal.classList.remove('hidden'); lockScroll();
            } else { modal.classList.add('hidden'); panel.style.transform = ''; unlockScroll(); } 
        };

        function updateStoreButtons() { 
            const inv = myProfileData.inventory || {}; const today = new Date().toDateString(); const lastMeat = myProfileData.lastMeatDate; 
            
            // è‚‰ç½é ­ (ä¸å¯é€€è²¨)
            const meatBtn = document.getElementById('btn-buy-meat'); 
            if(lastMeat === today) { meatBtn.classList.add('sold-out'); meatBtn.innerText = "ä»Šæ—¥å·²é”ä¸Šé™"; meatBtn.disabled = true; } 
            else { meatBtn.classList.remove('sold-out'); meatBtn.innerText = "50 ğŸ¦´ è³¼è²·"; meatBtn.disabled = false; } 
            
            // ç´³å£«å¸½
            const hatBtn = document.getElementById('btn-buy-hat');
            if(inv.hat) { 
                hatBtn.classList.remove('sold-out'); 
                hatBtn.innerText = "é€€è²¨ (+200 ğŸ¦´)"; 
                hatBtn.onclick = () => refundItem(200, 'hat');
                hatBtn.className = "w-full bg-white border-2 border-red-200 text-red-500 py-1.5 rounded-lg text-xs font-bold hover:bg-red-50 transition";
            } else { 
                hatBtn.classList.remove('sold-out'); 
                hatBtn.innerText = "200 ğŸ¦´ è³¼è²·"; 
                hatBtn.disabled = false; 
                hatBtn.onclick = () => buyItem(200, 'hat');
                hatBtn.className = "w-full bg-[#2A9D8F] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-[#264653] transition";
            }
            
            // é´¨èˆŒå¸½
            const capBtn = document.getElementById('btn-buy-cap');
            if(inv.cap) { 
                capBtn.classList.remove('sold-out'); 
                capBtn.innerText = "é€€è²¨ (+500 ğŸ¦´)"; 
                capBtn.onclick = () => refundItem(500, 'cap');
                capBtn.className = "w-full bg-white border-2 border-red-200 text-red-500 py-1.5 rounded-lg text-xs font-bold hover:bg-red-50 transition";
            } else { 
                capBtn.classList.remove('sold-out'); 
                capBtn.innerText = "500 ğŸ¦´ è³¼è²·"; 
                capBtn.disabled = false; 
                capBtn.onclick = () => buyItem(500, 'cap');
                capBtn.className = "w-full bg-[#4A3B32] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-black transition";
            }
            
            // çš‡å† 
            const crownBtn = document.getElementById('btn-buy-crown');
            if(inv.crown) { 
                crownBtn.classList.remove('sold-out'); 
                crownBtn.innerText = "é€€è²¨ (+1000 ğŸ¦´)"; 
                crownBtn.onclick = () => refundItem(1000, 'crown');
                crownBtn.className = "w-full bg-white border-2 border-red-200 text-red-500 py-1.5 rounded-lg text-xs font-bold hover:bg-red-50 transition";
            } else { 
                crownBtn.classList.remove('sold-out'); 
                crownBtn.innerText = "1000 ğŸ¦´ è³¼è²·"; 
                crownBtn.disabled = false; 
                crownBtn.onclick = () => buyItem(1000, 'crown');
                crownBtn.className = "w-full bg-[#E76F51] text-white py-1.5 rounded-lg text-xs font-bold hover:bg-red-600 transition";
            }
        }

        window.buyItem = async (price, itemType) => {
            if (!myProfileData.inventory) myProfileData.inventory = {}; 
            if (itemType !== 'meat' && myProfileData.inventory[itemType]) return alert('å·²ç¶“æ“æœ‰æ­¤ç‰©å“å›‰ï¼');
            if (itemType === 'meat' && myProfileData.lastMeatDate === new Date().toDateString()) return alert('ä»Šå¤©å·²ç¶“åƒéå¤§é¤äº†ï¼');

            if ((myProfileData.boneCoins || 0) < price) return triggerShibaReaction("éª¨é ­å¹£ä¸å¤ å•¦ï¼å¿«å»è¨˜å¸³ï¼(æ°£)");
            
            let confirmMsg = `ç¢ºå®šèŠ±è²» ${price} éª¨é ­å¹£è³¼è²·å—ï¼Ÿ`;
            if(itemType === 'meat') confirmMsg += "\n(å¿ƒæƒ…å°‡æ¢å¾©è‡³ 100)";
            
            if(!confirm(confirmMsg)) return;

            const userRef = doc(db, "users", currentUser.uid);
            let updates = { boneCoins: increment(-price) };
            let msg = "è³¼è²·æˆåŠŸï¼";

            if(itemType === 'meat') {
                updates.mood = 100;
                updates.lastMeatDate = new Date().toDateString();
                shibaMood = 100;
                myProfileData.lastMeatDate = updates.lastMeatDate;
                msg = "å¿ƒæƒ…è£œæ»¿äº†ï¼å¥½å¥½åƒï¼(æ±ª!)";
            } else {
                let currentInv = myProfileData.inventory || {};
                let newInv = { ...currentInv, [itemType]: true }; 
                updates.inventory = newInv;
                myProfileData.inventory = newInv;
                
                if(itemType === 'hat') msg = "å¸¶ä¸Šæ–°å¸½å­äº†ï¼å¸¥å—ï¼Ÿ";
                if(itemType === 'cap') msg = "æ›ä¸Šé´¨èˆŒå¸½äº†ï¼å¾ˆæ½®å§ï¼Ÿ";
                if(itemType === 'crown') msg = "æˆ‘æ˜¯æŸ´æŸ´åœ‹ç‹ï¼(æ±ª!)";
            }

            await updateDoc(userRef, updates);
            myProfileData.boneCoins -= price;
            document.getElementById('store-coin-count').innerText = myProfileData.boneCoins;
            
            playCoin(); triggerShibaReaction(msg); 
            applyInventoryEffects(); 
            updateMoodUI(); 
        };

        // ğŸ”¥ æ–°å¢ï¼šé€€è²¨åŠŸèƒ½
        window.refundItem = async (price, itemType) => {
            if(!confirm(`ç¢ºå®šè¦é€€è²¨å—ï¼Ÿ\nå°‡æ”¶å›ç‰©å“ä¸¦é€€é‚„ ${price} éª¨é ­å¹£ã€‚`)) return;

            const userRef = doc(db, "users", currentUser.uid);
            let currentInv = myProfileData.inventory || {};
            
            // ç§»é™¤è©²ç‰©å“
            delete currentInv[itemType];
            
            await updateDoc(userRef, {
                boneCoins: increment(price),
                inventory: currentInv
            });

            myProfileData.boneCoins += price;
            myProfileData.inventory = currentInv;
            
            document.getElementById('store-coin-count').innerText = myProfileData.boneCoins;
            playCoin(); // æ’­æ”¾é‡‘å¹£è²éŸ³ä»£è¡¨é€€æ¬¾
            triggerShibaReaction("é€€è²¨æˆåŠŸï¼éª¨é ­å¹£æ‹¿å›ä¾†äº†ï¼");
            applyInventoryEffects();
        };

        window.closeBonusModal = () => document.getElementById('daily-bonus-modal').classList.add('hidden');
        const shibaEl = document.getElementById('shiba-assistant'); const speechEl = document.getElementById('shiba-speech'); let speechTimeout; const normalMessages = ["æ±ªï¼ä»Šå¤©èŠ±äº†å¤šå°‘éŒ¢ï¼Ÿ", "éª¨é ­å¹£ä¸å¤ ç”¨äº†å—ï¼Ÿ", "æˆ‘æ˜¯ä¸æ˜¯å¾ˆå¯æ„›ï¼ŸğŸ•", "åŠªåŠ›å­˜éŒ¢è²·ç½ç½ï¼", "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼"]; const sadMessages = ["ä¸»äºº...ä½ ä¸æ„›æˆ‘äº†å—ï¼Ÿ(å—š)", "è‚šå­å¥½é¤“...æƒ³åƒç½ç½...", "å¥½ä¹…æ²’æ‘¸æ‘¸æˆ‘äº†...", "æˆ‘å¥½ç„¡èŠ...é™ªæˆ‘ç©...", "æ˜¯ä¸æ˜¯æŠŠæˆ‘å¿˜è¨˜äº†ï¼Ÿ"];
        window.triggerShibaClick = async () => { 
            const containerAnim = document.getElementById('shiba-container-anim');
            playBark(); 
            containerAnim.classList.remove('animate-shiba-float'); 
            void containerAnim.offsetWidth; 
            containerAnim.classList.add('animate-shiba-bounce'); 
            setTimeout(() => { 
                containerAnim.classList.remove('animate-shiba-bounce'); 
                containerAnim.classList.add('animate-shiba-float'); 
            }, 400); 
            
            const today = new Date().toDateString(); if(myProfileData.lastPetDate !== today) { myProfileData.dailyPetCount = 0; myProfileData.lastPetDate = today; }
            let msg = "";
            if((myProfileData.dailyPetCount || 0) < 4) { shibaMood = Math.min(100, shibaMood + 5); myProfileData.dailyPetCount = (myProfileData.dailyPetCount || 0) + 1; await updateDoc(doc(db, "users", currentUser.uid), { mood: shibaMood, dailyPetCount: myProfileData.dailyPetCount, lastPetDate: today }); updateMoodUI(); const heart = document.createElement('div'); heart.classList.add('animate-heart'); heart.innerText = 'â¤ï¸'; heart.style.left = '50%'; heart.style.bottom = '100%'; document.getElementById('shiba-assistant-container').appendChild(heart); setTimeout(() => heart.remove(), 1000); }
            const pool = shibaMood <= 50 ? sadMessages : normalMessages; msg = pool[Math.floor(Math.random() * pool.length)]; showSpeechBubble(msg); 
        };
        function triggerShibaReaction(message) { 
            const containerAnim = document.getElementById('shiba-container-anim');
            containerAnim.classList.remove('animate-shiba-float'); void containerAnim.offsetWidth; containerAnim.classList.add('animate-shiba-bounce'); setTimeout(() => { containerAnim.classList.remove('animate-shiba-bounce'); containerAnim.classList.add('animate-shiba-float'); }, 400); showSpeechBubble(message); 
        }
        function showSpeechBubble(text) { clearTimeout(speechTimeout); speechEl.innerText = text; speechEl.classList.remove('hidden'); speechTimeout = setTimeout(() => { speechEl.classList.add('hidden'); }, 3000); }
        window.toggleFriendModal = () => { const modal = document.getElementById('friend-modal'); const panel = document.getElementById('friend-panel'); const isHidden = modal.classList.contains('hidden'); if (isHidden) { modal.classList.remove('hidden'); lockScroll(); loadFriends(true); } else { modal.classList.add('hidden'); panel.style.transform = ''; unlockScroll(); } };
        
        window.loadFriends = (force = false) => {
            if (!currentUser) return;
            if (friendUnsubscribe && !force) return;
            if (friendUnsubscribe) friendUnsubscribe();
            
            const el = document.getElementById('friend-list-container');
            el.innerHTML = ''; 
            
            const me = document.createElement('div');
            me.className = `p-4 rounded-2xl flex items-center gap-3 cursor-pointer ${currentViewUid===currentUser.uid ? 'bg-[#FFF0D4] border-2 border-[#F4A261]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`;
            const myPhoto = myProfileData?.photo || DEFAULT_AVATAR;
            me.innerHTML = `<img src="${myPhoto}" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div class="font-bold text-[#4A3B32]">æˆ‘çš„ç›¸ç°¿</div>`;
            me.onclick = () => { switchView(currentUser.uid, 'æˆ‘çš„å¸³æœ¬'); toggleFriendModal(); };
            el.appendChild(me);

            const q = query(collection(db, "users", currentUser.uid, "friends"));
            friendUnsubscribe = onSnapshot(q, (snapshot) => {
                while(el.children.length > 1) { el.removeChild(el.lastChild); }
                snapshot.forEach(doc => {
                    try {
                        const f = doc.data();
                        const div = document.createElement('div');
                        div.className = `p-4 rounded-2xl flex items-center justify-between cursor-pointer mt-2 ${currentViewUid===f.uid ? 'bg-[#E1F5FE] border-2 border-[#81D4FA]' : 'bg-white hover:bg-[#FFF8E1] border-2 border-[#FFE8D6]'}`;
                        const fName = f.name || "ç¥ç§˜æŸ´å‹"; const fPhoto = f.photo || DEFAULT_AVATAR; const fId = f.shortId || "???";
                        
                        div.innerHTML = `<div class="flex items-center gap-3 flex-1"><img src="${fPhoto}" class="w-10 h-10 rounded-full bg-white object-cover border border-[#FFE8D6]"><div><div class="font-bold text-sm text-[#4A3B32]">${fName}</div><div class="text-xs text-[#8D6E63]">ID: ${fId}</div></div></div><button id="del-btn-${f.uid}" class="text-[#8D6E63] hover:text-[#E76F51] p-2">Ã—</button>`;
                        
                        div.onclick = (e) => { 
                            if(e.target.id !== `del-btn-${f.uid}`) openUserProfile(f.uid); 
                        };
                        setTimeout(() => {
                            document.getElementById(`del-btn-${f.uid}`).onclick = (e) => {
                                e.stopPropagation();
                                deleteFriend(f.uid);
                            };
                        }, 0);
                        el.appendChild(div);
                    } catch(e) { console.error(e); }
                });
            }, (error) => {
                const errDiv = document.createElement('div');
                errDiv.innerText = "è®€å–å¤±æ•—";
                errDiv.className = "text-center text-red-400 mt-4 text-xs";
                el.appendChild(errDiv);
            });
        };

        window.updateUI = () => { const listEl = document.getElementById('transaction-list'); const mode = document.getElementById('filter-type').value; const filterDate = mode === 'day' ? document.getElementById('filter-day').value : mode === 'month' ? document.getElementById('filter-month').value : document.getElementById('filter-year').value; const filtered = transactions.filter(t => { const d = new Date(t.dateTimestamp); const iso = d.toISOString().split('T')[0]; if(mode==='day') return iso===filterDate; if(mode==='month') return iso.slice(0,7)===filterDate; if(mode==='year') return String(d.getFullYear())===filterDate; return true; }); listEl.innerHTML = ''; let inc=0, exp=0, expData={}; if(filtered.length===0) document.getElementById('empty-state').classList.remove('hidden'); else document.getElementById('empty-state').classList.add('hidden'); filtered.forEach(t => { if(t.type==='income') inc+=Number(t.amount); else { exp+=Number(t.amount); expData[t.category]=(expData[t.category]||0)+Number(t.amount); } const div = document.createElement('div'); div.className = "aspect-square rounded-2xl overflow-hidden relative cursor-pointer border-2 border-white shadow-sm hover:scale-95 transition bg-white"; if(t.photo) { div.innerHTML = `<img src="${t.photo}" class="w-full h-full object-cover">`; } else { const isInc = t.type==='income'; const colorClass = isInc ? 'bg-[#E0F2F1] text-[#2A9D8F]' : 'bg-[#FFEBEE] text-[#E76F51]'; const icon = categoryIcons[t.category] || 'âœ¨'; div.innerHTML = `<div class="w-full h-full ${colorClass} flex flex-col items-center justify-center p-2 text-center"><span class="text-4xl mb-1 filter drop-shadow-sm">${icon}</span><span class="text-[10px] font-black truncate w-full">${t.category}</span><span class="text-[10px] font-bold mt-0.5 opacity-80">$${t.amount}</span></div>`; } if(t.photo) { div.innerHTML += `<div class="absolute bottom-0 right-0 bg-[#4A3B32]/60 backdrop-blur-sm text-white text-[10px] font-bold px-2 py-0.5 rounded-tl-lg border-t border-l border-white/20">$${t.amount}</div>`; } div.onclick = () => openDetailModal(t.id); listEl.appendChild(div); }); document.getElementById('display-balance').innerText=(inc-exp).toLocaleString(); document.getElementById('display-income').innerText=inc.toLocaleString(); document.getElementById('display-expense').innerText=exp.toLocaleString(); renderChart(expData); };
        
        window.openInputModal = () => { 
            if(!editingId) window.resetForm(); 
            
            const modal = document.getElementById('input-modal');
            const panel = document.getElementById('input-panel');
            
            // å¼·åˆ¶é‡ç½® transformï¼Œé˜²æ­¢å› ç‚ºä¸Šæ¬¡æ‹–æ›³è€Œå¡ä½
            panel.style.transform = '';
            panel.style.transition = '';
            
            modal.classList.remove('hidden'); 
            lockScroll(); 
        };
        
        window.closeInputModal = () => { document.getElementById('input-modal').classList.add('hidden'); document.getElementById('input-panel').style.transform = ''; unlockScroll(); setTimeout(() => window.resetForm(), 300); };
        window.triggerSubmit = () => { document.getElementById('transaction-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true})); };
        window.resetForm = () => { editingId = null; document.getElementById('form-title').innerText = "è¨˜ä¸€ç­†"; inpAmount.value = ''; inpTitle.value = ''; inpDate.valueAsDate = new Date(); window.clearPhoto(); };
        window.editTransaction = (id) => { const tx = transactions.find(t => t.id === id); if (!tx) return; editingId = id; inpTitle.value = tx.title; inpAmount.value = tx.amount; inpType.value = tx.type; updateCategoryOptions(); inpCategory.value = tx.category; inpDate.valueAsDate = new Date(tx.dateTimestamp); currentPhotoData = tx.photo || null; if (currentPhotoData) { document.getElementById('img-preview').src = currentPhotoData; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); } else window.clearPhoto(); document.getElementById('form-title').innerText = "ç·¨è¼¯"; window.openInputModal(); };
        document.getElementById('transaction-form').addEventListener('submit', async (e) => { e.preventDefault(); if(currentViewUid !== currentUser.uid) return alert("åªèƒ½ç·¨è¼¯è‡ªå·±çš„å¸³æœ¬å–”"); const amount = Number(inpAmount.value); if(amount <= 0) return alert("é‡‘é¡éŒ¯èª¤"); const data = { amount, type: inpType.value, category: inpCategory.value, title: inpTitle.value.trim() || inpCategory.value, dateTimestamp: inpDate.valueAsDate.getTime(), date: inpDate.valueAsDate.toLocaleDateString(), photo: currentPhotoData }; try { if(editingId) { await updateDoc(doc(db, "users", currentUser.uid, "transactions", editingId), data); } else { await addDoc(collection(db, "users", currentUser.uid, "transactions"), data); await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: increment(10) }); myProfileData.boneCoins += 10; triggerShibaReaction("è¨˜å¸³æˆåŠŸï¼éª¨é ­å¹£ +10ï¼(é–‹å¿ƒ)"); playCoin(); } window.closeInputModal(); } catch(e) { alert("éŒ¯èª¤: " + e.message); } });
        window.deleteTransactionCloud = async (id) => { await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id)); };
        
        window.changeFilterMode = () => { const mode = document.getElementById('filter-type').value; document.getElementById('filter-day').classList.add('hidden'); document.getElementById('filter-month').classList.add('hidden'); document.getElementById('filter-year').classList.add('hidden'); if(mode === 'day') document.getElementById('filter-day').classList.remove('hidden'); if(mode === 'month') document.getElementById('filter-month').classList.remove('hidden'); if(mode === 'year') document.getElementById('filter-year').classList.remove('hidden'); updateUI(); }
        async function loadCustomCategories(user) { const s = await getDoc(doc(db, "users", user.uid)); if(s.exists() && s.data().customCategories) userCustomCategories = s.data().customCategories; updateCategoryOptions(); }
        window.updateCategoryOptions = () => { const type = inpType.value; const cats = [...defaultCategories[type], ...(userCustomCategories[type]||[])]; inpCategory.innerHTML = cats.map(c => { const icon = categoryIcons[c] || 'âœ¨'; return `<option value="${c}">${icon} ${c}</option>`; }).join(''); }
        window.addCustomCategory = async () => { const n = prompt("æ–°åˆ†é¡åç¨±:"); if(n) { const t = inpType.value; if(!userCustomCategories[t]) userCustomCategories[t] = []; userCustomCategories[t].push(n); await setDoc(doc(db, "users", currentUser.uid), {customCategories: userCustomCategories}, {merge:true}); updateCategoryOptions(); inpCategory.value = n; } }
        document.getElementById('filter-day').addEventListener('input', updateUI); document.getElementById('filter-month').addEventListener('input', updateUI); document.getElementById('filter-year').addEventListener('change', updateUI);
        
        Chart.register(ChartDataLabels);
        function renderChart(data) { const ctx = document.getElementById('expenseChart').getContext('2d'); const legendContainer = document.getElementById('chart-legend'); const lbs = Object.keys(data); const vals = Object.values(data); if(myChart) myChart.destroy(); if(lbs.length === 0) { document.getElementById('chart-placeholder').classList.remove('hidden'); legendContainer.innerHTML = ''; return; } document.getElementById('chart-placeholder').classList.add('hidden'); const colors = ['#F4A261','#E76F51','#E9C46A','#2A9D8F','#264653','#8D6E63','#F4D35E','#DA627D']; myChart = new Chart(ctx, { type: 'doughnut', data: { labels: lbs, datasets: [{ data: vals, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } } } }); const total = vals.reduce((a, b) => a + b, 0); legendContainer.innerHTML = lbs.map((label, i) => { const val = vals[i]; const percent = Math.round((val / total) * 100); const color = colors[i % colors.length]; const icon = categoryIcons[label] || 'âœ¨'; return `<div class="flex items-center justify-between"><div class="flex items-center gap-1.5 min-w-0"><div class="w-2.5 h-2.5 rounded-full shrink-0" style="background-color: ${color}"></div><span class="truncate font-bold text-[#4A3B32]">${icon} ${label}</span></div><div class="text-[#8D6E63] font-mono shrink-0">${percent}%</div></div>`; }).join(''); }

        window.toggleChart = () => { document.getElementById('chart-container').classList.toggle('hidden'); }
        window.toggleFriendModal = () => document.getElementById('friend-modal').classList.toggle('hidden');
        window.toggleProfileModal = () => document.getElementById('profile-modal').classList.toggle('hidden');
        window.handlePhotoSelect = (e) => processImage(e.target.files[0], (data) => { currentPhotoData = data; document.getElementById('img-preview').src = data; document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('btn-camera').classList.add('hidden'); });
        window.handleProfilePhotoSelect = (e) => processImage(e.target.files[0], (data) => { currentProfilePhotoData = data; document.getElementById('profile-avatar').src = data; });
        function processImage(file, cb) { if(!file) return; const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); const scale = 600/i.width; c.width = 600; c.height = i.height*scale; c.getContext('2d').drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/jpeg', 0.6)); }; i.src = e.target.result; }; r.readAsDataURL(file); }
        window.clearPhoto = () => { document.getElementById('inp-photo').value=''; currentPhotoData=null; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('btn-camera').classList.remove('hidden'); };
        
        window.openUserProfile = async (uid) => {
            const isMe = (uid === currentUser.uid);
            const avatarEl = document.getElementById('profile-avatar');
            const nameInp = document.getElementById('profile-name-input');
            const nameDisplay = document.getElementById('profile-name-display');
            const cameraBtn = document.getElementById('profile-camera-btn');
            const myActions = document.getElementById('profile-actions');
            const friendActions = document.getElementById('profile-friend-actions');
            const idDisplay = document.getElementById('profile-short-id');
            const emailDisplay = document.getElementById('profile-email');

            toggleProfileModal();

            if (isMe) {
                avatarEl.src = myProfileData.photo || DEFAULT_AVATAR;
                currentProfilePhotoData = myProfileData.photo; 
                nameInp.value = myProfileData.name;
                idDisplay.innerText = myProfileData.shortId;
                emailDisplay.innerText = myProfileData.email;

                nameInp.classList.remove('hidden');
                nameDisplay.classList.add('hidden');
                cameraBtn.classList.remove('hidden');
                myActions.classList.remove('hidden');
                friendActions.classList.add('hidden');
                
                avatarEl.classList.add('cursor-pointer');
                avatarEl.onclick = () => document.getElementById('inp-profile-photo').click();
                
            } else {
                avatarEl.src = DEFAULT_AVATAR; 
                nameDisplay.innerText = "è¼‰å…¥ä¸­...";
                
                nameInp.classList.add('hidden');
                nameDisplay.classList.remove('hidden');
                cameraBtn.classList.add('hidden');
                myActions.classList.add('hidden');
                friendActions.classList.remove('hidden');
                
                avatarEl.classList.remove('cursor-pointer');
                avatarEl.onclick = null;
                
                document.getElementById('btn-view-ledger').onclick = () => {
                    switchView(uid, nameDisplay.innerText);
                    toggleProfileModal();
                    document.getElementById('friend-modal').classList.add('hidden');
                    document.getElementById('friend-panel').style.transform = '';
                };

                try {
                    const snap = await getDoc(doc(db, "users", uid));
                    if(snap.exists()) {
                        const d = snap.data();
                        avatarEl.src = d.photo || DEFAULT_AVATAR;
                        nameDisplay.innerText = d.name || "ç¥ç§˜æŸ´å‹";
                        idDisplay.innerText = d.shortId || "???";
                        emailDisplay.innerText = ""; 
                    }
                } catch(e) {
                    console.error(e);
                    nameDisplay.innerText = "è®€å–å¤±æ•—";
                }
            }
        };

        window.saveProfile = async () => { 
            const newName = document.getElementById('profile-name-input').value.trim();
            if(!newName) return alert("åç¨±ä¸èƒ½ç‚ºç©º");
            
            await updateDoc(doc(db,"users",currentUser.uid), {
                name: newName, 
                photo: currentProfilePhotoData || myProfileData.photo
            }); 
            
            myProfileData.name = newName;
            myProfileData.photo = currentProfilePhotoData;
            
            alert('å·²å„²å­˜è®Šæ›´ï¼'); 
            window.toggleProfileModal(); 
            ensureUserHasId(currentUser); 
        };
        
        window.setMoney = async (amount) => { if (!currentUser) return alert("è«‹å…ˆç™»å…¥"); try { await updateDoc(doc(db, "users", currentUser.uid), { boneCoins: Number(amount) }); if(myProfileData) myProfileData.boneCoins = Number(amount); const storeCountEl = document.getElementById('store-coin-count'); if(storeCountEl) storeCountEl.innerText = amount; alert(`ğŸ¶ æ¸¬è©¦æ¨¡å¼ï¼šéª¨é ­å¹£å·²ä¿®æ”¹ç‚º ${amount}`); } catch (e) { console.error(e); alert("ä¿®æ”¹å¤±æ•—"); } };
        window.switchView = (uid, name) => { 
            currentViewUid = uid; 
            document.getElementById('header-title').innerText = uid===currentUser.uid ? 'æˆ‘çš„ç›¸ç°¿' : `${name} çš„ç›¸ç°¿`;
            updateViewMode(); 
            loadDataRealtime(uid); 
            document.getElementById('friend-modal').classList.add('hidden'); 
        }
        function updateViewMode() { const isMe = currentViewUid === currentUser.uid; document.getElementById('fab-btn').classList.toggle('hidden', !isMe); }
    </script>
</body>
</html>
